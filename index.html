<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>跨平台支出記帳本 (自定義版)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide icons (用於圖示) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 自定義 Tailwind 配置 */
        :root {
            --color-primary: #10b981; /* Emerald 500 */
        }
        /* 使用 Inter 字體 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Calculator Button Style */
        .calc-btn {
            @apply p-4 text-2xl font-bold rounded-xl shadow-md transition duration-150 ease-in-out transform hover:scale-[1.05] active:scale-95;
            min-height: 4rem; /* 確保按鍵夠大適合手機 */
        }
        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* 交易列表顯示調整 */
        .transaction-grid {
            display: grid;
            grid-template-areas:
                "date amount"
                "category desc";
            grid-template-columns: 1fr auto;
            align-items: center;
        }
        .tx-date { grid-area: date; font-size: 0.75rem; color: #6b7280; } /* text-xs text-gray-500 */
        .tx-amount { grid-area: amount; font-weight: bold; font-size: 1.125rem; color: #1f2937; /* dark gray */ }
        .tx-category { grid-area: category; font-weight: 600; font-size: 0.875rem; margin-top: 4px; } /* text-sm */
        .tx-description { grid-area: desc; font-size: 0.875rem; color: #4b5563; margin-top: 4px; } /* text-sm */
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6 md:p-10">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-emerald-500"></div>
            <p class="mt-4 text-lg text-gray-700">正在初始化服務與載入資料...</p>
        </div>
    </div>

    <!-- 登入/註冊區塊 -->
    <div id="auth-section" class="max-w-md mx-auto bg-white shadow-xl rounded-2xl p-6 sm:p-8 mt-12 hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
            Email 登入/註冊
        </h2>
        <form id="auth-form">
            <div class="mb-4">
                <label for="auth-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" id="auth-email" placeholder="您的電子郵件" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
            </div>
            <div class="mb-6">
                <label for="auth-password" class="block text-sm font-medium text-gray-700 mb-1">密碼 (至少 6 位元)</label>
                <input type="password" id="auth-password" placeholder="設定您的密碼" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
            </div>
            
            <div class="flex space-x-4">
                <button type="button" id="login-btn"
                        class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-xl shadow-md transition duration-300 ease-in-out transform hover:scale-[1.01]">
                    登入
                </button>
                <button type="button" id="signup-btn"
                        class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 rounded-xl shadow-md transition duration-300 ease-in-out transform hover:scale-[1.01]">
                    註冊並登入
                </button>
            </div>
        </form>
    </div>

    <!-- 應用程式主區塊 -->
    <div id="app-container" class="hidden max-w-lg mx-auto bg-white shadow-xl rounded-2xl p-6 sm:p-8">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                    <i data-lucide="wallet" class="w-8 h-8 text-emerald-500 mr-2"></i>
                    每月支出管理
                </h1>
                <p id="user-email-display" class="text-sm text-gray-500 mt-1 break-all"></p>
            </div>
            <div class="flex space-x-2">
                 <!-- 設定按鈕 -->
                 <button id="settings-btn" class="flex items-center text-sm text-gray-500 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition duration-150">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
                <!-- 登出按鈕 -->
                <button id="signout-btn" class="flex items-center text-sm text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition duration-150">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </button>
            </div>
        </header>

        <!-- 總餘額區塊 (顯示當月總支出) -->
        <div class="bg-gray-100 p-6 rounded-xl mb-8 shadow-inner">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">當月總支出</h2>
            <p id="total-expense" class="text-4xl font-extrabold text-gray-800">NT$ 0.00</p>
            <p class="text-xs text-gray-500 mt-2">（此金額為本月所有支出總和）</p>
        </div>

        <!-- 新增交易表單 -->
        <section class="mb-8 p-6 border border-gray-200 rounded-xl bg-gray-50">
            <h2 id="form-title" class="text-xl font-bold text-gray-800 mb-4">新增支出紀錄</h2>
            <form id="transaction-form">
                <!-- Hidden field for editing -->
                <input type="hidden" id="transaction-id" value=""> 

                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">描述/備註</label>
                    <input type="text" id="description" placeholder="例如：星巴克咖啡、週末購物" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition duration-150">
                </div>
                
                <div class="mb-4">
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-1">支出分類</label>
                    <select id="category" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition duration-150 bg-white">
                        <option value="">請選擇分類</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="payment-method" class="block text-sm font-medium text-gray-700 mb-1">支付工具</label>
                    <select id="payment-method" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition duration-150 bg-white">
                        <option value="">請選擇支付工具</option>
                    </select>
                </div>

                <div class="mb-6">
                    <label for="amount-display" class="block text-sm font-medium text-gray-700 mb-1">金額 (請按此輸入)</label>
                    <div id="amount-input-group" class="relative">
                        <input type="text" id="amount-display" value="0" readonly required
                               class="w-full px-4 py-2 pr-12 text-2xl font-bold text-gray-800 border border-gray-300 rounded-lg bg-white cursor-pointer focus:ring-emerald-500 focus:border-emerald-500 transition duration-150">
                        <button type="button" id="open-calculator-btn" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-gray-700">
                            <i data-lucide="calculator" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <input type="hidden" id="amount-value" value="0">
                </div>
                
                <button type="submit" id="submit-btn"
                        class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 rounded-xl shadow-md transition duration-300 ease-in-out transform hover:scale-[1.01]">
                    儲存紀錄
                </button>
            </form>
        </section>

        <!-- 交易記錄列表 -->
        <section>
            <h2 class="text-xl font-bold text-gray-800 mb-4">交易記錄 (本月)</h2>
            <div id="transactions-list" class="space-y-3">
                <!-- 交易項目將會在這裡動態插入 -->
                <p id="empty-state" class="text-center text-gray-500 p-4 border border-dashed rounded-lg">尚無交易記錄。</p>
            </div>
        </section>
        
        <!-- 訊息彈窗 (showMessage) -->
        <div id="message-box" class="fixed bottom-4 right-4 text-white p-3 rounded-xl shadow-xl hidden transition-opacity duration-300 z-50"></div>

        <!-- 預算提醒彈窗 (Budget Alert Modal) -->
        <div id="budget-alert-modal" class="fixed inset-0 modal-backdrop hidden flex items-center justify-center z-40 p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all duration-300 scale-100">
                <div class="flex items-center mb-4">
                    <i data-lucide="bell-ring" id="alert-icon" class="w-8 h-8 text-red-500 mr-3"></i>
                    <h3 id="alert-title" class="text-xl font-bold text-gray-800">預算警報！</h3>
                </div>
                <p id="alert-message" class="text-gray-700 mb-6"></p>
                <button id="close-alert-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-xl transition duration-150">確認</button>
            </div>
        </div>
    </div>

    <!-- 計算機模態視窗 (Calculator Modal) -->
    <div id="calculator-modal" class="fixed inset-0 modal-backdrop hidden flex items-end justify-center z-50">
        <div class="bg-white rounded-t-3xl shadow-2xl w-full max-w-md p-4 sm:p-6 transition-all duration-300 transform translate-y-0">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">金額計算機</h3>
            <div class="bg-gray-200 p-4 rounded-xl mb-4 text-right overflow-hidden shadow-inner">
                <div class="text-gray-500 text-sm h-5" id="calc-history"></div>
                <div class="text-4xl font-mono font-extrabold text-gray-800 h-10" id="calc-display">0</div>
            </div>
            
            <div class="grid grid-cols-4 gap-3">
                <button type="button" class="calc-btn bg-red-200 text-red-700 col-span-2" data-key="clear">AC</button>
                <button type="button" class="calc-btn bg-gray-300 text-gray-800" data-key="backspace">
                    <i data-lucide="delete" class="w-6 h-6 mx-auto"></i>
                </button>
                <button type="button" class="calc-btn bg-orange-500 text-white" data-key="/">÷</button>

                <button type="button" class="calc-btn bg-gray-100 text-gray-800" data-key="7">7</button>
                <button type="button" class="calc-btn bg-gray-100 text-gray-800" data-key="8">8</button>
                <button type="button" class="calc-btn bg-gray-100 text-gray-800" data-key="9">9</button>
                <button type="button" class="calc-btn bg-orange-500 text-white" data-key="*">×</button>

                <button type="button" class="calc-btn bg-gray-100 text-gray-800" data-key="4">4</button>
                <button type="button" class="calc-btn bg-gray-100 text-gray-800" data-key="5">5</button>
                <button type="button" class="calc-btn bg-gray-100 text-gray-800" data-key="6">6</button>
                <button type="button" class="calc-btn bg-orange-500 text-white" data-key="-">-</button>

                <button type="button" class="calc-btn bg-gray-100 text-gray-800" data-key="1">1</button>
                <button type="button" class="calc-btn bg-gray-100 text-gray-800" data-key="2">2</button>
                <button type="button" class="calc-btn bg-gray-100 text-gray-800" data-key="3">3</button>
                <button type="button" class="calc-btn bg-orange-500 text-white" data-key="+">+</button>

                <button type="button" class="calc-btn bg-gray-100 text-gray-800 col-span-2" data-key="0">0</button>
                <button type="button" class="calc-btn bg-gray-100 text-gray-800" data-key=".">.</button>
                <button type="button" class="calc-btn bg-emerald-600 text-white" id="calc-ok-btn" data-key="ok">OK</button>
            </div>
        </div>
    </div>
    
    <!-- 設定模態視窗 (Settings Modal) -->
    <div id="settings-modal" class="fixed inset-0 modal-backdrop hidden flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg h-[90vh] overflow-hidden flex flex-col transform transition-all duration-300">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">自定義設定</h3>
                <button id="close-settings-btn" class="p-2 text-gray-500 hover:text-gray-800">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="flex border-b">
                <button class="tab-btn p-3 flex-1 text-center font-semibold border-b-2" data-tab="categories">支出分類與預算</button>
                <button class="tab-btn p-3 flex-1 text-center font-semibold border-b-2" data-tab="payments">支付工具</button>
            </div>

            <!-- 分類設定 Tab -->
            <div id="categories-tab" class="p-4 overflow-y-auto flex-1">
                <form id="category-form" class="mb-4 flex space-x-2">
                    <input type="text" id="cat-name-input" placeholder="分類名稱 (e.g., 娛樂)" required
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                    <input type="number" id="cat-budget-input" placeholder="每月預算 (NT$)" value="0" min="0" required
                           class="w-24 px-3 py-2 border border-gray-300 rounded-lg">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-150">新增</button>
                </form>
                <div id="categories-list" class="space-y-3">
                    <!-- 分類列表動態載入 -->
                </div>
            </div>

            <!-- 支付工具設定 Tab -->
            <div id="payments-tab" class="p-4 overflow-y-auto flex-1 hidden">
                 <form id="payment-form" class="mb-4 flex space-x-2">
                    <input type="text" id="pm-name-input" placeholder="支付工具名稱 (e.g., 悠遊卡)" required
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-150">新增</button>
                </form>
                <div id="payments-list" class="space-y-3">
                    <!-- 支付工具列表動態載入 -->
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // --- 1. 引入 Firebase 模組 ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, updateDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設定 Firestore 紀錄等級 (Debug 用)
        setLogLevel('Debug');

        // 為了確保在非 Canvas 環境中也能執行，我們提供一個備用的 Firebase Config
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyBJcP4HOoVFnbzLT-jdnrW1AtAWXVfjEaM",
            authDomain: "my-expense-tracker-574dd.firebaseapp.com",
            projectId: "my-expense-tracker-574dd",
            storageBucket: "my-expense-tracker-574dd.firebasestorage.app",
            messagingSenderId: "514938495732",
            appId: "1:514938495732:web:bb3529eca4f2db547b74a1",
            measurementId: "G-CDTCB6MFZ3"
        };
        
        // --- 2. 存取環境提供的全域變數 ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // 優先使用環境變數
        let firebaseConfig = defaultFirebaseConfig;
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("解析 __firebase_config 失敗，使用預設配置。", e);
            }
        }
        
        // --- 3. 全域狀態與 UI 元素 ---
        let db;
        let auth;
        let currentUserId = null; 
        let transactions = []; // 儲存所有交易紀錄
        let categories = []; // 儲存所有分類與預算
        let paymentMethods = []; // 儲存所有支付工具
        let unsubscribeListeners = {}; // 儲存所有 onSnapshot 的取消訂閱函式

        // UI 元素
        const loadingOverlay = document.getElementById('loading-overlay');
        const appContainer = document.getElementById('app-container');
        const authSection = document.getElementById('auth-section');
        const totalExpenseElement = document.getElementById('total-expense');
        const listElement = document.getElementById('transactions-list');
        const transactionForm = document.getElementById('transaction-form');
        const transactionIdInput = document.getElementById('transaction-id');
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        const descriptionInput = document.getElementById('description');
        const categorySelect = document.getElementById('category');
        const paymentMethodSelect = document.getElementById('payment-method');
        const amountDisplay = document.getElementById('amount-display');
        const amountValueInput = document.getElementById('amount-value');
        const userEmailDisplay = document.getElementById('user-email-display');
        const messageBox = document.getElementById('message-box');
        const budgetAlertModal = document.getElementById('budget-alert-modal');

        // Setting Modal 相關元素
        const settingsModal = document.getElementById('settings-modal');
        const settingsBtn = document.getElementById('settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const categoriesTab = document.getElementById('categories-tab');
        const paymentsTab = document.getElementById('payments-tab');
        const categoriesList = document.getElementById('categories-list');
        const paymentsList = document.getElementById('payments-list');
        const categoryForm = document.getElementById('category-form');
        const paymentForm = document.getElementById('payment-form');
        const catNameInput = document.getElementById('cat-name-input');
        const catBudgetInput = document.getElementById('cat-budget-input');
        const pmNameInput = document.getElementById('pm-name-input');
        
        // Calculator 元素與狀態 (略... 保持不變)
        const calculatorModal = document.getElementById('calculator-modal');
        const openCalculatorBtn = document.getElementById('open-calculator-btn');
        const calcDisplay = document.getElementById('calc-display');
        const calcHistory = document.getElementById('calc-history');
        const closeAlertBtn = document.getElementById('close-alert-btn');
        let calculatorExpression = '';
        let displayValue = '0';
        
        // 預設資料 (若使用者沒有設定，則自動新增這些)
        const defaultPaymentMethods = [
            { name: '現金 (Cash)', color: 'gray-500' },
            { name: '信用卡 (Credit Card)', color: 'blue-500' },
            { name: '其他自定義 (Other)', color: 'purple-500' },
        ];
        const defaultCategories = [
            { name: '餐飲 (Food)', budget: 15000, color: 'red-500' },
            { name: '交通 (Transport)', budget: 3000, color: 'orange-500' },
            { name: '娛樂 (Entertainment)', budget: 5000, color: 'pink-500' },
            { name: '生活用品 (Groceries)', budget: 8000, color: 'blue-500' },
        ];

        // 預設顏色列表 (供分類設定使用)
        const colorOptions = [
            'red-500', 'orange-500', 'yellow-500', 'emerald-500', 
            'blue-500', 'indigo-500', 'purple-500', 'pink-500'
        ];


        // --- 4. 輔助函式：顯示訊息彈窗 ---
        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = `fixed bottom-4 right-4 p-3 rounded-xl shadow-2xl transition-all duration-500 transform z-50 ${isError ? 'bg-red-600' : 'bg-emerald-500'} ${isError ? 'scale-105' : 'scale-100'}`;
            messageBox.style.display = 'block';
            
            setTimeout(() => {
                messageBox.style.opacity = '0';
                setTimeout(() => {
                    messageBox.style.display = 'none';
                    messageBox.style.opacity = '1'; 
                }, 300);
            }, 3000);
        }

        // --- 5. Firebase 服務與路徑設定 (略... 保持不變) ---
        function initializeServices() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                startAuthListener();
            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                loadingOverlay.classList.add('hidden');
                showMessage(`錯誤：Firebase 連線失敗。${error.message}`, true); 
            }
        }
        
        // 取得 Firestore 集合路徑
        function getCollectionPath(collectionName, uid) {
            return `artifacts/${appId}/users/${uid}/${collectionName}`;
        }
        
        // --- 6. 登入狀態監聽器 (略... 保持不變) ---
        function startAuthListener() {
            onAuthStateChanged(auth, (user) => {
                loadingOverlay.classList.add('hidden');

                if (user) {
                    currentUserId = user.uid;
                    userEmailDisplay.textContent = `已登入: ${user.email}`;

                    document.getElementById('auth-section').classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    
                    // 啟動所有資料監聽
                    startDataListeners(currentUserId);
                    lucide.createIcons();
                    
                } else {
                    currentUserId = null;
                    userEmailDisplay.textContent = '';
                    document.getElementById('auth-section').classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    
                    // 清除 UI
                    totalExpenseElement.textContent = 'NT$ 0.00';
                    listElement.innerHTML = `<p class="text-center text-gray-500 p-4 border border-dashed rounded-lg">請登入以查看交易記錄。</p>`;
                    
                    // 停止所有資料監聽
                    Object.values(unsubscribeListeners).forEach(unsubscribe => unsubscribe());
                    unsubscribeListeners = {};
                }
            });
        }
        
        // --- 7. Email/密碼登入/註冊 (略... 保持不變) ---
        async function handleAuth(isSignUp) {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            if (!email || password.length < 6) {
                showMessage("請輸入有效的 Email，且密碼需至少 6 位元。", true);
                return;
            }
            try {
                if (isSignUp) {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showMessage("註冊成功！");
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage("登入成功！");
                }
                document.getElementById('auth-password').value = '';
            } catch (error) {
                let errorMessage = "登入/註冊失敗。";
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = 'Email 或密碼錯誤。';
                        break;
                    case 'auth/email-already-in-use':
                        errorMessage = '此 Email 已被註冊。';
                        break;
                    default:
                        console.error("Auth 錯誤:", error);
                        errorMessage += ` (${error.code})`;
                }
                showMessage(errorMessage, true);
            }
        }
        
        // --- 8. 整合資料監聽器 (略... 保持不變) ---
        function startDataListeners(uid) {
            // 監聽交易紀錄 (expenses)
            const expenseColRef = collection(db, getCollectionPath('expenses', uid));
            unsubscribeListeners.expenses = onSnapshot(expenseColRef, (snapshot) => {
                transactions = [];
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const createdAtDate = data.createdAt ? data.createdAt.toDate() : new Date();
                    
                    // 只儲存當月的交易紀錄
                    if (createdAtDate.getMonth() === currentMonth && createdAtDate.getFullYear() === currentYear) {
                         transactions.push({
                            id: doc.id,
                            description: data.description,
                            amount: data.amount, // 注意: amount 已經是以負值儲存的支出
                            categoryId: data.categoryId,
                            paymentMethodId: data.paymentMethodId,
                            createdAt: createdAtDate, 
                        });
                    }
                });

                // 客戶端排序：依照建立時間 (新的在前面)
                transactions.sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());
                
                renderTransactions(transactions);
                calculateTotalExpense(transactions);

            }, (error) => {
                console.error("監聽交易記錄失敗:", error);
                showMessage("無法載入交易記錄。", true);
            });

            // 監聽分類 (categories)
            const categoryColRef = collection(db, getCollectionPath('categories', uid));
            unsubscribeListeners.categories = onSnapshot(categoryColRef, (snapshot) => {
                categories = [];
                snapshot.forEach(doc => categories.push({ id: doc.id, ...doc.data() }));
                
                if (categories.length === 0) {
                    // 如果沒有分類，則自動添加預設分類
                    addDefaultData(defaultCategories, 'categories', uid);
                }
                renderCategoryOptions(categories);
                renderSettingsLists(); // 重新渲染設定頁面列表
            }, (error) => console.error("監聽分類失敗:", error));

            // 監聽支付工具 (paymentMethods)
            const paymentColRef = collection(db, getCollectionPath('paymentMethods', uid));
            unsubscribeListeners.paymentMethods = onSnapshot(paymentColRef, (snapshot) => {
                paymentMethods = [];
                snapshot.forEach(doc => paymentMethods.push({ id: doc.id, ...doc.data() }));

                if (paymentMethods.length === 0) {
                    // 如果沒有支付工具，則自動添加預設工具
                    addDefaultData(defaultPaymentMethods, 'paymentMethods', uid);
                }
                renderPaymentOptions(paymentMethods);
                renderSettingsLists(); // 重新渲染設定頁面列表
            }, (error) => console.error("監聽支付工具失敗:", error));
        }

        // --- 9. 自動添加預設資料 (略... 保持不變) ---
        async function addDefaultData(data, collectionName, uid) {
            const colRef = collection(db, getCollectionPath(collectionName, uid));
            console.log(`正在為 ${uid} 添加預設 ${collectionName}。`);
            for (const item of data) {
                try {
                    // 為預設分類隨機分配一個顏色
                    if (collectionName === 'categories') {
                        const randomColor = colorOptions[Math.floor(Math.random() * colorOptions.length)];
                        item.color = randomColor;
                    }
                    await addDoc(colRef, item);
                } catch (e) {
                    console.error(`添加預設 ${collectionName} 失敗:`, e);
                }
            }
        }
        
        // --- 10. 渲染下拉式選單 (略... 保持不變) ---
        function renderCategoryOptions(categoryList) {
            categorySelect.innerHTML = '<option value="">請選擇分類</option>';
            categoryList.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = `${cat.name} (預算: NT$ ${cat.budget ? cat.budget.toLocaleString() : '無'})`;
                categorySelect.appendChild(option);
            });
        }

        function renderPaymentOptions(paymentList) {
            paymentMethodSelect.innerHTML = '<option value="">請選擇支付工具</option>';
            paymentList.forEach(pm => {
                const option = document.createElement('option');
                option.value = pm.id;
                option.textContent = pm.name;
                paymentMethodSelect.appendChild(option);
            });
        }
        
        // --- 11. 計算當月總支出 (略... 保持不變) ---
        function calculateTotalExpense(transactionsList) {
            const total = transactionsList.reduce((sum, transaction) => sum + transaction.amount, 0);
            const absoluteTotal = Math.abs(total);
            const formattedTotal = absoluteTotal.toFixed(2).toLocaleString('en-US');
            
            totalExpenseElement.textContent = `NT$ ${formattedTotal}`;
        }
        
        // --- 12. 預算提醒檢查 (略... 保持不變) ---
        function checkBudgetAlert(newTransaction) {
            const categoryId = newTransaction.categoryId;
            const newAmount = Math.abs(newTransaction.amount);
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const targetCategory = categories.find(c => c.id === categoryId);
            if (!targetCategory || !targetCategory.budget) return;

            const monthlyBudget = targetCategory.budget;

            const currentSpent = transactions
                .filter(t => t.categoryId === categoryId && 
                             t.id !== newTransaction.id &&
                             t.createdAt.getMonth() === currentMonth && 
                             t.createdAt.getFullYear() === currentYear) 
                .reduce((sum, t) => sum + Math.abs(t.amount), 0);
            
            const totalSpentAfterTx = currentSpent + newAmount;
            const ratio = totalSpentAfterTx / monthlyBudget;

            let alertLevel = null;
            let alertMessage = '';
            let alertIcon = 'bell-ring';
            let alertColor = 'red-500';

            if (ratio >= 1.0) {
                alertLevel = '超出預算';
                alertMessage = `您在【${targetCategory.name}】的支出總額已達 NT$ ${totalSpentAfterTx.toLocaleString()}，已經超出了您的每月預算 NT$ ${monthlyBudget.toLocaleString()}！請注意！`;
                alertIcon = 'wallet-x';
                alertColor = 'red-600';
            } else if (ratio >= 0.9) {
                alertLevel = '90% 警示';
                alertMessage = `您在【${targetCategory.name}】的支出已達到預算的 90% (NT$ ${totalSpentAfterTx.toLocaleString()})！即將超出預算。`;
                alertIcon = 'alert-triangle';
                alertColor = 'orange-500';
            } else if (ratio >= 0.7) {
                alertLevel = '70% 警示';
                alertMessage = `您在【${targetCategory.name}】的支出已達到預算的 70% (NT$ ${totalSpentAfterTx.toLocaleString()})。`;
                alertIcon = 'bar-chart-3';
                alertColor = 'yellow-500';
            } else if (ratio >= 0.5) {
                alertLevel = '50% 提醒';
                alertMessage = `您在【${targetCategory.name}】的支出已達到預算的 50% (NT$ ${totalSpentAfterTx.toLocaleString()})。`;
                alertIcon = 'bar-chart-2';
                alertColor = 'blue-500';
            }

            if (alertLevel) {
                document.getElementById('alert-title').textContent = `${alertLevel} - ${targetCategory.name}`;
                document.getElementById('alert-message').textContent = alertMessage;
                const iconElement = document.getElementById('alert-icon');
                iconElement.setAttribute('data-lucide', alertIcon);
                // 移除所有顏色類別，確保只添加新的
                iconElement.className = iconElement.className.split(' ').filter(c => !c.startsWith('text-')).join(' ');
                iconElement.classList.add(`text-${alertColor}`);
                budgetAlertModal.classList.remove('hidden');
                lucide.createIcons();
            }
        }

        // --- 13. 提交交易 (新增/編輯) (略... 保持不變) ---
        transactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!db || !currentUserId) {
                showMessage("請先登入。", true);
                return;
            }

            const id = transactionIdInput.value;
            const description = descriptionInput.value.trim();
            const amount = parseFloat(amountValueInput.value); // amount 是正值
            const categoryId = categorySelect.value;
            const paymentMethodId = paymentMethodSelect.value;

            if (!description || isNaN(amount) || amount <= 0 || !categoryId || !paymentMethodId) {
                showMessage("請輸入有效的描述、大於零的金額，並選擇分類與支付工具。", true);
                return;
            }
            
            // 支出一律儲存為負值
            const expenseAmount = -amount;

            const newTransactionData = {
                id: id, 
                description: description,
                amount: expenseAmount,
                categoryId: categoryId,
                paymentMethodId: paymentMethodId,
            };

            // 執行預算檢查 (在儲存前)
            checkBudgetAlert({...newTransactionData, amount: amount}); // 傳遞正值金額給檢查函式

            try {
                if (id) {
                    // 編輯現有紀錄
                    const docRef = doc(db, getCollectionPath('expenses', currentUserId), id);
                    await updateDoc(docRef, {
                        description: description,
                        amount: expenseAmount,
                        categoryId: categoryId,
                        paymentMethodId: paymentMethodId,
                    });
                    showMessage("交易紀錄更新成功！");
                } else {
                    // 新增紀錄
                    await addDoc(collection(db, getCollectionPath('expenses', currentUserId)), {
                        description: description,
                        amount: expenseAmount,
                        categoryId: categoryId,
                        paymentMethodId: paymentMethodId,
                        createdAt: serverTimestamp()
                    });
                    showMessage("交易記錄新增成功！");
                }

                // 重設表單
                resetForm();

            } catch (e) {
                console.error("提交交易記錄錯誤:", e);
                showMessage("提交記錄失敗，請檢查連線。", true);
            }
        });

        // --- 14. 渲染交易列表 (核心修改) ---
        function renderTransactions(transactionsList) {
            listElement.innerHTML = '';
            if (transactionsList.length === 0) {
                listElement.innerHTML = `<p class="text-center text-gray-500 p-4 border border-dashed rounded-lg">本月尚無交易記錄。</p>`;
                return;
            }
            
            transactionsList.forEach(transaction => {
                const category = categories.find(c => c.id === transaction.categoryId) || { name: '未知分類', color: 'gray-500' };
                // 支出是負值，取絕對值顯示
                const absoluteAmount = Math.abs(transaction.amount);
                const formattedAmount = absoluteAmount.toFixed(2).toLocaleString('en-US');

                const item = document.createElement('div');
                // 移除紅色邊框，改用中性色/主色
                item.className = 'flex items-center justify-between bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-500';
                
                const dateOptions = { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
                const formattedDate = transaction.createdAt.toLocaleDateString('zh-TW', dateOptions);

                // 調整顯示順序: 日期 / 分類 / 金額 / 備註
                item.innerHTML = `
                    <div class="flex items-center min-w-0 flex-1 space-x-3">
                        <div class="min-w-0 flex-1 transaction-grid">
                            <div class="tx-date">${formattedDate}</div>
                            <div class="tx-amount whitespace-nowrap">
                                - NT$ ${formattedAmount}
                            </div>
                            <div class="tx-category text-${category.color || 'gray-500'} truncate">${category.name}</div>
                            <div class="tx-description text-gray-700 truncate">${transaction.description}</div>
                        </div>
                    </div>
                    <div class="flex flex-col items-end ml-4 flex-shrink-0 space-y-1">
                        <div class="flex space-x-2">
                             <button data-id="${transaction.id}" class="edit-btn p-1 text-blue-400 hover:text-blue-600 transition duration-150 rounded-full hover:bg-blue-50">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button data-id="${transaction.id}" class="delete-btn p-1 text-gray-400 hover:text-red-600 transition duration-150 rounded-full hover:bg-red-50">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <span class="text-xs text-gray-400">${paymentMethods.find(p => p.id === transaction.paymentMethodId)?.name || '未知支付'}</span>
                    </div>
                `;
                listElement.appendChild(item);
            });

            lucide.createIcons();

            // 刪除按鈕事件
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    if (id && currentUserId) deleteTransaction(id);
                });
            });
            
            // 編輯按鈕事件
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    if (id) startEditTransaction(id);
                });
            });
        }
        
        // --- 15. 刪除交易 (略... 保持不變) ---
        async function deleteTransaction(id) {
            try {
                const docRef = doc(db, getCollectionPath('expenses', currentUserId), id);
                await deleteDoc(docRef);
                showMessage("交易已刪除。");
            } catch (e) {
                console.error("刪除交易記錄錯誤:", e);
                showMessage("刪除記錄失敗。", true);
            }
        }
        
        // --- 16. 開始編輯交易 (略... 保持不變) ---
        function startEditTransaction(id) {
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;

            // 填充表單
            transactionIdInput.value = transaction.id;
            descriptionInput.value = transaction.description;
            const amount = Math.abs(transaction.amount); 
            amountDisplay.value = amount.toFixed(2);
            amountValueInput.value = amount.toFixed(2);
            categorySelect.value = transaction.categoryId;
            paymentMethodSelect.value = transaction.paymentMethodId;

            // 更新按鈕和標題
            formTitle.textContent = '編輯支出紀錄';
            submitBtn.textContent = '更新紀錄';
        }

        // --- 17. 重設表單 (略... 保持不變) ---
        function resetForm() {
            transactionForm.reset();
            transactionIdInput.value = '';
            amountDisplay.value = '0';
            amountValueInput.value = '0';
            formTitle.textContent = '新增支出紀錄';
            submitBtn.textContent = '儲存紀錄';
        }

        // --- 18. 計算機功能 (Calculator Logic) (略... 保持不變) ---
        function evaluateExpression(expression) {
            try {
                let sanitized = expression.replace(/×/g, '*').replace(/÷/g, '/');
                return parseFloat(eval(sanitized).toFixed(2));
            } catch (e) {
                return NaN;
            }
        }

        function updateCalculator(key) {
            if (key === 'clear') {
                calculatorExpression = '';
                displayValue = '0';
                calcHistory.textContent = '';
            } else if (key === 'backspace') {
                calculatorExpression = calculatorExpression.slice(0, -1);
                if (calculatorExpression === '') {
                    displayValue = '0';
                } else {
                    const parts = calculatorExpression.split(/[\+\-\*\/÷]/);
                    displayValue = parts[parts.length - 1] || calculatorExpression;
                }
            } else if (key === '=') {
                const result = evaluateExpression(calculatorExpression);
                if (!isNaN(result)) {
                    calcHistory.textContent = `${calculatorExpression} =`;
                    calculatorExpression = result.toString();
                    displayValue = calculatorExpression;
                } else {
                    calcHistory.textContent = '錯誤';
                    displayValue = '錯誤';
                    calculatorExpression = '';
                }
            } else if (['+', '-', '*', '/', '×', '÷'].includes(key)) {
                const lastChar = calculatorExpression.slice(-1);
                if (['+', '-', '*', '/', '×', '÷'].includes(lastChar) && key !== lastChar) {
                    calculatorExpression = calculatorExpression.slice(0, -1) + key;
                } else if (!['+', '-', '*', '/', '×', '÷'].includes(lastChar)) {
                    const result = evaluateExpression(calculatorExpression);
                    if (!isNaN(result)) {
                        calculatorExpression = result.toString() + key;
                    } else {
                        return;
                    }
                }
                displayValue = key;
            } else if (key === '.') {
                const parts = calculatorExpression.split(/[\+\-\*\/÷]/);
                const currentNumber = parts[parts.length - 1] || '0';
                if (!currentNumber.includes('.')) {
                    calculatorExpression += key;
                    displayValue += key;
                }
            } else {
                if (displayValue === '0' && key !== '.') {
                    displayValue = key;
                    calculatorExpression = calculatorExpression.slice(0, -1) + key;
                } else {
                    displayValue += key;
                }
                calculatorExpression += key;
            }

            calcDisplay.textContent = displayValue;
            calcHistory.textContent = calculatorExpression;
            if (calcHistory.textContent.length > 25) {
                 calcHistory.textContent = '... ' + calcHistory.textContent.slice(-25);
            }
        }

        // --- 19. 設定頁面功能 (Categories/Payments Management) ---

        // 渲染設定列表
        function renderSettingsLists() {
            // 渲染分類列表
            categoriesList.innerHTML = '';
            categories.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg border';
                item.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="w-3 h-3 rounded-full bg-${cat.color || 'gray-500'}"></span>
                        <p class="font-medium text-gray-800">${cat.name}</p>
                        <span class="text-sm text-gray-500">(預算: NT$ ${cat.budget ? cat.budget.toLocaleString() : '無'})</span>
                    </div>
                    <button data-id="${cat.id}" data-type="category" class="delete-config-btn p-1 text-gray-400 hover:text-red-600 transition duration-150 rounded-full hover:bg-red-50">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                categoriesList.appendChild(item);
            });

            // 渲染支付工具列表
            paymentsList.innerHTML = '';
            paymentMethods.forEach(pm => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg border';
                item.innerHTML = `
                    <p class="font-medium text-gray-800">${pm.name}</p>
                    <button data-id="${pm.id}" data-type="paymentMethod" class="delete-config-btn p-1 text-gray-400 hover:text-red-600 transition duration-150 rounded-full hover:bg-red-50">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                paymentsList.appendChild(item);
            });
            lucide.createIcons();
            
            // 綁定刪除事件
            document.querySelectorAll('.delete-config-btn').forEach(btn => {
                btn.addEventListener('click', deleteConfigItem);
            });
        }
        
        async function deleteConfigItem(e) {
            if (!currentUserId || !db) return;
            const id = e.currentTarget.getAttribute('data-id');
            const type = e.currentTarget.getAttribute('data-type');
            
            if (!id || !type) return;

            try {
                const collectionName = type === 'category' ? 'categories' : 'paymentMethods';
                const docRef = doc(db, getCollectionPath(collectionName, currentUserId), id);
                await deleteDoc(docRef);
                showMessage(`${collectionName === 'categories' ? '分類' : '支付工具'} 已刪除。`);
            } catch (error) {
                console.error("刪除設定項目錯誤:", error);
                showMessage("刪除失敗。", true);
            }
        }

        // 提交新增分類
        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId || !db) return;

            const name = catNameInput.value.trim();
            const budget = parseInt(catBudgetInput.value) || 0;

            if (name && budget >= 0) {
                const randomColor = colorOptions[Math.floor(Math.random() * colorOptions.length)];
                try {
                    await addDoc(collection(db, getCollectionPath('categories', currentUserId)), {
                        name: name,
                        budget: budget,
                        color: randomColor
                    });
                    showMessage(`分類【${name}】已新增！`);
                    categoryForm.reset();
                } catch (error) {
                    showMessage("新增分類失敗。", true);
                }
            } else {
                showMessage("請輸入有效的名稱和預算。", true);
            }
        });

        // 提交新增支付工具
        paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId || !db) return;

            const name = pmNameInput.value.trim();

            if (name) {
                try {
                    await addDoc(collection(db, getCollectionPath('paymentMethods', currentUserId)), {
                        name: name
                    });
                    showMessage(`支付工具【${name}】已新增！`);
                    paymentForm.reset();
                } catch (error) {
                    showMessage("新增支付工具失敗。", true);
                }
            } else {
                showMessage("請輸入有效的名稱。", true);
            }
        });


        // --- 20. 事件監聽器：總結 ---
        
        // Auth events (略... 保持不變)
        document.getElementById('login-btn').addEventListener('click', () => handleAuth(false));
        document.getElementById('signup-btn').addEventListener('click', () => handleAuth(true));
        document.getElementById('signout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                showMessage("您已成功登出。");
            } catch (e) {
                console.error("登出錯誤:", e);
                showMessage("登出失敗。", true);
            }
        });
        
        // Calculator events (略... 保持不變)
        openCalculatorBtn.addEventListener('click', () => {
            calculatorModal.classList.remove('hidden');
            calculatorExpression = amountValueInput.value === '0' ? '' : amountValueInput.value;
            displayValue = amountValueInput.value === '0' ? '0' : amountValueInput.value;
            calcDisplay.textContent = displayValue;
            calcHistory.textContent = calculatorExpression;
        });

        calculatorModal.addEventListener('click', (e) => {
            if (e.target.id === 'calculator-modal') {
                calculatorModal.classList.add('hidden');
            }
        });

        document.querySelectorAll('.calc-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const key = e.currentTarget.getAttribute('data-key');
                if (key !== 'ok') {
                    updateCalculator(key);
                }
            });
        });

        document.getElementById('calc-ok-btn').addEventListener('click', () => {
            const result = evaluateExpression(calculatorExpression);
            if (!isNaN(result) && result >= 0) {
                amountDisplay.value = result.toFixed(2);
                amountValueInput.value = result.toFixed(2);
                calculatorModal.classList.add('hidden');
            } else {
                showMessage('無效或負數的金額。請重新輸入。', true);
            }
        });
        
        // Budget Alert close button (略... 保持不變)
        closeAlertBtn.addEventListener('click', () => {
            budgetAlertModal.classList.add('hidden');
        });
        
        // Settings Modal events
        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.remove('hidden');
            document.querySelector('.tab-btn[data-tab="categories"]').click(); // 預設開啟分類
            lucide.createIcons();
        });
        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });
        settingsModal.addEventListener('click', (e) => {
             if (e.target.id === 'settings-modal') {
                settingsModal.classList.add('hidden');
            }
        });
        
        // Tab switching logic
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('border-blue-500', 'text-blue-500');
                    b.classList.add('border-transparent', 'text-gray-500');
                });
                e.currentTarget.classList.add('border-blue-500', 'text-blue-500');
                e.currentTarget.classList.remove('border-transparent', 'text-gray-500');

                categoriesTab.classList.add('hidden');
                paymentsTab.classList.add('hidden');

                if (e.currentTarget.getAttribute('data-tab') === 'categories') {
                    categoriesTab.classList.remove('hidden');
                } else {
                    paymentsTab.classList.remove('hidden');
                }
            });
        });


        // 啟動應用程式
        initializeServices();
    </script>
</body>
</html>

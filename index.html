<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¨˜å¸³å°å¹«æ‰‹</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Zen Maru Gothic -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Change font to Zen Maru Gothic and slightly increase base size for better readability */
        body { 
            font-family: 'Zen Maru Gothic', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            font-size: 17px; /* Increase base font size slightly */
        }
        .calc-btn { transition: background-color 0.1s; }
        .calc-btn:active { background-color: #e5e7eb; }
        /* Hide scrollbar for category list */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Smooth transition for stats bars */
        .stat-bar-fill { transition: width 1s ease-out; }

        /* Custom scrollbar for mobile-friendly view */
        .scrollable-content {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Full screen container for mobile */
        #app-container {
            min-height: 100vh;
            max-width: 600px;
        }
    </style>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // ä¿®æ­£ï¼šç§»é™¤ä¸å­˜åœ¨çš„åŒ¯å‡ºé …ç›®ï¼Œå¦‚ endOfMonth å’Œ startOfMonth
        import { getFirestore, doc, collection, addDoc, onSnapshot, deleteDoc, updateDoc, setDoc, query, where, Timestamp, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Use a debug level for logging Firestore operations
        setLogLevel('Debug');

        let db, auth;
        let appId, userId;

        // Global state for expenses (managed by onSnapshot)
        window.allExpenses = [];

        // Global variables provided by the Canvas environment
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';


        // --- Helper Functions ---

        /**
         * Formats the amount with a comma separator.
         * @param {number} amount 
         * @returns {string}
         */
        window.formatAmount = (amount) => {
            if (typeof amount === 'number') {
                return amount.toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }
            return '0';
        };

        /**
         * Formats the date to a localized short string.
         * @param {Date | Timestamp} dateOrTimestamp 
         * @returns {string}
         */
        window.formatDate = (dateOrTimestamp) => {
            const date = dateOrTimestamp instanceof Timestamp ? dateOrTimestamp.toDate() : dateOrTimestamp;
            return date.toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' });
        };

        /**
         * ç²å–ç•¶å‰æœˆä»½çš„ç¬¬ä¸€å¤© (00:00:00)
         * @returns {Date}
         */
        function getStartOfMonth() {
            const today = new Date();
            return new Date(today.getFullYear(), today.getMonth(), 1, 0, 0, 0);
        }

        /**
         * ç²å–ç•¶å‰æœˆä»½çš„æœ€å¾Œä¸€å¤© (23:59:59)
         * @returns {Date}
         */
        function getEndOfMonth() {
            const today = new Date();
            // next month, 0 day (which is the last day of the current month)
            return new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59);
        }


        /**
         * Shows a custom loading overlay.
         * @param {boolean} show 
         */
        function showLoading(show) {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (show) loadingOverlay.classList.remove('hidden');
            else loadingOverlay.classList.add('hidden');
        }

        /**
         * Shows a custom alert modal.
         * @param {string} title - The title of the alert.
         * @param {string} message - The main message.
         * @param {string} type - 'green', 'red', 'orange', or an icon string like 'ğŸš¨'.
         */
        window.showAlert = (title, message, type = 'orange') => {
            const modal = document.getElementById('alert-modal');
            const iconElement = document.getElementById('alert-icon');
            const titleElement = document.getElementById('alert-title');
            const msgElement = document.getElementById('alert-msg');

            let icon = '';
            switch(type) {
                case 'green': icon = 'âœ…'; break;
                case 'red': icon = 'âŒ'; break;
                case 'orange': icon = 'âš ï¸'; break;
                default: icon = type; // Allow passing custom icon like 'ğŸš¨'
            }

            iconElement.innerText = icon;
            titleElement.innerText = title;
            msgElement.innerText = message;
            
            modal.classList.remove('hidden');
        };

        /**
         * Shows a custom confirmation modal.
         * @param {string} title - The title of the confirmation.
         * @param {string} message - The main message.
         * @param {function} onConfirm - Function to run on confirm.
         */
        window.showConfirm = (title, message, onConfirm) => {
            const modal = document.getElementById('confirm-modal');
            const titleElement = document.getElementById('confirm-title');
            const msgElement = document.getElementById('confirm-msg');
            const confirmBtn = document.getElementById('confirm-ok-btn');

            titleElement.innerText = title;
            msgElement.innerText = message;

            // Clear previous listener and add new one
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
                onConfirm();
            });
            
            modal.classList.remove('hidden');
        };


        // --- Expense Data & Categories ---

        const categories = [
            { name: "é¤é£²", icon: "ğŸ”", color: "bg-blue-100", text: "text-blue-600" },
            { name: "äº¤é€š", icon: "ğŸš—", color: "bg-green-100", text: "text-green-600" },
            { name: "å¨›æ¨‚", icon: "ğŸ¬", color: "bg-purple-100", text: "text-purple-600" },
            { name: "è³¼ç‰©", icon: "ğŸ›ï¸", color: "bg-pink-100", text: "text-pink-600" },
            { name: "ä½æˆ¿", icon: "ğŸ ", color: "bg-yellow-100", text: "text-yellow-600" },
            { name: "é›œé …", icon: "ğŸ’¡", color: "bg-gray-100", text: "text-gray-600" },
        ];
        
        let selectedCategory = categories[0];
        
        /**
         * Gets the full category object (with icon and color) by name.
         * @param {string} name 
         * @returns {object}
         */
        function getCategoryByName(name) {
            return categories.find(c => c.name === name) || categories[categories.length - 1]; // Default to misc
        }

        // --- View Logic ---

        const view = (v) => {
            const main = document.getElementById('main-view');
            const stats = document.getElementById('stats-view');
            const set = document.getElementById('set-view');
            const headerTitle = document.getElementById('header-title');
            const addBtn = document.getElementById('add-btn');

            const btnHome = document.getElementById('btn-home');
            const btnStats = document.getElementById('btn-stats');
            const btnSet = document.getElementById('btn-set');

            // Reset all
            main.classList.add('hidden');
            stats.classList.add('hidden');
            set.classList.add('hidden');
            
            [btnHome, btnStats, btnSet].forEach(btn => {
                btn.classList.remove('text-blue-600');
                btn.classList.add('text-gray-400');
            });

            if (v === 'home') {
                main.classList.remove('hidden');
                headerTitle.innerText = "æœ¬æœˆæ”¯å‡º";
                btnHome.classList.add('text-blue-600'); btnHome.classList.remove('text-gray-400');
                addBtn.classList.remove('hidden');
                renderExpenses(window.allExpenses); // Re-render for safety
            } else if (v === 'stats') {
                stats.classList.remove('hidden');
                headerTitle.innerText = "çµ±è¨ˆå ±è¡¨";
                btnStats.classList.add('text-blue-600'); btnStats.classList.remove('text-gray-400');
                addBtn.classList.add('hidden');
                renderStats(); // Ensure fresh render
            } else {
                set.classList.remove('hidden');
                headerTitle.innerText = "è¨­å®š";
                btnSet.classList.add('text-blue-600'); btnSet.classList.remove('text-gray-400');
                addBtn.classList.add('hidden');
            }
        };

        // --- Data Fetching and Rendering ---

        const expenseList = document.getElementById('expense-list');
        const totalAmountDisplay = document.getElementById('total-amount');

        /**
         * Renders the list of expenses on the home screen.
         * @param {Array} expenses 
         */
        function renderExpenses(expenses) {
            expenseList.innerHTML = '';
            
            if (expenses.length === 0) {
                expenseList.innerHTML = '<li class="text-center text-gray-500 py-8">æœ¬æœˆå°šç„¡æ”¯å‡ºè¨˜éŒ„ ğŸ‰</li>';
                totalAmountDisplay.innerText = '0';
                return;
            }

            let total = 0;

            // Sort by date descending (most recent first) - IMPORTANT: Do this in JS to avoid index errors in Firestore
            expenses.sort((a, b) => b.date.toDate().getTime() - a.date.toDate().getTime());

            expenses.forEach(expense => {
                const categoryData = getCategoryByName(expense.category);
                const li = document.createElement('li');
                
                // Using expense.id to pass the document ID to the delete button
                li.className = 'flex items-center justify-between p-3 bg-white rounded-xl shadow-md mb-2 hover:shadow-lg transition duration-200';
                li.innerHTML = `
                    <div class="flex items-center space-x-4 flex-grow min-w-0">
                        <!-- Icon (Category) -->
                        <div class="text-xl flex-shrink-0">${categoryData.icon}</div>
                        <!-- Details (Category and Note) -->
                        <div class="flex-grow min-w-0">
                            <p class="font-semibold text-gray-800 truncate">${expense.category}</p>
                            <p class="text-sm text-gray-500 truncate">${expense.note || 'ç„¡å‚™è¨»'}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3 flex-shrink-0">
                        <!-- Amount and Date -->
                        <div class="flex flex-col items-end">
                            <p class="font-bold text-lg text-red-500">-${formatAmount(expense.amount)}</p>
                            <p class="text-xs text-gray-400">${formatDate(expense.date)}</p>
                        </div>
                        <!-- åƒåœ¾æ¡¶åœ–ç¤º (Delete Button) -->
                        <button data-id="${expense.id}" class="delete-btn p-2 text-gray-400 hover:text-red-500 active:bg-red-50 transition duration-150 rounded-full flex-shrink-0" aria-label="åˆªé™¤è¨˜éŒ„">
                            <i class="fa-solid fa-trash-can text-lg"></i>
                        </button>
                    </div>
                `;
                expenseList.appendChild(li);
                total += expense.amount;
            });

            totalAmountDisplay.innerText = formatAmount(total);
            window.totalMonthlyExpense = total; // Update global total for stats
        }

        /**
         * Renders the statistics view.
         */
        function renderStats() {
            const statsContainer = document.getElementById('stats-container');
            statsContainer.innerHTML = '';

            if (window.allExpenses.length === 0) {
                statsContainer.innerHTML = '<p class="text-center text-gray-500 py-8">æ²’æœ‰è¶³å¤ çš„æ•¸æ“šä¾†ç”Ÿæˆå ±è¡¨ã€‚</p>';
                return;
            }

            // 1. Calculate total by category
            const categoryTotals = {};
            window.allExpenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
            });

            // 2. Sort categories by total amount descending
            const sortedCategories = Object.entries(categoryTotals)
                .map(([category, total]) => ({ category, total }))
                .sort((a, b) => b.total - a.total);

            // 3. Render the list
            sortedCategories.forEach(item => {
                const categoryData = getCategoryByName(item.category);
                const percentage = (item.total / window.totalMonthlyExpense) * 100;

                const statItem = document.createElement('div');
                statItem.className = 'mb-4 p-4 bg-white rounded-xl shadow-md';
                statItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <div class="text-xl ${categoryData.text}">${categoryData.icon}</div>
                            <span class="font-semibold text-gray-800">${item.category}</span>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-red-500">-${formatAmount(item.total)}</p>
                            <p class="text-sm text-gray-500">${percentage.toFixed(1)}%</p>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="stat-bar-fill ${categoryData.text.replace('text', 'bg')} h-2.5 rounded-full" style="width: 0%" data-percent="${percentage.toFixed(0)}"></div>
                    </div>
                `;
                statsContainer.appendChild(statItem);
            });

            // Animate bars after rendering
            setTimeout(() => {
                document.querySelectorAll('.stat-bar-fill').forEach(bar => {
                    bar.style.width = bar.dataset.percent + '%';
                });
            }, 50); // Small delay to ensure rendering is done
        }

        // --- CRUD Operations ---

        /**
         * Adds a new expense record to Firestore.
         * @param {number} amount
         * @param {string} category
         * @param {string} note
         * @param {Date} date
         */
        async function addExpense(amount, category, note, date) {
            if (!db || !userId) {
                showAlert('éŒ¯èª¤', 'æœªåˆå§‹åŒ–è³‡æ–™åº«æˆ–æœªç™»å…¥', 'red');
                return;
            }

            showLoading(true);
            try {
                // Ensure the path matches the security rules: /artifacts/{appId}/users/{userId}/expenses
                const expensesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/expenses`);
                
                const expenseData = {
                    amount: amount,
                    category: category,
                    note: note,
                    date: Timestamp.fromDate(date), // Use Firestore Timestamp
                };

                const docRef = await addDoc(expensesCollectionRef, expenseData);
                console.log("Document written with ID: ", docRef.id);
                
                // No need to manually update UI, onSnapshot handles it
                showAlert('æˆåŠŸ', 'æ”¯å‡ºè¨˜éŒ„å·²æ–°å¢ï¼', 'green');
                closeModal(); // Close the modal after successful submission

            } catch (error) {
                console.error("Error adding document: ", error);
                showAlert('éŒ¯èª¤', `æ–°å¢å¤±æ•—: ${error.message}`, 'red');
            } finally {
                showLoading(false);
            }
        }

        /**
         * Deletes an expense record from Firestore.
         * @param {string} id - The document ID of the expense to delete.
         */
        window.deleteExpense = async (id) => {
            if (!db || !auth.currentUser) {
                showAlert('éŒ¯èª¤', 'æœªåˆå§‹åŒ–è³‡æ–™åº«æˆ–æœªç™»å…¥', 'red');
                return;
            }
            showLoading(true);
            try {
                const userId = auth.currentUser.uid;
                // Path: /artifacts/{appId}/users/{userId}/expenses/{documentId}
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/expenses`, id);
                await deleteDoc(docRef);
                
                // onSnapshot will handle the UI update
                showAlert('æˆåŠŸ', 'æ”¯å‡ºè¨˜éŒ„å·²åˆªé™¤ï¼', 'green');
            } catch (error) {
                console.error("Error deleting document: ", error);
                showAlert('éŒ¯èª¤', `åˆªé™¤å¤±æ•—: ${error.message}`, 'red');
            } finally {
                showLoading(false);
            }
        }


        // --- UI Modal Logic ---

        const modalOverlay = document.getElementById('modal-overlay');
        const closeModal = () => modalOverlay.classList.add('hidden');
        document.getElementById('modal-close-btn').addEventListener('click', closeModal);
        document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);

        const openModal = () => {
            // Reset calculator state
            document.getElementById('calc-display').value = '0';
            document.getElementById('note-input').value = '';
            document.getElementById('date-input').value = new Date().toISOString().substring(0, 10);
            
            // Set initial category (e.g., first one)
            selectedCategory = categories[0];
            renderCategorySelection();

            modalOverlay.classList.remove('hidden');
            document.getElementById('calc-display').focus();
        };
        document.getElementById('add-btn').addEventListener('click', openModal);

        // --- Calculator Logic ---

        let currentInput = '0';
        let operator = null;
        let firstOperand = null;
        const calcDisplay = document.getElementById('calc-display');

        const updateDisplay = () => {
            // Display always shows currentInput, capped to a reasonable length
            calcDisplay.value = currentInput.slice(0, 15);
        };

        const handleNumber = (number) => {
            if (currentInput === '0') {
                currentInput = number;
            } else {
                currentInput += number;
            }
            updateDisplay();
        };

        const handleDecimal = () => {
            // Only allow one decimal point, and only if not currently zero
            if (!currentInput.includes('.')) {
                currentInput += '.';
            }
            updateDisplay();
        };

        const handleOperator = (nextOperator) => {
            const inputValue = parseFloat(currentInput);

            if (firstOperand === null) {
                firstOperand = inputValue;
            } else if (operator) {
                const result = calculate(firstOperand, inputValue, operator);
                currentInput = String(result);
                firstOperand = result;
            }

            operator = nextOperator;
            currentInput = '0'; // Ready for the next number
            updateDisplay();
        };

        const handleEquals = () => {
            if (operator === null) return;

            const secondOperand = parseFloat(currentInput);
            if (firstOperand === null) {
                firstOperand = secondOperand;
            }

            const result = calculate(firstOperand, secondOperand, operator);

            currentInput = String(result);
            firstOperand = null;
            operator = null;
            updateDisplay();
        };

        const calculate = (num1, num2, op) => {
            switch (op) {
                case '+': return num1 + num2;
                case '-': return num1 - num2;
                case '*': return num1 * num2;
                case '/': 
                    if (num2 === 0) {
                        showAlert('éŒ¯èª¤', 'é™¤æ•¸ä¸èƒ½ç‚ºé›¶ï¼', 'red');
                        return num1;
                    }
                    return num1 / num2;
                default: return num2;
            }
        };

        const handleClear = () => {
            currentInput = '0';
            firstOperand = null;
            operator = null;
            updateDisplay();
        };

        const handleBackspace = () => {
            if (currentInput.length > 1) {
                currentInput = currentInput.slice(0, -1);
            } else {
                currentInput = '0';
            }
            updateDisplay();
        };

        // Event listeners for calculator buttons
        document.querySelectorAll('.calc-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const value = e.target.closest('button').dataset.value;
                if (!value) return;

                if (value >= '0' && value <= '9') {
                    handleNumber(value);
                } else if (value === '.') {
                    handleDecimal();
                } else if (['+', '-', '*', '/'].includes(value)) {
                    handleOperator(value);
                } else if (value === '=') {
                    handleEquals();
                } else if (value === 'C') {
                    handleClear();
                } else if (value === 'backspace') {
                    handleBackspace();
                }
            });
        });

        // --- Category Selection Logic ---

        const categoryContainer = document.getElementById('category-container');

        const renderCategorySelection = () => {
            categoryContainer.innerHTML = '';
            categories.forEach(cat => {
                const isSelected = cat.name === selectedCategory.name;
                const button = document.createElement('button');
                button.dataset.category = cat.name;
                button.className = `flex flex-col items-center justify-center p-2 rounded-xl transition duration-150 transform hover:scale-105 active:scale-95 ${isSelected ? cat.color + ' border-2 border-blue-500' : 'bg-gray-100'}`;
                button.innerHTML = `
                    <div class="text-3xl mb-1">${cat.icon}</div>
                    <span class="text-xs font-medium text-gray-700">${cat.name}</span>
                `;
                button.addEventListener('click', () => {
                    selectedCategory = cat;
                    renderCategorySelection(); // Re-render to show selection change
                });
                categoryContainer.appendChild(button);
            });
        };

        // Submit Button Logic
        document.getElementById('modal-submit-btn').addEventListener('click', () => {
            handleEquals(); // Finalize calculation
            
            const amount = parseFloat(calcDisplay.value);
            const category = selectedCategory.name;
            const note = document.getElementById('note-input').value.trim();
            const dateStr = document.getElementById('date-input').value;
            const date = new Date(dateStr + 'T12:00:00'); // Use noon to avoid timezone issues

            if (isNaN(amount) || amount <= 0) {
                showAlert('è¼¸å…¥éŒ¯èª¤', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡ã€‚', 'orange');
                return;
            }

            addExpense(amount, category, note, date);
        });
        
        // --- Initialization and Auth ---

        window.onload = async () => {
            // Init Firebase
            if (Object.keys(firebaseConfig).length > 0) {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                } catch (e) {
                    console.error("Firebase Initialization Error:", e);
                    showAlert('éŒ¯èª¤', 'Firebaseåˆå§‹åŒ–å¤±æ•—', 'red');
                    return;
                }
            } else {
                console.error("Firebase config is missing.");
                showAlert('éŒ¯èª¤', 'Firebaseè¨­å®šéºå¤±', 'red');
                return;
            }

            // Authentication
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication Error:", error);
                showAlert('éŒ¯èª¤', 'ç™»å…¥å¤±æ•—', 'red');
            }

            // Auth State Change Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id').innerText = `ä½¿ç”¨è€…ID: ${userId}`;
                    
                    // ä¿®æ­£ï¼šä½¿ç”¨è‡ªå®šç¾©çš„ getStartOfMonth å’Œ getEndOfMonth å‡½å¼
                    const startOfMonthDate = getStartOfMonth();
                    const endOfMonthDate = getEndOfMonth();

                    // Firestore Query Setup (Current Month)
                    const expensesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/expenses`);
                    // ä¿®æ­£ï¼šç§»é™¤ orderBy('date', 'desc') ä»¥é¿å… Firestore ç´¢å¼•éŒ¯èª¤ï¼Œæ”¹åœ¨ renderExpenses ä¸­é€²è¡Œæ’åº
                    const q = query(
                        expensesCollectionRef,
                        where('date', '>=', Timestamp.fromDate(startOfMonthDate)),
                        where('date', '<=', Timestamp.fromDate(endOfMonthDate))
                    );
                    
                    // Real-time listener
                    onSnapshot(q, (snapshot) => {
                        window.allExpenses = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        console.log("Expenses updated from Firestore:", window.allExpenses);
                        
                        // Only re-render the current view
                        const currentView = document.getElementById('main-view').classList.contains('hidden') ? 
                                           (document.getElementById('stats-view').classList.contains('hidden') ? 'set' : 'stats') : 'home';
                        view(currentView); 
                    }, (error) => {
                        console.error("Firestore Snapshot Error:", error);
                        showAlert('éŒ¯èª¤', `æ•¸æ“šåŒæ­¥å¤±æ•—: ${error.message}`, 'red');
                    });
                    
                } else {
                    userId = null;
                    document.getElementById('user-id').innerText = 'æœªç™»å…¥';
                    window.allExpenses = [];
                    renderExpenses([]);
                }
            });

            // Initial view setup (will trigger data fetch once auth completes)
            view('home');
            
            // Event Delegation for Delete Button (Home View)
            expenseList.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    const expenseId = deleteBtn.dataset.id;
                    showConfirm(
                        'ç¢ºèªåˆªé™¤',
                        'æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºè¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚',
                        () => window.deleteExpense(expenseId)
                    );
                }
            });
            
            // Set today's date in the modal input
            document.getElementById('date-input').value = new Date().toISOString().substring(0, 10);
        };
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- App Container -->
    <div id="app-container" class="mx-auto flex flex-col shadow-lg bg-gray-50">
        
        <!-- Header -->
        <header class="p-4 bg-white shadow-sm sticky top-0 z-10">
            <div class="flex justify-between items-center">
                <h1 id="header-title" class="text-xl font-bold text-gray-800">æœ¬æœˆæ”¯å‡º</h1>
                <button id="add-btn" class="bg-blue-600 text-white w-10 h-10 rounded-full shadow-lg hover:bg-blue-700 transition duration-150 flex items-center justify-center active:scale-95">
                    <i class="fa-solid fa-plus text-lg"></i>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow scrollable-content p-4">

            <!-- Home View -->
            <div id="main-view">
                <!-- Total Display Card -->
                <div class="bg-red-500 text-white p-6 rounded-2xl shadow-xl mb-4">
                    <p class="text-sm font-light opacity-80">æœ¬æœˆç¸½æ”¯å‡º (NTD)</p>
                    <p id="total-amount" class="text-4xl font-bold mt-1">0</p>
                </div>

                <!-- Expense List -->
                <h2 class="text-lg font-semibold text-gray-700 mb-3">è©³ç´°è¨˜éŒ„</h2>
                <ul id="expense-list" class="space-y-3">
                    <!-- Expense items will be rendered here -->
                    <li class="text-center text-gray-500 py-8">è¼‰å…¥ä¸­...</li>
                </ul>
            </div>

            <!-- Stats View -->
            <div id="stats-view" class="hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4">æ”¯å‡ºåˆ†é¡åˆ†æ</h2>
                <div id="stats-container">
                    <!-- Stats content will be rendered here -->
                    <p class="text-center text-gray-500 py-8">è¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <!-- Settings View -->
            <div id="set-view" class="hidden p-4 bg-white rounded-xl shadow-md">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">å¸³æˆ¶è³‡è¨Š</h2>
                <p class="text-sm text-gray-600" id="user-id">ä½¿ç”¨è€…ID: è¼‰å…¥ä¸­...</p>
                <p class="mt-4 text-sm text-gray-500">æ­¤IDç”¨æ–¼æ¨™è­˜æ‚¨çš„è³‡æ–™ã€‚æ‰€æœ‰è¨˜éŒ„éƒ½æœƒå„²å­˜åœ¨æ‚¨å¸³æˆ¶ä¸‹çš„ç§æœ‰ç©ºé–“ã€‚</p>
            </div>

        </main>

        <!-- Bottom Navigation Bar -->
        <nav class="p-3 bg-white border-t border-gray-200 sticky bottom-0 z-10">
            <div class="flex justify-around items-center">
                <button id="btn-home" onclick="view('home')" class="flex flex-col items-center p-2 text-blue-600">
                    <i class="fa-solid fa-house text-xl"></i>
                    <span class="text-xs mt-1">é¦–é </span>
                </button>
                <button id="btn-stats" onclick="view('stats')" class="flex flex-col items-center p-2 text-gray-400">
                    <i class="fa-solid fa-chart-pie text-xl"></i>
                    <span class="text-xs mt-1">çµ±è¨ˆ</span>
                </button>
                <button id="btn-set" onclick="view('set')" class="flex flex-col items-center p-2 text-gray-400">
                    <i class="fa-solid fa-gear text-xl"></i>
                    <span class="text-xs mt-1">è¨­å®š</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Modal Overlay (For Add Expense) -->
    <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center z-50 transition-opacity duration-300">
        <div class="bg-white w-full max-w-lg rounded-t-3xl shadow-2xl transform transition-transform duration-300 translate-y-0 max-h-[85vh] flex flex-col">
            <!-- Modal Header -->
            <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white rounded-t-3xl">
                <h3 class="text-xl font-bold text-gray-800">æ–°å¢æ”¯å‡º</h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600 p-2 rounded-full active:bg-gray-100">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>

            <!-- Modal Body (Scrollable Content) -->
            <div class="p-4 space-y-4 scrollable-content flex-grow">
                
                <!-- Amount Display (Calculator Input) -->
                <div class="relative mb-4">
                    <input type="text" id="calc-display" value="0" readonly 
                           class="w-full text-5xl font-light text-right p-3 border-b-2 border-blue-500 focus:outline-none focus:ring-0 rounded-lg text-gray-800"
                           placeholder="0">
                    <span class="absolute right-3 bottom-4 text-gray-500 text-2xl">NTD</span>
                </div>

                <!-- Category Selection -->
                <h4 class="text-lg font-semibold text-gray-700 mb-2">é¸æ“‡é¡åˆ¥</h4>
                <div id="category-container" class="grid grid-cols-3 gap-3">
                    <!-- Categories will be rendered here by JS -->
                </div>
                
                <!-- Date Picker -->
                <h4 class="text-lg font-semibold text-gray-700 pt-2 mb-2">æ—¥æœŸ</h4>
                <input type="date" id="date-input" class="w-full p-3 border border-gray-300 rounded-xl focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 transition duration-150">

                <!-- Note Input -->
                <h4 class="text-lg font-semibold text-gray-700 pt-2 mb-2">å‚™è¨» (é¸å¡«)</h4>
                <input type="text" id="note-input" placeholder="ä¾‹å¦‚ï¼šæ™šé¤ã€é›»å½±ç¥¨..." class="w-full p-3 border border-gray-300 rounded-xl focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 transition duration-150">

                <!-- Calculator Grid -->
                <div class="grid grid-cols-4 gap-2 pt-4">
                    <!-- Row 1 -->
                    <button class="calc-btn text-gray-800 text-xl p-3 rounded-xl bg-gray-200 hover:bg-gray-300" data-value="C">C</button>
                    <button class="calc-btn text-gray-800 text-xl p-3 rounded-xl bg-gray-200 hover:bg-gray-300" data-value="/">/</button>
                    <button class="calc-btn text-gray-800 text-xl p-3 rounded-xl bg-gray-200 hover:bg-gray-300" data-value="*">*</button>
                    <button class="calc-btn text-gray-800 text-xl p-3 rounded-xl bg-gray-200 hover:bg-gray-300" data-value="backspace"><i class="fa-solid fa-delete-left"></i></button>

                    <!-- Row 2 -->
                    <button class="calc-btn text-gray-800 text-xl p-3 rounded-xl bg-gray-100 hover:bg-gray-200" data-value="7">7</button>
                    <button class="calc-btn text-gray-800 text-xl p-3 rounded-xl bg-gray-100 hover:bg-gray-200" data-value="8">8</button>
                    <button class="calc-btn text-gray-800 text-xl p-3 rounded-xl bg-gray-100 hover:bg-gray-200" data-value="9">9</button>
                    <button class="calc-btn text-gray-800 text-xl p-3 rounded-xl bg-gray-200 hover:bg-gray-300 row-span-2" data-value="-">-</button>

                    <!-- Row 3 -->
                    <button class="calc-btn text-gray-800 text-xl p-3 rounded-xl bg-gray-100 hover:bg-gray-200" data-value="4">4</button>
                    <button class="calc-btn text-gray-800 text-xl p-3 rounded-xl bg-gray-100 hover:bg-gray-200" data-value="5">5</button>
                    <button class="calc-btn text-gray-800 text-xl p-3 rounded-xl bg-gray-100 hover:bg-gray-200" data-value="6">6</button>
                    
                    <!-- Row 4 -->
                    <button class="calc-btn text-gray-800 text-xl p-3 rounded-xl bg-gray-100 hover:bg-gray-200" data-value="1">1</button>
                    <button class="calc-btn text-gray-800 text-xl p-3 rounded-xl bg-gray-100 hover:bg-gray-200" data-value="2">2</button>
                    <button class="calc-btn text-gray-800 text-xl p-3 rounded-xl bg-gray-100 hover:bg-gray-200" data-value="3">3</button>
                    <button class="calc-btn text-gray-800 text-xl p-3 rounded-xl bg-gray-200 hover:bg-gray-300 row-span-2" data-value="+">+</button>
                    
                    <!-- Row 5 -->
                    <button class="calc-btn text-gray-800 text-xl p-3 rounded-xl bg-gray-100 hover:bg-gray-200 col-span-2" data-value="0">0</button>
                    <button class="calc-btn text-gray-800 text-xl p-3 rounded-xl bg-gray-100 hover:bg-gray-200" data-value=".">.</button>
                </div>
            </div>

            <!-- Modal Footer (Submit Button) -->
            <div class="p-4 flex space-x-3 border-t sticky bottom-0 bg-white">
                <button id="modal-cancel-btn" class="w-1/3 p-3 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition duration-150 active:scale-95">å–æ¶ˆ</button>
                <button id="modal-submit-btn" class="w-2/3 p-3 bg-blue-600 text-white font-bold text-lg rounded-xl shadow-lg hover:bg-blue-700 transition duration-150 active:scale-95" data-value="=">
                    å„²å­˜è¨˜éŒ„
                </button>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
        <div class="bg-white p-5 rounded-xl shadow-2xl flex items-center space-x-3">
            <i class="fa-solid fa-spinner fa-spin text-xl text-blue-500"></i>
            <span class="text-gray-700 font-medium">è™•ç†ä¸­...</span>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm transform transition-all duration-300 scale-100">
            <div class="text-center">
                <div id="alert-icon" class="text-4xl mb-3">âš ï¸</div>
                <h4 id="alert-title" class="text-xl font-bold mb-2">æ¨™é¡Œ</h4>
                <p id="alert-msg" class="text-gray-600 mb-4">è¨Šæ¯</p>
                <button onclick="document.getElementById('alert-modal').classList.add('hidden')" 
                        class="w-full p-3 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition duration-150">
                    ç¢ºå®š
                </button>
            </div>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal (New for Delete) -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm transform transition-all duration-300 scale-100">
            <div class="text-center">
                <div class="text-4xl mb-3 text-red-500">ğŸš¨</div>
                <h4 id="confirm-title" class="text-xl font-bold mb-2">ç¢ºèªåˆªé™¤</h4>
                <p id="confirm-msg" class="text-gray-600 mb-4">æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºè¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚</p>
                <div class="flex space-x-3 mt-4">
                    <button onclick="document.getElementById('confirm-modal').classList.add('hidden')"
                            class="w-1/2 p-3 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition duration-150">
                        å–æ¶ˆ
                    </button>
                    <button id="confirm-ok-btn"
                            class="w-1/2 p-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition duration-150">
                        ç¢ºèªåˆªé™¤
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>

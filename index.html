<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„¡åå¸³ç°¿</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Zen Maru Gothic å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* è¨­å®š Zen Maru Gothic ç‚ºä¸»è¦å­—é«” */
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #f8f8f8;
        }
        .app-container {
            max-width: 420px; /* æ¨¡æ“¬æ‰‹æ©Ÿå¯¬åº¦ */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            min-height: 100vh;
        }
        /* è‡ªå®šç¾©é¡è‰² */
        .btn-primary {
            background-color: #4CAF50; /* ç¶ è‰² */
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #45a049;
        }
        .text-accent {
            color: #FF6B6B; /* æ”¯å‡ºç´… */
        }
        .nav-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="flex justify-center items-start min-h-screen">
    <div id="app" class="app-container bg-white">
        <!-- æ‡‰ç”¨ç¨‹å¼å…§å®¹å°‡ç”± JavaScript æ¸²æŸ“ -->
    </div>

    <!-- æ¨¡æ…‹æ¡†å®¹å™¨ -->
    <div id="modal-container"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, setDoc, getDoc, updateDoc, deleteDoc, query, where, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firebase æ—¥èªŒç´šåˆ¥
        setLogLevel('Debug');

        // --- å…¨åŸŸè®Šæ•¸å’Œ Firebase åˆå§‹åŒ– ---
        const appElement = document.getElementById('app');
        const modalContainer = document.getElementById('modal-container');
        let db, auth, userId;
        let isAuthReady = false;

        // å¾ Canvas ç’°å¢ƒè®Šæ•¸ç²å–é…ç½®
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify({
            apiKey: "AIzaSyBJcP4HOoVFnbzLT-jdnrW1AtAWXVfjEaM",
            authDomain: "my-expense-tracker-574dd.firebaseapp.com",
            projectId: "my-expense-tracker-574dd",
            storageBucket: "my-expense-tracker-574dd.firebasestorage.app",
            messagingSenderId: "514938495732",
            appId: "1:514938495732:web:bb3529eca4f2db547b74a1",
        }));

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
        }

        const dbPath = (collectionName) => `/artifacts/${appId}/users/${userId}/${collectionName}`;

        // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
        let state = {
            currentPage: 'quickLog', // 'login', 'quickLog', 'history', 'summary', 'settings'
            expenses: [],
            categories: [], // {id, name, budget, color}
            paymentMethods: ['ç¾é‡‘', 'ä¿¡ç”¨å¡'],
            calculator: {
                isVisible: false,
                currentInput: '',
                targetInputId: '',
            },
            isEditing: false,
            editRecord: null,
        };

        // --- èªè­‰æµç¨‹ ---

        // è™•ç† Canvas é è¨­èªè­‰æˆ–åŒ¿åèªè­‰
        async function handleInitialAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("åˆå§‹èªè­‰å¤±æ•—:", error);
                await signInAnonymously(auth); // ç¢ºä¿å§‹çµ‚æœ‰ä¸€å€‹ç”¨æˆ¶
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                console.log("ç”¨æˆ¶å·²ç™»å…¥, UID:", userId);
                if (!isAuthReady) {
                    isAuthReady = true;
                    // åªæœ‰åœ¨é¦–æ¬¡èªè­‰å®Œæˆæ™‚æ‰åˆ‡æ›åˆ°ä¸»é é¢
                    state.currentPage = 'quickLog';
                    loadInitialData();
                }
            } else {
                console.log("ç”¨æˆ¶å·²ç™»å‡ºæˆ–æœªèªè­‰");
                userId = null;
                isAuthReady = true;
                state.currentPage = 'login';
                renderApp();
            }
        });

        if (typeof __initial_auth_token !== 'undefined') {
             handleInitialAuth(); // å•Ÿå‹•åˆå§‹èªè­‰æµç¨‹
        }


        // --- Firestore æ•¸æ“šæ“ä½œ ---

        // è¼‰å…¥åˆå§‹æ•¸æ“š (è¨­å®šå’Œæ”¯å‡º)
        function loadInitialData() {
            if (!isAuthReady || !userId) return;

            // 1. ç›£è½è¨­å®š (åˆ†é¡å’Œæ”¯ä»˜æ–¹å¼)
            const settingsRef = doc(db, dbPath('settings'), 'config');
            onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    state.categories = data.categories || [];
                    state.paymentMethods = data.paymentMethods || ['ç¾é‡‘', 'ä¿¡ç”¨å¡'];
                } else {
                    // é¦–æ¬¡ä½¿ç”¨ï¼Œè¨­å®šé è¨­å€¼
                    console.log("åˆå§‹åŒ–ä½¿ç”¨è€…è¨­å®š...");
                    setDoc(settingsRef, {
                        categories: [
                            { id: crypto.randomUUID(), name: 'é¤é£²', budget: 10000, color: '#FF6B6B' },
                            { id: crypto.randomUUID(), name: 'äº¤é€š', budget: 5000, color: '#4ECDC4' },
                            { id: crypto.randomUUID(), name: 'å¨›æ¨‚', budget: 3000, color: '#4F5D75' },
                        ],
                        paymentMethods: ['ç¾é‡‘', 'ä¿¡ç”¨å¡', 'å…¶ä»–'],
                        lastUpdated: serverTimestamp()
                    });
                }
                renderApp();
            }, (error) => console.error("ç›£è½è¨­å®šå¤±æ•—:", error));

            // 2. ç›£è½æ”¯å‡ºç´€éŒ„ (æŒ‰æ—¥æœŸæ’åº)
            const expensesQuery = query(collection(db, dbPath('expenses')), orderBy('date', 'desc'));
            onSnapshot(expensesQuery, (snapshot) => {
                state.expenses = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    date: doc.data().date.toDate(), // å°‡ Timestamp è½‰æ›ç‚º Date ç‰©ä»¶
                    amount: parseFloat(doc.data().amount) // ç¢ºä¿é‡‘é¡æ˜¯æ•¸å­—
                }));
                renderApp();
            }, (error) => console.error("ç›£è½æ”¯å‡ºç´€éŒ„å¤±æ•—:", error));
        }

        // å„²å­˜æˆ–æ›´æ–°æ”¯å‡ºç´€éŒ„
        async function saveExpense(expenseData, recordId = null) {
            try {
                // è½‰æ› Date ç‰©ä»¶ç‚º Firestore Timestamp
                expenseData.date = new Date(expenseData.date);
                expenseData.amount = parseFloat(expenseData.amount);

                if (recordId) {
                    const docRef = doc(db, dbPath('expenses'), recordId);
                    await updateDoc(docRef, expenseData);
                    showToast('ç´€éŒ„å·²æ›´æ–°ï¼', 'success');
                } else {
                    await setDoc(doc(collection(db, dbPath('expenses'))), {
                        ...expenseData,
                        createdAt: serverTimestamp()
                    });
                    showToast('ç´€éŒ„å·²å„²å­˜ï¼', 'success');
                }

                // æª¢æŸ¥é ç®—ä¸¦ç™¼å‡ºæé†’
                checkBudgetAlert(expenseData.categoryId, expenseData.date);

                state.isEditing = false;
                state.editRecord = null;
                navigate('quickLog'); // è¿”å› QuickLog æˆ– History é é¢
            } catch (e) {
                console.error("å„²å­˜/æ›´æ–°ç´€éŒ„å¤±æ•—:", e);
                showToast('å„²å­˜/æ›´æ–°ç´€éŒ„å¤±æ•—!', 'error');
            }
        }

        // åˆªé™¤æ”¯å‡ºç´€éŒ„
        async function deleteExpense(recordId) {
            try {
                await deleteDoc(doc(db, dbPath('expenses'), recordId));
                showToast('ç´€éŒ„å·²åˆªé™¤', 'success');
            } catch (e) {
                console.error("åˆªé™¤ç´€éŒ„å¤±æ•—:", e);
                showToast('åˆªé™¤ç´€éŒ„å¤±æ•—', 'error');
            }
        }

        // æ›´æ–°åˆ†é¡è¨­å®š
        async function updateCategories(newCategories) {
            try {
                const settingsRef = doc(db, dbPath('settings'), 'config');
                await updateDoc(settingsRef, {
                    categories: newCategories,
                    lastUpdated: serverTimestamp()
                });
                showToast('åˆ†é¡é ç®—å·²æ›´æ–°ï¼', 'success');
            } catch (e) {
                console.error("æ›´æ–°åˆ†é¡å¤±æ•—:", e);
                showToast('æ›´æ–°åˆ†é¡å¤±æ•—!', 'error');
            }
        }

        // --- æ ¸å¿ƒæ‡‰ç”¨é‚è¼¯ ---

        // è¨ˆç®—æŒ‡å®šåˆ†é¡å’Œæœˆä»½çš„ç¸½æ”¯å‡º
        function calculateMonthlySpending(categoryId, date) {
            const targetMonth = date.getFullYear() * 12 + date.getMonth();
            const total = state.expenses
                .filter(exp => {
                    const expMonth = exp.date.getFullYear() * 12 + exp.date.getMonth();
                    return exp.categoryId === categoryId && expMonth === targetMonth;
                })
                .reduce((sum, exp) => sum + exp.amount, 0);
            return total;
        }

        // æª¢æŸ¥é ç®—ä¸¦å½ˆå‡ºæé†’
        function checkBudgetAlert(categoryId, date) {
            const category = state.categories.find(c => c.id === categoryId);
            if (!category || !category.budget || category.budget <= 0) return;

            const totalSpent = calculateMonthlySpending(categoryId, date);
            const budget = category.budget;
            const percentage = (totalSpent / budget) * 100;

            let message = '';
            let title = 'é ç®—æé†’';

            if (percentage >= 100) {
                message = `æ‚¨å·²è¶…å‡º ${category.name} åˆ†é¡æœ¬æœˆçš„é ç®— ${budget} å…ƒï¼ç•¶æœˆå·²èŠ±è²» ${totalSpent.toFixed(0)} å…ƒã€‚`;
                title = 'ğŸš¨ é ç®—è¶…æ”¯è­¦å‘Š';
            } else if (percentage >= 90) {
                message = `æ‚¨åœ¨ ${category.name} åˆ†é¡æœ¬æœˆå·²èŠ±è²» ${totalSpent.toFixed(0)} å…ƒï¼Œå·²é”åˆ°é ç®—çš„ 90%ï¼`;
                title = 'âš ï¸ é ç®—æ¥è¿‘è­¦å‘Š';
            } else if (percentage >= 70) {
                message = `æ‚¨åœ¨ ${category.name} åˆ†é¡æœ¬æœˆå·²èŠ±è²» ${totalSpent.toFixed(0)} å…ƒï¼Œå·²é”åˆ°é ç®—çš„ 70%ã€‚`;
            } else if (percentage >= 50) {
                message = `æ‚¨åœ¨ ${category.name} åˆ†é¡æœ¬æœˆå·²èŠ±è²» ${totalSpent.toFixed(0)} å…ƒï¼Œå·²é”åˆ°é ç®—çš„ 50%ã€‚`;
            }

            if (message) {
                showModal(title, message, null, true);
            }
        }

        // --- UI çµ„ä»¶åŠæ¸²æŸ“ ---

        function navigate(page) {
            state.currentPage = page;
            renderApp();
        }

        // æ¨¡æ…‹æ¡† (æ›¿ä»£ alert/confirm)
        function showModal(title, content, onConfirm = null, isAlert = false) {
            const modalHtml = `
                <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                    <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm">
                        <h3 class="text-xl font-bold mb-4">${title}</h3>
                        <p class="mb-6">${content}</p>
                        <div class="flex justify-end space-x-3">
                            ${!isAlert ? `<button id="modal-cancel" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg">å–æ¶ˆ</button>` : ''}
                            <button id="modal-confirm" class="px-4 py-2 text-white rounded-lg ${onConfirm ? 'btn-primary' : 'bg-gray-500'}">
                                ${onConfirm ? 'ç¢ºèª' : 'é—œé–‰'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalHtml;

            const closeModal = () => modalContainer.innerHTML = '';

            document.getElementById('modal-confirm').onclick = () => {
                if (onConfirm) onConfirm();
                closeModal();
            };
            if (!isAlert) {
                document.getElementById('modal-cancel').onclick = closeModal;
            }
        }

        // ç°¡æ˜“ Toast æç¤º
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-20 left-1/2 transform -translate-x-1/2 p-3 rounded-xl text-white shadow-lg transition-opacity duration-300 z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        // åº•éƒ¨å°èˆªæ¬„
        function renderNavBar() {
            if (state.currentPage === 'login') return '';
            const navItems = [
                { id: 'quickLog', icon: 'ğŸ“', label: 'å¿«é€Ÿè¨˜å¸³' },
                { id: 'history', icon: 'ğŸ“œ', label: 'ç´€éŒ„' },
                { id: 'summary', icon: 'ğŸ“ˆ', label: 'ç¸½è¦½' },
                { id: 'settings', icon: 'âš™ï¸', label: 'è¨­å®š' },
            ];

            return `
                <nav class="fixed bottom-0 w-full max-w-[420px] bg-white border-t border-gray-200 shadow-xl z-10">
                    <div class="flex justify-around h-16">
                        ${navItems.map(item => `
                            <button onclick="window.navigate('${item.id}')"
                                class="flex flex-col items-center justify-center text-xs w-1/4 pt-1 ${state.currentPage === item.id ? 'text-green-600 font-bold' : 'text-gray-500'}">
                                <span class="text-xl">${item.icon}</span>
                                <span>${item.label}</span>
                            </button>
                        `).join('')}
                    </div>
                </nav>
            `;
        }

        // è¨ˆç®—æ©Ÿæ¨¡æ…‹æ¡†
        function renderCalculatorModal() {
            if (!state.calculator.isVisible) return '';

            const calDisplay = state.calculator.currentInput || '0';
            const buttons = [
                '7', '8', '9', 'C',
                '4', '5', '6', '+',
                '1', '2', '3', '-',
                '0', '.', '=', 'OK'
            ];

            return `
                <div class="fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-50">
                    <div class="bg-white p-4 rounded-xl shadow-2xl w-11/12 max-w-xs">
                        <div class="text-right text-3xl font-light mb-3 p-2 bg-gray-100 rounded-lg">${calDisplay}</div>
                        <div class="grid grid-cols-4 gap-2">
                            ${buttons.map(btn => `
                                <button data-value="${btn}" class="calc-btn p-3 rounded-lg text-lg font-bold
                                    ${btn === 'OK' ? 'col-span-1 bg-green-500 text-white' : btn === 'C' ? 'bg-red-200 text-red-700' : btn === '=' ? 'bg-blue-200 text-blue-700' : 'bg-gray-100 hover:bg-gray-200'}">
                                    ${btn}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“ç™»å…¥/è¨»å†Šé é¢
        function renderLoginPage() {
            return `
                <div class="p-6 pt-16 flex flex-col items-center">
                    <h1 class="text-4xl font-bold mb-10 text-green-600">Zen è¨˜å¸³æœ¬</h1>
                    <div class="w-full max-w-sm">
                        <input id="email-input" type="email" placeholder="é›»å­éƒµä»¶" class="w-full p-3 mb-4 border border-gray-300 rounded-xl focus:border-green-500 focus:ring focus:ring-green-200" required>
                        <input id="password-input" type="password" placeholder="å¯†ç¢¼" class="w-full p-3 mb-6 border border-gray-300 rounded-xl focus:border-green-500 focus:ring focus:ring-green-200" required>
                        <button id="login-btn" class="w-full p-3 btn-primary font-bold rounded-xl mb-3">ç™»å…¥</button>
                        <button id="signup-btn" class="w-full p-3 bg-gray-200 text-gray-700 font-bold rounded-xl">è¨»å†Šæ–°å¸³è™Ÿ</button>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“å¿«é€Ÿè¨˜å¸³/æ–°å¢ç´€éŒ„é é¢
        function renderQuickLogPage() {
            const today = new Date().toISOString().split('T')[0];
            const isEditing = state.isEditing;
            const record = state.editRecord || {};
            const initialAmount = record.amount || 0;

            const categoryOptions = state.categories.map(c =>
                `<option value="${c.id}" ${record.categoryId === c.id ? 'selected' : ''}>${c.name}</option>`
            ).join('');

            const paymentOptions = state.paymentMethods.map(p =>
                `<option value="${p}" ${record.paymentMethod === p ? 'selected' : ''}>${p}</option>`
            ).join('');

            // é ‚éƒ¨ç¸½è¦½
            const totalThisMonth = calculateMonthlySpending(null, new Date());
            let currentMonth = new Date().toLocaleString('zh-TW', { month: 'long', year: 'numeric' });
            let budgetStatus = 'ç„¡é ç®—è³‡è¨Š';
            let totalBudget = state.categories.reduce((sum, c) => sum + (c.budget || 0), 0);
            let budgetSpentPercent = totalBudget > 0 ? (totalThisMonth / totalBudget) * 100 : 0;
            if (totalBudget > 0) {
                budgetStatus = `ç¸½é ç®—å·²èŠ±è²» ${budgetSpentPercent.toFixed(0)}%`;
            }

            return `
                <div class="p-5 pb-20">
                    <!-- é ‚éƒ¨ç¸½è¦½ -->
                    <div class="bg-green-600 text-white p-4 rounded-xl mb-6 shadow-md">
                        <h2 class="text-lg font-light">${currentMonth} ç¸½æ”¯å‡º</h2>
                        <p class="text-4xl font-bold mb-1">NT$ ${totalThisMonth.toLocaleString('zh-TW')}</p>
                        <p class="text-sm">${budgetStatus}</p>
                    </div>

                    <!-- è¨˜å¸³è¡¨å–® -->
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">${isEditing ? 'ç·¨è¼¯ç´€éŒ„' : 'å¿«é€Ÿè¨˜å¸³'}</h2>
                    <form id="expense-form" class="space-y-4">
                        <input type="hidden" id="record-id" value="${record.id || ''}">
                        
                        <!-- æ—¥æœŸ -->
                        <div>
                            <label for="date" class="text-sm text-gray-500 block mb-1">æ—¥æœŸ</label>
                            <input type="date" id="date" name="date" value="${record.date ? record.date.toISOString().split('T')[0] : today}" class="w-full p-3 border border-gray-300 rounded-xl" required>
                        </div>
                        
                        <!-- é‡‘é¡ (å¯é»æ“Šè¼¸å…¥) -->
                        <div>
                            <label for="amount" class="text-sm text-gray-500 block mb-1">é‡‘é¡</label>
                            <div class="relative">
                                <input type="number" id="amount" name="amount" value="${initialAmount}" 
                                    class="w-full p-3 text-2xl font-bold text-accent border border-gray-300 rounded-xl pr-12" required
                                    min="0.01" step="0.01" readonly>
                                <button type="button" id="open-calculator-btn" class="absolute inset-y-0 right-0 p-3 flex items-center justify-center text-gray-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25m-4.5 9V5.25A2.25 2.25 0 0 0 10.5 3h-1.5a2.25 2.25 0 0 0-2.25 2.25v7.5a2.25 2.25 0 0 0 2.25 2.25h.75m4.5-9V5.25A2.25 2.25 0 0 0 16.5 3h-1.5a2.25 2.25 0 0 0-2.25 2.25v7.5a2.25 2.25 0 0 0 2.25 2.25h.75m4.5-9V5.25A2.25 2.25 0 0 0 21 3h-1.5a2.25 2.25 0 0 0-2.25 2.25v7.5a2.25 2.25 0 0 0 2.25 2.25h.75M9 15.75V18a2.25 2.25 0 0 0 2.25 2.25h1.5A2.25 2.25 0 0 0 15 18v-2.25" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- åˆ†é¡ -->
                        <div>
                            <label for="category-id" class="text-sm text-gray-500 block mb-1">åˆ†é¡</label>
                            <select id="category-id" name="categoryId" class="w-full p-3 border border-gray-300 rounded-xl" required>
                                <option value="">--- é¸æ“‡åˆ†é¡ ---</option>
                                ${categoryOptions}
                            </select>
                        </div>
                        
                        <!-- æ”¯ä»˜æ–¹å¼ -->
                        <div>
                            <label for="payment-method" class="text-sm text-gray-500 block mb-1">æ”¯ä»˜æ–¹å¼</label>
                            <select id="payment-method" name="paymentMethod" class="w-full p-3 border border-gray-300 rounded-xl" required>
                                ${paymentOptions}
                            </select>
                        </div>
                        
                        <!-- å‚™è¨» -->
                        <div>
                            <label for="note" class="text-sm text-gray-500 block mb-1">å‚™è¨» (éå¿…å¡«)</label>
                            <input type="text" id="note" name="note" value="${record.note || ''}" placeholder="ä¾‹å¦‚ï¼šæ™šé¤è²»ç”¨ã€è»Šç¥¨" class="w-full p-3 border border-gray-300 rounded-xl">
                        </div>
                        
                        <!-- å„²å­˜æŒ‰éˆ• -->
                        <button type="submit" class="w-full p-4 btn-primary font-bold rounded-xl text-lg shadow-md mt-6">
                            ${isEditing ? 'æ›´æ–°ç´€éŒ„' : 'å„²å­˜ç´€éŒ„'}
                        </button>
                        
                        ${isEditing ? `
                            <button type="button" onclick="window.cancelEdit()" class="w-full p-3 bg-gray-200 text-gray-700 font-bold rounded-xl mt-2">
                                å–æ¶ˆç·¨è¼¯
                            </button>
                        ` : ''}
                    </form>
                </div>
            `;
        }
        
        // æ¸²æŸ“æ­·å²ç´€éŒ„é é¢
        function renderHistoryPage() {
            if (state.expenses.length === 0) {
                return `<div class="p-6 text-center pt-20 text-gray-500">å°šç„¡æ”¯å‡ºç´€éŒ„ã€‚</div>`;
            }

            const getCategory = (id) => state.categories.find(c => c.id === id) || { name: 'æœªçŸ¥åˆ†é¡', color: '#ccc' };

            // æŒ‰æ—¥æœŸåˆ†çµ„
            const groupedExpenses = state.expenses.reduce((acc, exp) => {
                const dateStr = exp.date.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
                if (!acc[dateStr]) {
                    acc[dateStr] = [];
                }
                acc[dateStr].push(exp);
                return acc;
            }, {});
            
            const historyListHtml = Object.keys(groupedExpenses).map(dateStr => {
                const dailyTotal = groupedExpenses[dateStr].reduce((sum, exp) => sum + exp.amount, 0);
                const recordsHtml = groupedExpenses[dateStr].map(exp => {
                    const category = getCategory(exp.categoryId);
                    return `
                        <div class="flex items-center justify-between py-3 border-b border-gray-100 last:border-b-0">
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-gray-800 flex items-center">
                                    <span class="inline-block w-2 h-2 mr-2 rounded-full" style="background-color: ${category.color};"></span>
                                    ${category.name}
                                </p>
                                <p class="text-sm text-gray-500 truncate">${exp.note || 'ç„¡å‚™è¨»'}</p>
                            </div>
                            <div class="text-right ml-4">
                                <p class="font-bold text-accent">- NT$ ${exp.amount.toLocaleString('zh-TW')}</p>
                                <p class="text-xs text-gray-400">${exp.paymentMethod}</p>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button onclick="window.startEdit('${exp.id}')" class="text-blue-500 hover:text-blue-700 p-1 rounded-full bg-blue-50">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                </button>
                                <button onclick="window.confirmDelete('${exp.id}')" class="text-red-500 hover:text-red-700 p-1 rounded-full bg-red-50">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.86 11.14A2 2 0 0116.14 20H7.86a2 2 0 01-1.99-1.86L5 7m5 4v6m4-6v6m-4-10h4m-8 0h12" /></svg>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="mb-6 p-4 bg-white rounded-xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center pb-2 border-b-2 border-gray-200">
                            <h3 class="text-lg font-bold text-gray-700">${dateStr}</h3>
                            <p class="font-bold text-accent">- NT$ ${dailyTotal.toLocaleString('zh-TW')}</p>
                        </div>
                        <div class="divide-y divide-gray-100">
                            ${recordsHtml}
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="p-5 pb-20">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">æ­·å²ç´€éŒ„</h1>
                    <div id="history-list">${historyListHtml}</div>
                </div>
            `;
        }

        // æ¸²æŸ“ç¸½è¦½é é¢
        function renderSummaryPage() {
            // ç¸½è¦½é‚è¼¯
            const monthlyTotals = state.expenses.reduce((acc, exp) => {
                const monthKey = exp.date.getFullYear() + '-' + (exp.date.getMonth() + 1).toString().padStart(2, '0');
                acc[monthKey] = (acc[monthKey] || 0) + exp.amount;
                return acc;
            }, {});

            const monthlyHtml = Object.keys(monthlyTotals).sort().reverse().map(monthKey => `
                <div class="flex justify-between items-center p-4 bg-white rounded-xl shadow-sm mb-3">
                    <span class="text-lg font-semibold text-gray-700">${monthKey}</span>
                    <span class="text-xl font-bold text-accent">- NT$ ${monthlyTotals[monthKey].toLocaleString('zh-TW')}</span>
                </div>
            `).join('');

            // å¹´åº¦ç¸½æ”¯å‡º
            const yearlyTotals = state.expenses.reduce((acc, exp) => {
                const yearKey = exp.date.getFullYear().toString();
                acc[yearKey] = (acc[yearKey] || 0) + exp.amount;
                return acc;
            }, {});

            const yearlyHtml = Object.keys(yearlyTotals).sort().reverse().map(yearKey => `
                <div class="flex justify-between items-center p-4 bg-white rounded-xl shadow-sm mb-3 border-l-4 border-blue-500">
                    <span class="text-xl font-bold text-blue-600">${yearKey} ç¸½æ”¯å‡º</span>
                    <span class="text-2xl font-extrabold text-accent">- NT$ ${yearlyTotals[yearKey].toLocaleString('zh-TW')}</span>
                </div>
            `).join('');


            return `
                <div class="p-5 pb-20">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">æ”¯å‡ºç¸½è¦½</h1>
                    
                    <h2 class="text-2xl font-bold mb-4 text-blue-600">å¹´åº¦ç¸½çµ</h2>
                    <div class="space-y-3 mb-8">${yearlyHtml || '<p class="text-gray-500">å°šç„¡å¹´åº¦æ•¸æ“š</p>'}</div>

                    <h2 class="text-2xl font-bold mb-4 text-gray-800">æ¯æœˆç¸½çµ</h2>
                    <div class="space-y-3">${monthlyHtml || '<p class="text-gray-500">å°šç„¡æœˆä»½æ•¸æ“š</p>'}</div>
                </div>
            `;
        }

        // æ¸²æŸ“è¨­å®š/åˆ†é¡é ç®—é é¢
        function renderSettingsPage() {
            const categoryListHtml = state.categories.map(c => {
                const totalSpent = calculateMonthlySpending(c.id, new Date());
                const budget = c.budget || 0;
                const percent = budget > 0 ? (totalSpent / budget) * 100 : 0;
                const progressBarWidth = Math.min(percent, 100);
                const progressBarColor = percent > 90 ? 'bg-red-500' : percent > 70 ? 'bg-orange-500' : percent > 50 ? 'bg-yellow-500' : 'bg-green-500';

                return `
                    <div class="bg-white p-4 rounded-xl shadow-sm mb-3 border border-gray-100" data-category-id="${c.id}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <p class="text-lg font-bold flex items-center">
                                    <span class="inline-block w-3 h-3 mr-2 rounded-full" style="background-color: ${c.color || '#ccc'};"></span>
                                    ${c.name}
                                </p>
                                <p class="text-sm text-gray-500">æœ¬æœˆèŠ±è²»: NT$ ${totalSpent.toLocaleString('zh-TW')} / é ç®—: NT$ ${budget.toLocaleString('zh-TW')}</p>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button onclick="window.editCategory('${c.id}')" class="text-blue-500 hover:text-blue-700 p-1">ç·¨è¼¯</button>
                                <button onclick="window.confirmDeleteCategory('${c.id}')" class="text-red-500 hover:text-red-700 p-1">åˆªé™¤</button>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="${progressBarColor} h-2.5 rounded-full" style="width: ${progressBarWidth}%;"></div>
                        </div>
                        <p class="text-xs text-right mt-1 text-gray-500">${percent.toFixed(1)}%</p>
                    </div>
                `;
            }).join('');

            // æ”¯ä»˜æ–¹å¼åˆ—è¡¨
            const paymentMethodsHtml = state.paymentMethods.map(p => `
                <span class="inline-block bg-gray-100 text-gray-700 text-sm px-3 py-1 rounded-full mr-2 mb-2">${p}</span>
            `).join('');

            return `
                <div class="p-5 pb-20">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">è¨­å®šèˆ‡é ç®—</h1>

                    <button id="logout-btn" class="float-right bg-red-100 text-red-600 px-3 py-1 text-sm rounded-xl font-bold">ç™»å‡º</button>
                    <h2 class="text-2xl font-bold mb-4 text-green-600">æ”¯å‡ºåˆ†é¡èˆ‡é ç®—</h2>
                    <div id="category-list" class="mb-8">
                        ${categoryListHtml}
                    </div>
                    
                    <button onclick="window.openAddCategoryModal()" class="w-full p-3 bg-blue-100 text-blue-600 font-bold rounded-xl mb-8">
                        + æ–°å¢/ç·¨è¼¯åˆ†é¡
                    </button>

                    <h2 class="text-2xl font-bold mb-4 text-gray-800">æ”¯ä»˜æ–¹å¼ (å¾…å¯¦ä½œç·¨è¼¯)</h2>
                    <div class="mb-6">
                        ${paymentMethodsHtml}
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“æ•´å€‹æ‡‰ç”¨ç¨‹å¼
        function renderApp() {
            let contentHtml = '';
            const page = state.currentPage;

            if (!isAuthReady) {
                 contentHtml = `<div class="p-10 text-center text-gray-500 pt-20">è¼‰å…¥ä¸­...</div>`;
            } else if (page === 'login' || !userId) {
                contentHtml = renderLoginPage();
            } else {
                switch (page) {
                    case 'quickLog':
                        contentHtml = renderQuickLogPage();
                        break;
                    case 'history':
                        contentHtml = renderHistoryPage();
                        break;
                    case 'summary':
                        contentHtml = renderSummaryPage();
                        break;
                    case 'settings':
                        contentHtml = renderSettingsPage();
                        break;
                    default:
                        contentHtml = renderQuickLogPage();
                }
            }

            appElement.innerHTML = `
                <div class="relative w-full h-full">
                    ${contentHtml}
                    ${renderNavBar()}
                </div>
            `;
            modalContainer.innerHTML = renderCalculatorModal();

            // é‡æ–°é™„åŠ äº‹ä»¶ç›£è½å™¨
            attachEventListeners(page);
        }


        // --- äº‹ä»¶ç›£è½å™¨èˆ‡è™•ç†å‡½æ•¸ ---

        function attachEventListeners(page) {
            // ç™»å…¥/è¨»å†Šäº‹ä»¶
            if (page === 'login') {
                document.getElementById('login-btn')?.addEventListener('click', handleLogin);
                document.getElementById('signup-btn')?.addEventListener('click', handleSignUp);
            }
            
            // QuickLog/Form äº‹ä»¶
            if (page === 'quickLog') {
                const form = document.getElementById('expense-form');
                if (form) {
                    form.addEventListener('submit', handleExpenseFormSubmit);
                    // é»æ“Šé‡‘é¡æ¬„ä½æˆ–æŒ‰éˆ•é–‹å•Ÿè¨ˆç®—æ©Ÿ
                    document.getElementById('amount')?.addEventListener('click', () => openCalculator('amount'));
                    document.getElementById('open-calculator-btn')?.addEventListener('click', (e) => {
                        e.preventDefault();
                        openCalculator('amount');
                    });
                }
            }

            // è¨­å®šé é¢äº‹ä»¶
            if (page === 'settings') {
                document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
            }

            // è¨ˆç®—æ©Ÿäº‹ä»¶
            if (state.calculator.isVisible) {
                document.querySelectorAll('.calc-btn').forEach(button => {
                    button.addEventListener('click', handleCalculatorInput);
                });
            }
        }

        // ç™»å…¥è™•ç†
        async function handleLogin() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            if (!email || !password) return showToast('è«‹è¼¸å…¥éƒµä»¶å’Œå¯†ç¢¼', 'error');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast('ç™»å…¥æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error("ç™»å…¥å¤±æ•—:", error);
                showToast('ç™»å…¥å¤±æ•—: ' + error.message, 'error');
            }
        }

        // è¨»å†Šè™•ç†
        async function handleSignUp() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            if (password.length < 6) return showToast('å¯†ç¢¼é•·åº¦éœ€è‡³å°‘ç‚º 6 ä½', 'error');

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showToast('è¨»å†ŠæˆåŠŸï¼å·²è‡ªå‹•ç™»å…¥ã€‚', 'success');
            } catch (error) {
                console.error("è¨»å†Šå¤±æ•—:", error);
                showToast('è¨»å†Šå¤±æ•—: ' + error.message, 'error');
            }
        }

        // ç™»å‡ºè™•ç†
        async function handleLogout() {
            try {
                await signOut(auth);
                showToast('ç™»å‡ºæˆåŠŸ', 'success');
                navigate('login');
            } catch (error) {
                console.error("ç™»å‡ºå¤±æ•—:", error);
                showToast('ç™»å‡ºå¤±æ•—: ' + error.message, 'error');
            }
        }


        // è¡¨å–®æäº¤è™•ç†
        function handleExpenseFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const recordId = form.elements['record-id'].value;
            const amountVal = form.elements['amount'].value;

            if (parseFloat(amountVal) <= 0) {
                 return showToast('é‡‘é¡å¿…é ˆå¤§æ–¼ 0', 'error');
            }
            
            const expenseData = {
                date: form.elements['date'].value,
                amount: amountVal,
                categoryId: form.elements['categoryId'].value,
                paymentMethod: form.elements['paymentMethod'].value,
                note: form.elements['note'].value.trim(),
            };

            saveExpense(expenseData, recordId || null);
            // é‡ç½®è¡¨å–®
            form.reset();
            form.elements['date'].value = new Date().toISOString().split('T')[0]; // ä¿æŒæ—¥æœŸç‚ºä»Šå¤©
        }

        // æ­·å²ç´€éŒ„ - å•Ÿå‹•ç·¨è¼¯æ¨¡å¼
        window.startEdit = (recordId) => {
            const record = state.expenses.find(e => e.id === recordId);
            if (record) {
                state.isEditing = true;
                state.editRecord = {
                    ...record,
                    // ç¢ºä¿æ—¥æœŸæ˜¯ ISO æ ¼å¼å­—ä¸²ï¼Œä»¥ä¾¿å¡«å…¥ input[type="date"]
                    date: record.date.toISOString().split('T')[0] 
                };
                navigate('quickLog');
            }
        };

        // æ­·å²ç´€éŒ„ - å–æ¶ˆç·¨è¼¯æ¨¡å¼
        window.cancelEdit = () => {
            state.isEditing = false;
            state.editRecord = null;
            navigate('quickLog');
        };

        // æ­·å²ç´€éŒ„ - ç¢ºèªåˆªé™¤
        window.confirmDelete = (recordId) => {
            showModal(
                'ç¢ºèªåˆªé™¤',
                'æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºç´€éŒ„å—ï¼Ÿ',
                () => deleteExpense(recordId)
            );
        };
        
        // åˆ†é¡ - é–‹å•Ÿæ–°å¢/ç·¨è¼¯æ¨¡æ…‹æ¡†
        window.openAddCategoryModal = (category = null) => {
            const isEditing = !!category;
            const id = category ? category.id : '';
            const name = category ? category.name : '';
            const budget = category ? category.budget : 0;
            const color = category ? category.color : '#4CAF50';

            const modalContent = `
                <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                    <form id="category-form" class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm">
                        <h3 class="text-xl font-bold mb-4">${isEditing ? 'ç·¨è¼¯åˆ†é¡' : 'æ–°å¢åˆ†é¡'}</h3>
                        <input type="hidden" id="cat-id" value="${id}">
                        
                        <label class="block mb-2 text-sm text-gray-600">åˆ†é¡åç¨±</label>
                        <input type="text" id="cat-name" value="${name}" placeholder="ä¾‹å¦‚ï¼šé¤é£²" class="w-full p-3 mb-4 border border-gray-300 rounded-xl" required>

                        <label class="block mb-2 text-sm text-gray-600">æ¯æœˆé ç®— (NT$)</label>
                        <input type="number" id="cat-budget" value="${budget}" min="0" step="100" class="w-full p-3 mb-4 border border-gray-300 rounded-xl" required>

                        <label class="block mb-2 text-sm text-gray-600">ä»£è¡¨é¡è‰²</label>
                        <input type="color" id="cat-color" value="${color}" class="w-full h-10 p-1 mb-6 border border-gray-300 rounded-xl">

                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="document.getElementById('modal-container').innerHTML=''" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg">å–æ¶ˆ</button>
                            <button type="submit" class="px-4 py-2 text-white btn-primary rounded-lg">${isEditing ? 'å„²å­˜è®Šæ›´' : 'æ–°å¢'}</button>
                        </div>
                    </form>
                </div>
            `;
            modalContainer.innerHTML = modalContent;
            
            // é™„åŠ è¡¨å–®æäº¤äº‹ä»¶
            document.getElementById('category-form').addEventListener('submit', handleCategoryFormSubmit);
        };
        
        // åˆ†é¡ - ç·¨è¼¯
        window.editCategory = (categoryId) => {
            const category = state.categories.find(c => c.id === categoryId);
            if (category) {
                window.openAddCategoryModal(category);
            }
        };

        // åˆ†é¡ - è¡¨å–®æäº¤è™•ç†
        function handleCategoryFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const id = form.elements['cat-id'].value || crypto.randomUUID();
            const name = form.elements['cat-name'].value;
            const budget = parseInt(form.elements['cat-budget'].value, 10);
            const color = form.elements['cat-color'].value;
            
            let newCategories = [...state.categories];
            const existingIndex = newCategories.findIndex(c => c.id === id);

            const newCategoryData = { id, name, budget, color };

            if (existingIndex !== -1) {
                newCategories[existingIndex] = newCategoryData; // æ›´æ–°
            } else {
                newCategories.push(newCategoryData); // æ–°å¢
            }
            
            updateCategories(newCategories);
            document.getElementById('modal-container').innerHTML = ''; // é—œé–‰æ¨¡æ…‹æ¡†
        }

        // åˆ†é¡ - ç¢ºèªåˆªé™¤
        window.confirmDeleteCategory = (categoryId) => {
            showModal(
                'ç¢ºèªåˆªé™¤åˆ†é¡',
                'åˆªé™¤åˆ†é¡ä¸æœƒåˆªé™¤ç›¸é—œç´€éŒ„ï¼Œä½†ç´€éŒ„å°‡é¡¯ç¤ºç‚ºã€ŒæœªçŸ¥åˆ†é¡ã€ã€‚ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ',
                () => {
                    const newCategories = state.categories.filter(c => c.id !== categoryId);
                    updateCategories(newCategories);
                }
            );
        };

        // --- è¨ˆç®—æ©Ÿé‚è¼¯ ---

        function openCalculator(targetId) {
            const currentAmount = document.getElementById(targetId)?.value || '0';
            state.calculator.currentInput = currentAmount === '0' ? '' : currentAmount;
            state.calculator.targetInputId = targetId;
            state.calculator.isVisible = true;
            renderApp();
        }
        
        function handleCalculatorInput(e) {
            e.preventDefault();
            const value = e.target.getAttribute('data-value');
            let current = state.calculator.currentInput;

            switch (value) {
                case 'C':
                    current = '';
                    break;
                case '=':
                    try {
                        // ä½¿ç”¨ eval é€²è¡Œè¨ˆç®—ï¼Œä¸¦å°‡çµæœå››æ¨äº”å…¥åˆ°å°æ•¸é»å¾Œå…©ä½
                        current = eval(current.replace('Ã—', '*').replace('Ã·', '/')).toFixed(2).replace(/\.00$/, '');
                    } catch (e) {
                        current = 'éŒ¯èª¤';
                    }
                    break;
                case 'OK':
                    // 1. åŸ·è¡Œæœ€çµ‚è¨ˆç®— (å¦‚æœé‚„æ²’æŒ‰ =)
                    if (current.match(/[+\-*/]/)) {
                        try {
                           current = eval(current.replace('Ã—', '*').replace('Ã·', '/')).toFixed(2).replace(/\.00$/, '');
                        } catch (e) {
                           current = '0';
                        }
                    } else if (current === '' || current === 'éŒ¯èª¤') {
                        current = '0';
                    }
                    
                    // 2. å‚³è¼¸çµæœåˆ°è¡¨å–®
                    const targetInput = document.getElementById(state.calculator.targetInputId);
                    if (targetInput) {
                        targetInput.value = parseFloat(current).toFixed(2);
                    }
                    
                    // 3. é—œé–‰è¨ˆç®—æ©Ÿ
                    state.calculator.isVisible = false;
                    state.calculator.currentInput = '';
                    break;
                case '+':
                case '-':
                case 'Ã—':
                case 'Ã·':
                    // é¿å…é€£çºŒæ“ä½œç¬¦
                    const lastChar = current.slice(-1);
                    if (['+', '-', 'Ã—', 'Ã·'].includes(lastChar)) {
                        current = current.slice(0, -1) + value;
                    } else if (current !== '' && current !== 'éŒ¯èª¤') {
                        current += value;
                    }
                    break;
                case '.':
                    // æª¢æŸ¥ç•¶å‰æ•¸å­—ä¸­æ˜¯å¦å·²æœ‰å°æ•¸é»
                    const parts = current.split(/[+\-*/]/);
                    const lastPart = parts[parts.length - 1];
                    if (!lastPart.includes('.')) {
                        current += value;
                    }
                    break;
                default: // æ•¸å­—
                    if (current === 'éŒ¯èª¤') current = '';
                    current += value;
                    break;
            }

            state.calculator.currentInput = current;
            renderApp();
        }

        // å°‡ navigate å‡½æ•¸æš´éœ²çµ¦å…¨åŸŸ window
        window.navigate = navigate;
        
        // é¦–æ¬¡æ¸²æŸ“æ‡‰ç”¨ç¨‹å¼
        // ç”±æ–¼ onAuthStateChanged æœƒåœ¨åˆå§‹åŒ–å¾Œè§¸ç™¼ï¼Œæˆ‘å€‘åªéœ€ç¢ºä¿åˆå§‹èªè­‰é‚è¼¯å•Ÿå‹•å³å¯ã€‚
        // å¦‚æœæ²’æœ‰å•Ÿå‹•èªè­‰æµç¨‹ï¼Œå‰‡å…ˆæ¸²æŸ“ç™»å…¥é é¢
        if (typeof __initial_auth_token === 'undefined') {
            renderApp();
        }
    </script>
</body>
</html>

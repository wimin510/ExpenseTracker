<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>紀錄儲存應用程式</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div id="app-container" class="max-w-3xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10 transition-all duration-300">
        <h1 class="text-3xl font-bold text-center text-blue-700 mb-6">我的即時紀錄本</h1>
        
        <!-- 訊息提示區域 -->
        <div id="message-area" class="mb-4"></div>

        <!-- 使用者 ID 顯示 (用於協助除錯路徑) -->
        <p id="user-id-display" class="text-sm text-gray-500 mb-6 text-center"></p>

        <!-- 紀錄輸入區塊 -->
        <div class="mb-8 p-4 bg-blue-50 rounded-lg shadow-inner">
            <textarea id="record-input" rows="3" placeholder="在這裡輸入您的新紀錄..." 
                class="w-full p-3 border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150 text-gray-700"></textarea>
            
            <button onclick="addRecord()" id="save-button"
                class="w-full mt-3 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 ease-in-out transform hover:scale-[1.01] disabled:opacity-50"
                disabled>
                儲存新紀錄 (等待初始化...)
            </button>
        </div>

        <!-- 紀錄清單區塊 -->
        <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">已儲存的紀錄</h2>
        <div id="records-list" class="space-y-4">
            <p class="text-center text-gray-400 p-4" id="loading-text">正在載入紀錄...</p>
            <!-- 紀錄將在這裡即時顯示 -->
        </div>

    </div>

    <script type="module">
        // =========================================================
        // 1. Firebase 初始化設定與模組匯入 (必須使用 ES Module 格式)
        // =========================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, setLogLevel, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 必須使用的全域變數
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        
        let db, auth, userId = null;
        let isAuthReady = false;
        
        // 將核心函式暴露給 HTML 呼叫 (確保可以在 onclick 中使用)
        window.addRecord = addRecord;

        /**
         * 顯示自定義訊息（替代 alert()）
         * @param {string} message - 訊息內容
         * @param {'success' | 'error' | 'warning'} type - 訊息類型
         */
        function alertMessage(message, type) {
            const messageArea = document.getElementById('message-area');
            let color = 'bg-blue-100 border-blue-500 text-blue-700';
            if (type === 'error') color = 'bg-red-100 border-red-500 text-red-700';
            if (type === 'success') color = 'bg-green-100 border-green-500 text-green-700';
            if (type === 'warning') color = 'bg-yellow-100 border-yellow-500 text-yellow-700';

            messageArea.innerHTML = `
                <div class="p-3 border-l-4 rounded-lg shadow-md ${color} transition-opacity duration-300" role="alert">
                    <p class="font-bold">${type === 'success' ? '成功' : type === 'error' ? '錯誤' : '注意'}:</p>
                    <p>${message}</p>
                </div>
            `;
            // 自動清除訊息
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        async function initializeFirebase() {
            try {
                // 啟用 Firestore Debug 模式 (方便在 Console 中查看問題)
                setLogLevel('debug');

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 處理身份驗證
                const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 身份驗證狀態監聽
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-id-display').textContent = `使用者 ID: ${userId}`;
                        document.getElementById('save-button').textContent = '儲存新紀錄';
                        document.getElementById('save-button').disabled = false;
                        
                        // 身份驗證完成後，啟動即時資料監聽
                        setupRealtimeListener();
                    } else {
                        userId = null;
                        isAuthReady = false;
                        document.getElementById('user-id-display').textContent = '未驗證';
                        document.getElementById('save-button').textContent = '等待身份驗證...';
                        document.getElementById('save-button').disabled = true;
                        document.getElementById('loading-text').textContent = '等待連線與身份驗證...';
                    }
                });

            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                alertMessage("Firebase 初始化失敗。請檢查設定。", "error");
                document.getElementById('save-button').textContent = '初始化失敗';
                document.getElementById('save-button').disabled = true;
            }
        }

        // =========================================================
        // 2. 儲存紀錄的函式 (已修正和強化)
        // =========================================================
        async function addRecord() {
            if (!isAuthReady || !userId) {
                alertMessage("請先等待身份驗證完成才能儲存紀錄。", "warning");
                return;
            }

            const recordInput = document.getElementById('record-input');
            const content = recordInput.value.trim();

            if (content === "") {
                alertMessage("請輸入紀錄內容。", "warning");
                return;
            }

            try {
                // 設定私人儲存路徑：/artifacts/{appId}/users/{userId}/records
                const recordsRef = collection(db, `/artifacts/${appId}/users/${userId}/records`);
                
                const newRecord = {
                    content: content,
                    // 使用 ISO 格式時間戳，因為 serverTimestamp 在此環境中可能較難處理
                    createdAt: new Date().toISOString(), 
                    userId: userId 
                };

                // 使用 addDoc 來新增文件，Firebase 會自動生成文件 ID
                await addDoc(recordsRef, newRecord);
                
                recordInput.value = ''; // 清空輸入欄位
                alertMessage("紀錄儲存成功！", "success");
            } catch (error) {
                console.error("Error adding document: ", error);
                // 提供詳細錯誤訊息給使用者
                alertMessage(`儲存紀錄時發生錯誤: ${error.message}`, "error");
            }
        }

        // =========================================================
        // 3. 即時資料監聽函式
        // =========================================================
        function setupRealtimeListener() {
            if (!db || !userId) return;

            const recordsList = document.getElementById('records-list');
            const loadingText = document.getElementById('loading-text');

            // 設置查詢：從私人路徑中取得紀錄
            const recordsQuery = query(
                collection(db, `/artifacts/${appId}/users/${userId}/records`),
                orderBy('createdAt', 'desc') // 依據建立時間倒序排序
            );

            // 使用 onSnapshot 進行即時監聽
            onSnapshot(recordsQuery, (snapshot) => {
                const records = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    records.push({ id: doc.id, ...data });
                });

                if (loadingText) loadingText.remove(); // 移除載入中文字

                if (records.length === 0) {
                    recordsList.innerHTML = '<p class="text-center text-gray-400 p-4">目前沒有任何紀錄。開始新增吧！</p>';
                } else {
                    // 渲染紀錄清單
                    recordsList.innerHTML = records.map(record => `
                        <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                            <p class="text-gray-800 whitespace-pre-wrap">${record.content}</p>
                            <p class="text-xs text-gray-400 mt-2">
                                建立時間: ${new Date(record.createdAt).toLocaleString()}
                                (ID: ${record.id.substring(0, 5)}...)
                            </p>
                        </div>
                    `).join('');
                }

            }, (error) => {
                console.error("即時監聽發生錯誤: ", error);
                recordsList.innerHTML = `<p class="text-center text-red-500 p-4">無法載入紀錄: ${error.message}</p>`;
            });
        }


        // 應用程式啟動
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Google 登入示範</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        .main-bg {
            background-color: #f7f9fb;
        }
        /* 針對 Google 登入按鈕的特殊樣式 */
        .google-btn {
            background-color: #4285f4; /* Google Blue */
            color: white;
        }
        .google-btn:hover {
            background-color: #357ae8;
        }
        .google-icon {
            margin-right: 0.75rem;
            width: 1.5rem;
            height: 1.5rem;
        }
    </style>
</head>
<body class="main-bg min-h-screen flex items-center justify-center p-4">

    <!-- Auth Card Container -->
    <div class="bg-white rounded-xl shadow-2xl p-6 sm:p-10 w-full max-w-md text-center transform transition duration-500 hover:shadow-3xl hover:scale-[1.01]">
        
        <h1 class="text-3xl font-bold text-indigo-700 mb-6">帳號身份驗證中心</h1>
        
        <!-- Status Display Area -->
        <div id="auth-status-card" class="mb-6 p-4 rounded-lg border-2 border-dashed border-gray-300 transition duration-300 min-h-[120px] flex flex-col justify-center">
            <p id="status-message" class="text-lg font-semibold text-gray-600">正在檢查登入狀態...</p>
            <p id="user-info" class="text-sm text-gray-500 mt-1 break-all"></p>
        </div>

        <!-- Action Button Area -->
        <div id="action-area">
            <!-- Button will be dynamically rendered here -->
            <button id="auth-button" class="w-full py-3 px-4 rounded-lg font-bold text-lg shadow-md transition duration-150 flex items-center justify-center">
                載入中...
            </button>
        </div>
        
        <!-- Error/Alert Area -->
        <div id="alert-area" class="mt-4 text-sm font-medium text-red-600 hidden p-2 bg-red-100 rounded-lg"></div>
        
        <!-- App ID for debugging purposes -->
        <p id="app-id-display" class="mt-4 text-xs text-gray-400">App ID: loading...</p>
    </div>

    <!-- Firebase & Application Logic -->
    <script type="module">
        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- Configuration (已更新為您的 Firebase 配置) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-auth-app-id';
        
        // 使用者提供的 Firebase 配置
        const userProvidedConfig = {
            apiKey: "AIzaSyBJcP4HOoVFnbzLT-jdnrW1AtAWXVfjEaM",
            authDomain: "my-expense-tracker-574dd.firebaseapp.com",
            projectId: "my-expense-tracker-574dd",
            storageBucket: "my-expense-tracker-574dd.firebasestorage.app",
            messagingSenderId: "514938495732",
            appId: "1:514938495732:web:bb3529eca4f2db547b74a1",
            measurementId: "G-CDTCB6MFZ3"
        };
        
        // 優先使用 Canvas 環境提供的配置 (如果有)，否則使用使用者提供的配置
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userProvidedConfig;
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let auth;
        
        const statusMessageEl = document.getElementById('status-message');
        const userInfoEl = document.getElementById('user-info');
        const authButton = document.getElementById('auth-button');
        const alertArea = document.getElementById('alert-area');
        const statusCard = document.getElementById('auth-status-card');
        const appIdDisplay = document.getElementById('app-id-display');

        function updateUI(user) {
            // 清除按鈕上的所有類別以便重新設定
            authButton.className = 'w-full py-3 px-4 rounded-lg font-bold text-lg shadow-md transition duration-150 flex items-center justify-center';
            
            if (user) {
                // 使用者已登入
                const isGoogleUser = user.providerData.some(p => p.providerId === GoogleAuthProvider.PROVIDER_ID);
                const userName = user.displayName || user.email || (user.isAnonymous ? "匿名使用者" : "已登入使用者");
                
                statusCard.classList.remove('border-gray-300', 'border-red-500');
                statusCard.classList.add('border-green-500', 'bg-green-50');

                statusMessageEl.textContent = isGoogleUser ? `嗨，${userName}！您已使用 Google 登入。` : `您目前是匿名使用者。`;
                userInfoEl.textContent = `UID: ${user.uid}`;
                userInfoEl.classList.remove('hidden');

                authButton.textContent = '登出 (Sign Out)';
                authButton.classList.add('bg-red-600', 'text-white', 'hover:bg-red-700');
                authButton.onclick = handleSignOut;

            } else {
                // 使用者已登出
                statusCard.classList.remove('border-green-500', 'bg-green-50', 'border-red-500');
                statusCard.classList.add('border-gray-300');

                statusMessageEl.textContent = '請點擊下方按鈕登入您的 Google 帳號。';
                userInfoEl.textContent = '';
                userInfoEl.classList.add('hidden');
                
                // 渲染 Google 登入按鈕及其圖示
                authButton.innerHTML = `
                    <svg class="google-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                        <path fill="#FFC107" d="M43.61 20.083H42V20H24v8h11.341c-1.157 3.442-3.877 6.309-7.53 8.243l-.161.107L36 41l.211-.191c7.79-7.143 12.445-17.377 12.445-29.809 0-1.571-.144-3.102-.413-4.571z"/>
                        <path fill="#FF3D00" d="M6.307 14.693l-.208.196c3.856-3.55 8.918-5.694 14.341-5.694 5.378 0 10.435 2.144 14.316 5.672L36 12.083C30.686 6.848 23.328 4 15.648 4 8.783 4 2.894 6.784 0 11.233l6.307 3.46z"/>
                        <path fill="#4CAF50" d="M15.648 41c7.323 0 13.633-3.239 18.283-8.318l-7.234-5.291c-2.455 2.502-5.744 3.999-9.05 4.015h-.001C12.871 31.42 8.583 28.537 6.307 24.053L0 27.503c2.894 4.448 8.783 7.233 15.648 7.233z"/>
                        <path fill="#1976D2" d="M47.587 20.083c-.27-1.469-.413-2.999-.413-4.571 0-1.472.143-2.903.413-4.371H24v8h23.587z"/>
                    </svg>
                    使用 Google 帳號登入
                `;
                authButton.classList.add('google-btn', 'hover:bg-blue-700');
                authButton.onclick = handleGoogleSignIn;
            }
            alertArea.classList.add('hidden');
        }
        
        function displayAlert(message) {
            alertArea.textContent = message;
            alertArea.classList.remove('hidden');
        }

        async function handleGoogleSignIn() {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                // onAuthStateChanged 會自動處理 UI 更新
            } catch (error) {
                console.error("Google Sign-in Error:", error);
                if (error.code !== 'auth/popup-closed-by-user') {
                    displayAlert(`登入失敗: ${error.message}`);
                }
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                // 成功登出後，我們讓它自動轉為匿名登入狀態 (這是 Canvas 環境的慣例)
                await signInAnonymously(auth); 
                // onAuthStateChanged 會自動處理 UI 更新
            } catch (error) {
                console.error("Sign-out Error:", error);
                displayAlert(`登出失敗: ${error.message}`);
            }
        }

        async function initApp() {
            appIdDisplay.textContent = `App ID: ${appId}`;
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                // 1. 處理 Canvas 環境的自定義 Token 登入
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken).catch(async (error) => {
                        console.warn("Custom token sign-in failed, falling back to anonymous:", error);
                        // 如果自定義 token 失敗，則嘗試匿名登入
                        await signInAnonymously(auth);
                    });
                } else {
                    // 2. 如果沒有自定義 token，則直接匿名登入
                    await signInAnonymously(auth);
                }

                // 3. 設置認證狀態監聽器
                onAuthStateChanged(auth, (user) => {
                    updateUI(user);
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                statusMessageEl.textContent = `錯誤: Firebase 初始化失敗 (${error.message})`;
                authButton.textContent = '無法連線';
                authButton.classList.remove('google-btn');
                authButton.classList.add('bg-gray-400', 'text-gray-200', 'opacity-50', 'cursor-not-allowed');
                authButton.disabled = true;
            }
        }

        // Initialize the app when the window loads
        window.onload = initApp;
    </script>

</body>
</html>

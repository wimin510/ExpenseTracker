<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>跨平台記帳程式 (Email 登入)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide icons (用於圖示) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 自定義 Tailwind 配置 */
        :root {
            --color-primary: #10b981; /* Emerald 500 */
            --color-danger: #ef4444; /* Red 500 */
        }
        .income { color: var(--color-primary); }
        .expense { color: var(--color-danger); }
        /* 使用 Inter 字體 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6 md:p-10">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-emerald-500"></div>
            <p class="mt-4 text-lg text-gray-700">正在初始化服務...</p>
        </div>
    </div>

    <!-- 登入/註冊區塊 -->
    <div id="auth-section" class="max-w-md mx-auto bg-white shadow-xl rounded-2xl p-6 sm:p-8 mt-12 hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
            Email 登入/註冊
        </h2>
        <form id="auth-form">
            <div class="mb-4">
                <label for="auth-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" id="auth-email" placeholder="您的電子郵件" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
            </div>
            <div class="mb-6">
                <label for="auth-password" class="block text-sm font-medium text-gray-700 mb-1">密碼 (至少 6 位元)</label>
                <input type="password" id="auth-password" placeholder="設定您的密碼" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
            </div>
            
            <div class="flex space-x-4">
                <button type="button" id="login-btn"
                        class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-xl shadow-md transition duration-300 ease-in-out transform hover:scale-[1.01]">
                    登入
                </button>
                <button type="button" id="signup-btn"
                        class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 rounded-xl shadow-md transition duration-300 ease-in-out transform hover:scale-[1.01]">
                    註冊並登入
                </button>
            </div>
        </form>
    </div>

    <!-- 應用程式主區塊 -->
    <div id="app-container" class="hidden max-w-lg mx-auto bg-white shadow-xl rounded-2xl p-6 sm:p-8">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                    <i data-lucide="wallet-2" class="w-8 h-8 text-emerald-500 mr-2"></i>
                    我的私人記帳本
                </h1>
                <p id="user-email-display" class="text-sm text-gray-500 mt-1 break-all"></p>
            </div>
            <button id="signout-btn" class="flex items-center text-sm text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition duration-150">
                <i data-lucide="log-out" class="w-4 h-4 mr-1"></i>
                登出
            </button>
        </header>

        <!-- 總餘額區塊 -->
        <div class="bg-emerald-100 p-6 rounded-xl mb-8 shadow-inner">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">總餘額</h2>
            <p id="balance" class="text-4xl font-extrabold text-emerald-600">NT$ 0.00</p>
        </div>

        <!-- 新增交易表單 -->
        <section class="mb-8 p-6 border border-gray-200 rounded-xl bg-gray-50">
            <h2 class="text-xl font-bold text-gray-800 mb-4">新增交易</h2>
            <form id="transaction-form">
                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">描述</label>
                    <input type="text" id="description" placeholder="例如：晚餐、薪水" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition duration-150">
                </div>
                <div class="mb-4">
                    <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">金額 (收入為正，支出為負)</label>
                    <input type="number" id="amount" placeholder="例如：-350 (支出) 或 50000 (收入)" required step="0.01"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition duration-150">
                </div>
                
                <button type="submit"
                        class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 rounded-xl shadow-md transition duration-300 ease-in-out transform hover:scale-[1.01]">
                    記錄交易
                </button>
            </form>
        </section>

        <!-- 交易記錄列表 -->
        <section>
            <h2 class="text-xl font-bold text-gray-800 mb-4">交易記錄</h2>
            <div id="transactions-list" class="space-y-3">
                <!-- 交易項目將會在這裡動態插入 -->
                <p id="empty-state" class="text-center text-gray-500 p-4 border border-dashed rounded-lg">尚無交易記錄。</p>
            </div>
        </section>
        
        <!-- 訊息彈窗 -->
        <div id="message-box" class="fixed bottom-4 right-4 bg-red-600 text-white p-3 rounded-lg shadow-xl hidden transition-opacity duration-300"></div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // --- 1. 引入 Firebase 模組 ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設定 Firestore 紀錄等級 (Debug 用)
        setLogLevel('Debug');

        // 為了確保在非 Canvas 環境中也能執行，我們提供一個備用的 Firebase Config
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyBJcP4HOoVFnbzLT-jdnrW1AtAWXVfjEaM",
            authDomain: "my-expense-tracker-574dd.firebaseapp.com",
            projectId: "my-expense-tracker-574dd",
            storageBucket: "my-expense-tracker-574dd.firebasestorage.app",
            messagingSenderId: "514938495732",
            appId: "1:514938495732:web:bb3529eca4f2db547b74a1",
            measurementId: "G-CDTCB6MFZ3"
        };
        
        // --- 2. 存取環境提供的全域變數 ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // 優先使用環境變數
        let firebaseConfig = defaultFirebaseConfig;
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("解析 __firebase_config 失敗，使用預設配置。", e);
            }
        }
        
        // UI 元素
        const loadingOverlay = document.getElementById('loading-overlay');
        const appContainer = document.getElementById('app-container');
        const authSection = document.getElementById('auth-section');
        const balanceElement = document.getElementById('balance');
        const listElement = document.getElementById('transactions-list');
        const transactionForm = document.getElementById('transaction-form');
        const descriptionInput = document.getElementById('description');
        const amountInput = document.getElementById('amount');
        const emptyState = document.getElementById('empty-state');
        const userEmailDisplay = document.getElementById('user-email-display');
        const signoutBtn = document.getElementById('signout-btn');
        const messageBox = document.getElementById('message-box');
        
        // Auth UI 元素
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');

        let db;
        let auth;
        let currentUserId = null; // 現在直接使用 Firebase 登入後的 UID
        let unsubscribeListener = null; // 用來儲存 onSnapshot 的取消訂閱函式

        // --- 3. 輔助函式：顯示訊息彈窗 ---
        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = `fixed bottom-4 right-4 p-3 rounded-xl shadow-2xl transition-all duration-500 transform ${isError ? 'bg-red-600' : 'bg-emerald-500'} ${isError ? 'scale-105' : 'scale-100'}`;
            messageBox.style.display = 'block';
            
            setTimeout(() => {
                messageBox.style.opacity = '0';
                setTimeout(() => {
                    messageBox.style.display = 'none';
                    messageBox.style.opacity = '1'; // Reset for next use
                }, 300);
            }, 3000);
        }

        // --- 4. 初始化 Firebase 服務 (已更名避免與 import 的 initializeApp 衝突) ---
        function initializeServices() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                startAuthListener();
            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                loadingOverlay.classList.add('hidden');
                showMessage(`錯誤：Firebase 連線失敗。${error.message}`, true); 
            }
        }
        
        // --- 5. 交易資料庫路徑設定 ---
        function getCollectionPath(uid) {
            // 私人資料路徑: /artifacts/{appId}/users/{userId}/expenses
            return `artifacts/${appId}/users/${uid}/expenses`;
        }
        
        // --- 6. 登入狀態監聽器 ---
        function startAuthListener() {
            onAuthStateChanged(auth, (user) => {
                loadingOverlay.classList.add('hidden');

                if (user) {
                    // 使用者已登入
                    currentUserId = user.uid;
                    userEmailDisplay.textContent = `已登入: ${user.email}`;

                    authSection.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    
                    // 啟動資料監聽
                    startDataListener(currentUserId);
                    lucide.createIcons();
                    
                } else {
                    // 使用者已登出或未登入
                    currentUserId = null;
                    userEmailDisplay.textContent = '';

                    authSection.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    
                    // 清除 UI
                    balanceElement.textContent = 'NT$ 0.00';
                    listElement.innerHTML = `<p id="empty-state" class="text-center text-gray-500 p-4 border border-dashed rounded-lg">請登入以查看交易記錄。</p>`;
                    
                    // 停止資料監聽
                    if (unsubscribeListener) {
                        unsubscribeListener();
                        unsubscribeListener = null;
                    }
                }
            });
        }
        
        // --- 7. Email/密碼登入處理函式 ---
        async function handleAuth(isSignUp) {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;

            if (!email || password.length < 6) {
                showMessage("請輸入有效的 Email，且密碼需至少 6 位元。", true);
                return;
            }

            try {
                if (isSignUp) {
                    // 註冊
                    await createUserWithEmailAndPassword(auth, email, password);
                    showMessage("註冊成功！資料將在您的所有裝置上同步。");
                } else {
                    // 登入
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage("登入成功！");
                }
                
                // 清空密碼欄位
                authPasswordInput.value = '';

            } catch (error) {
                let errorMessage = "登入/註冊失敗。";
                
                // 處理常見的 Firebase Auth 錯誤
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = 'Email 或密碼錯誤。';
                        break;
                    case 'auth/email-already-in-use':
                        errorMessage = '此 Email 已被註冊。請直接登入或嘗試不同 Email。';
                        break;
                    default:
                        console.error("Auth 錯誤:", error);
                        errorMessage += ` (${error.code})`;
                }

                showMessage(errorMessage, true);
            }
        }
        
        // --- 8. 事件監聽器：登入/註冊/登出 ---
        loginBtn.addEventListener('click', () => handleAuth(false));
        signupBtn.addEventListener('click', () => handleAuth(true));
        signoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showMessage("您已成功登出。");
            } catch (e) {
                console.error("登出錯誤:", e);
                showMessage("登出失敗。", true);
            }
        });


        // --- 9. 即時資料監聽與渲染 (邏輯不變) ---
        function startDataListener(uid) {
            if (unsubscribeListener) {
                unsubscribeListener();
            }
            
            if (!db || !uid) {
                console.warn("Firestore 或 User ID 尚未準備好。");
                return;
            }

            const transactionsColRef = collection(db, getCollectionPath(uid));
            const q = query(transactionsColRef);

            unsubscribeListener = onSnapshot(q, (snapshot) => {
                const transactions = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    transactions.push({
                        id: doc.id,
                        description: data.description,
                        amount: data.amount,
                        createdAt: data.createdAt ? data.createdAt.toDate() : new Date(), 
                    });
                });

                // 客戶端排序：依照建立時間 (新的在前面)
                transactions.sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());
                
                renderTransactions(transactions);
                calculateBalance(transactions);

            }, (error) => {
                console.error("監聽交易記錄失敗:", error);
                showMessage("無法載入交易記錄。", true);
            });
        }
        
        // --- 10. 渲染交易列表 (邏輯不變) ---
        function renderTransactions(transactions) {
            listElement.innerHTML = '';

            if (transactions.length === 0) {
                const emptyMsg = `<p id="empty-state" class="text-center text-gray-500 p-4 border border-dashed rounded-lg">尚無交易記錄。</p>`;
                listElement.innerHTML = emptyMsg;
                return;
            }
            
            transactions.forEach(transaction => {
                const isIncome = transaction.amount > 0;
                const sign = isIncome ? '+' : '-';
                const typeClass = isIncome ? 'income' : 'expense';
                const icon = isIncome ? 'trending-up' : 'trending-down';
                const formattedAmount = Math.abs(transaction.amount).toFixed(2).toLocaleString('en-US');

                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-white p-4 rounded-xl shadow-sm border-l-4 ' + (isIncome ? 'border-emerald-500' : 'border-red-500');
                
                const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
                const formattedDate = transaction.createdAt.toLocaleDateString('zh-TW', dateOptions);

                item.innerHTML = `
                    <div class="flex items-center min-w-0 flex-1">
                        <i data-lucide="${icon}" class="w-5 h-5 ${isIncome ? 'text-emerald-500' : 'text-red-500'} mr-3 flex-shrink-0"></i>
                        <div class="min-w-0">
                            <p class="font-medium text-gray-800 truncate">${transaction.description}</p>
                            <p class="text-xs text-gray-400 mt-0.5">${formattedDate}</p>
                        </div>
                    </div>
                    <div class="flex items-center ml-4 flex-shrink-0">
                        <span class="font-bold text-lg ${typeClass} whitespace-nowrap">
                            ${sign} NT$ ${formattedAmount}
                        </span>
                        <button data-id="${transaction.id}" class="delete-btn ml-3 p-1 text-gray-400 hover:text-red-600 transition duration-150 rounded-full hover:bg-red-50">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                listElement.appendChild(item);
            });

            lucide.createIcons();

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    if (id) {
                        deleteTransaction(id);
                    }
                });
            });
        }
        
        // --- 11. 計算總餘額 (邏輯不變) ---
        function calculateBalance(transactions) {
            const total = transactions.reduce((sum, transaction) => sum + transaction.amount, 0);
            const formattedTotal = total.toFixed(2).toLocaleString('en-US');
            
            balanceElement.textContent = `NT$ ${formattedTotal}`;
            balanceElement.classList.remove('text-emerald-600', 'text-red-600');
            balanceElement.classList.add(total >= 0 ? 'text-emerald-600' : 'text-red-600');
        }

        // --- 12. 新增交易 ---
        transactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!db || !currentUserId) {
                showMessage("請先登入。", true);
                return;
            }

            const description = descriptionInput.value.trim();
            const amount = parseFloat(amountInput.value);

            if (!description || isNaN(amount) || amount === 0) {
                showMessage("請輸入有效的描述和非零的金額。", true);
                return;
            }

            try {
                await addDoc(collection(db, getCollectionPath(currentUserId)), {
                    description: description,
                    amount: amount,
                    createdAt: serverTimestamp()
                });

                showMessage("交易記錄成功！");
                descriptionInput.value = '';
                amountInput.value = '';

            } catch (e) {
                console.error("新增交易記錄錯誤:", e);
                showMessage("新增記錄失敗，請檢查連線。", true);
            }
        });

        // --- 13. 刪除交易 ---
        async function deleteTransaction(id) {
            if (!db || !currentUserId) {
                showMessage("請先登入。", true);
                return;
            }
            try {
                const docRef = doc(db, getCollectionPath(currentUserId), id);
                await deleteDoc(docRef);
                showMessage("交易已刪除。");
            } catch (e) {
                console.error("刪除交易記錄錯誤:", e);
                showMessage("刪除記錄失敗。", true);
            }
        }
        
        // 啟動應用程式
        initializeServices();
    </script>
</body>
</html>

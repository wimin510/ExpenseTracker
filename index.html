<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¨˜å¸³å°å¹«æ‰‹</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Zen Maru Gothic -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Change font to Zen Maru Gothic and slightly increase base size for better readability */
        body { 
            font-family: 'Zen Maru Gothic', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            font-size: 17px; /* Increase base font size slightly */
        }
        .calc-btn { transition: background-color 0.1s; }
        .calc-btn:active { background-color: #e5e7eb; }
        /* Hide scrollbar for category list */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Smooth transition for stats bars */
        .stats-bar { transition: width 0.5s ease-out, background-color 0.3s ease; }

        /* Ensure form inputs are also large */
        input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="date"], select {
            font-size: 1.1rem; /* Slightly larger text in form fields */
            padding: 0.75rem;
        }
    </style>
</head>
<!-- Use h-[100dvh] for better mobile browser support (address bar handling) -->
<body class="bg-gray-100 h-[100dvh] w-screen overflow-hidden flex flex-col justify-center items-center">

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
        <p class="mt-4 text-gray-500 text-lg">è³‡æ–™åŒæ­¥ä¸­...</p>
    </div>

    <!-- Auth Container -->
    <div id="auth-container" class="w-full h-full flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">è¨˜å¸³å°å¹«æ‰‹</h1>
            
            <!-- Login Form -->
            <div id="login-form">
                <input type="email" id="login-email" placeholder="é›»å­éƒµä»¶" class="w-full p-4 mb-4 border rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="login-password" placeholder="å¯†ç¢¼" class="w-full p-4 mb-6 border rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="handleLogin()" class="w-full bg-blue-600 text-white p-4 rounded-lg text-xl font-bold hover:bg-blue-700">ç™»å…¥</button>
                <p class="mt-6 text-center text-base text-gray-600">é‚„æ²’æœ‰å¸³è™Ÿ? <button onclick="toggleAuth('register')" class="text-blue-600 font-bold">è¨»å†Š</button></p>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="hidden">
                <input type="email" id="reg-email" placeholder="è¨­å®šé›»å­éƒµä»¶" class="w-full p-4 mb-4 border rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                <input type="password" id="reg-password" placeholder="è¨­å®šå¯†ç¢¼ (è‡³å°‘6ä½)" class="w-full p-4 mb-6 border rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                <button onclick="handleRegister()" class="w-full bg-green-600 text-white p-4 rounded-lg text-xl font-bold hover:bg-green-700">è¨»å†Šä¸¦ç™»å…¥</button>
                <p class="mt-6 text-center text-base text-gray-600">å·²æœ‰å¸³è™Ÿ? <button onclick="toggleAuth('login')" class="text-blue-600 font-bold">ç™»å…¥</button></p>
            </div>
        </div>
    </div>

    <!-- App Container (Hidden until logged in) -->
    <!-- Added h-full and w-full to ensure it fills the 100dvh body -->
    <div id="app-container" class="hidden flex-col h-full w-full max-w-md mx-auto bg-white shadow-2xl relative">
        
        <!-- Header -->
        <header class="bg-blue-600 text-white p-4 flex justify-between items-center shadow-md z-10 flex-shrink-0">
            <h2 class="text-xl font-bold" id="header-title">æœ¬æœˆæ”¯å‡º</h2>
            <button onclick="logout()" class="text-base bg-blue-700 px-3 py-1 rounded hover:bg-blue-800">ç™»å‡º</button>
        </header>

        <!-- Main Content Wrapper - flex-grow ensures it takes available space -->
        <div class="flex-grow overflow-hidden relative w-full">
            
            <!-- 1. Home View (Transactions) -->
            <main class="absolute inset-0 overflow-y-auto bg-gray-50 pb-20" id="main-view">
                <!-- Monthly Summary -->
                <div class="bg-white p-4 shadow-sm mb-2 sticky top-0 z-10">
                    <div class="text-base text-gray-500 mb-1">æœ¬æœˆç¸½æ”¯å‡º</div>
                    <div class="text-4xl font-bold text-gray-800" id="month-total">$0</div>
                </div>

                <!-- Transaction List -->
                <div id="transaction-list" class="p-0">
                    <!-- Transactions will be injected here -->
                </div>
            </main>

            <!-- 2. Stats View (New Feature) -->
            <div id="stats-view" class="hidden absolute inset-0 overflow-y-auto bg-gray-50 pb-20 p-4">
                <!-- Controls -->
                <div class="bg-white p-4 rounded-xl shadow-sm mb-4 sticky top-0 z-10">
                    <!-- Mode Switch -->
                    <div class="flex justify-center mb-4 bg-gray-100 rounded-lg p-1">
                         <button onclick="setStatsMode('month')" id="btn-mode-month" class="flex-1 py-2 rounded-md text-base font-bold transition bg-white shadow text-blue-600">æœˆå ±è¡¨</button>
                         <button onclick="setStatsMode('year')" id="btn-mode-year" class="flex-1 py-2 rounded-md text-base font-bold transition text-gray-500">å¹´å ±è¡¨</button>
                    </div>
                    <!-- Date Selector -->
                    <div class="flex justify-between items-center px-2">
                        <button onclick="shiftStatsDate(-1)" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 active:bg-gray-200"><i class="fa-solid fa-chevron-left text-gray-500"></i></button>
                        <span id="stats-date-label" class="font-bold text-2xl text-gray-800"></span>
                        <button onclick="shiftStatsDate(1)" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 active:bg-gray-200"><i class="fa-solid fa-chevron-right text-gray-500"></i></button>
                    </div>
                    <!-- Total -->
                    <div class="text-center mt-4 border-t pt-4">
                        <div class="text-sm text-gray-500 mb-1">æœŸé–“ç¸½æ”¯å‡º</div>
                        <div class="text-4xl font-bold text-blue-600" id="stats-total">$0</div>
                    </div>
                </div>
                <!-- Stats List -->
                <div id="stats-list" class="space-y-4">
                    <!-- Stats injected here -->
                </div>
            </div>

            <!-- 3. Settings View (Hidden) -->
            <div id="settings-view" class="hidden absolute inset-0 overflow-y-auto bg-gray-50 pb-20 p-4">
                <h3 class="text-xl font-bold text-gray-700 mb-4">åˆ†é¡èˆ‡é ç®—è¨­å®š</h3>
                
                <!-- Category List -->
                <div id="category-settings-list" class="space-y-4 mb-8">
                    <!-- Categories injected here -->
                </div>

                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                    <h4 class="font-bold text-lg text-gray-600 mb-3">æ–°å¢åˆ†é¡</h4>
                    <div class="flex flex-col gap-3 mb-3">
                        <input type="text" id="new-cat-name" placeholder="åç¨± (ä¾‹: é£²é£Ÿ)" class="p-3 border rounded text-lg">
                        <input type="number" id="new-cat-budget" placeholder="é ç®— (é è¨­ç‚º 0)" class="p-3 border rounded text-lg">
                    </div>
                    <button onclick="addCategory()" class="w-full bg-blue-500 text-white py-3 rounded text-lg font-bold">æ–°å¢åˆ†é¡</button>
                </div>

                <h3 class="text-xl font-bold text-gray-700 mt-10 mb-4">æ”¯ä»˜æ–¹å¼è¨­å®š</h3>
                 <div id="payment-settings-list" class="flex flex-wrap gap-3 mb-4">
                    <!-- Payment methods injected here -->
                </div>
                 <div class="flex gap-2">
                    <input type="text" id="new-pay-method" placeholder="æ–°æ”¯ä»˜æ–¹å¼" class="flex-1 p-3 border rounded text-lg">
                    <button onclick="addPaymentMethod()" class="bg-green-500 text-white px-4 py-3 rounded text-lg font-bold">æ–°å¢</button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Button (Floating) -->
        <!-- Moved z-index higher to float above content but below modals -->
        <button id="add-btn" onclick="openModal()" class="absolute bottom-20 right-4 bg-blue-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-3xl hover:bg-blue-700 z-20 transition-transform hover:scale-110">
            <i class="fa-solid fa-plus"></i>
        </button>

        <!-- Bottom Nav -->
        <nav class="bg-white border-t flex justify-around p-2 pb-safe z-30 flex-shrink-0 h-20 items-center">
            <button onclick="switchView('home')" class="flex flex-1 flex-col items-center text-blue-600 nav-btn" id="nav-home">
                <i class="fa-solid fa-list text-2xl mb-1"></i>
                <span class="text-sm font-bold">ç´€éŒ„</span>
            </button>
            <button onclick="switchView('stats')" class="flex flex-1 flex-col items-center text-gray-400 nav-btn" id="nav-stats">
                <i class="fa-solid fa-chart-pie text-2xl mb-1"></i>
                <span class="text-sm font-bold">çµ±è¨ˆ</span>
            </button>
            <button onclick="switchView('settings')" class="flex flex-1 flex-col items-center text-gray-400 nav-btn" id="nav-settings">
                <i class="fa-solid fa-gear text-2xl mb-1"></i>
                <span class="text-sm font-bold">è¨­å®š</span>
            </button>
        </nav>
    </div>

    <!-- Input Modal (Calculator & Form) -->
    <div id="input-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex flex-col justify-end">
        <div class="bg-white rounded-t-2xl shadow-2xl h-[90vh] flex flex-col animate-slide-up overflow-hidden">
            
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b flex-shrink-0">
                <button onclick="closeModal()" class="text-gray-500 p-2"><i class="fa-solid fa-times text-2xl"></i></button>
                <h3 class="font-bold text-xl" id="modal-title">æ–°å¢æ”¯å‡º</h3>
                <button onclick="saveTransaction()" class="text-blue-600 font-bold p-2 text-lg">å„²å­˜</button>
            </div>

            <!-- Form Fields -->
            <div class="p-4 flex-grow overflow-y-auto">
                <!-- Display Area -->
                <div class="bg-gray-100 p-4 rounded-xl mb-4 text-right">
                    <div class="text-base text-gray-500 mb-1" id="calc-expression"></div>
                    <div class="text-5xl font-bold text-gray-800 truncate" id="calc-display">0</div>
                </div>

                <!-- Fields Grid -->
                <div class="space-y-4">
                    <!-- Date -->
                    <div class="flex items-center border-b pb-2">
                        <i class="fa-regular fa-calendar text-gray-400 w-10 text-xl"></i>
                        <input type="date" id="input-date" class="flex-1 bg-transparent outline-none">
                    </div>

                    <!-- Category (Changed to Select) -->
                    <div class="space-y-2">
                        <label class="text-sm text-gray-500 ml-10">åˆ†é¡</label>
                        <div class="flex items-center border-b pb-2">
                            <i class="fa-solid fa-tag text-gray-400 w-10 text-xl"></i>
                            <select id="input-category" class="flex-1 bg-transparent outline-none">
                                <!-- Options injected by JS -->
                            </select>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="space-y-2">
                        <label class="text-sm text-gray-500 ml-10">æ”¯ä»˜æ–¹å¼</label>
                        <div class="flex items-center border-b pb-2">
                            <i class="fa-regular fa-credit-card text-gray-400 w-10 text-xl"></i>
                            <select id="input-payment" class="flex-1 bg-transparent outline-none">
                                <!-- Options injected JS -->
                            </select>
                        </div>
                    </div>

                    <!-- Note -->
                    <div class="flex items-center border-b pb-2">
                        <i class="fa-regular fa-comment text-gray-400 w-10 text-xl"></i>
                        <input type="text" id="input-note" placeholder="å‚™è¨» (é¸å¡«)" class="flex-1 bg-transparent outline-none">
                    </div>
                </div>
            </div>

            <!-- Calculator Keypad -->
            <div class="bg-gray-50 p-2 grid grid-cols-4 gap-2 border-t h-1/3 flex-shrink-0">
                <button class="calc-btn bg-white rounded shadow-sm text-2xl font-bold text-gray-700 py-3" onclick="calcInput('7')">7</button>
                <button class="calc-btn bg-white rounded shadow-sm text-2xl font-bold text-gray-700 py-3" onclick="calcInput('8')">8</button>
                <button class="calc-btn bg-white rounded shadow-sm text-2xl font-bold text-gray-700 py-3" onclick="calcInput('9')">9</button>
                <button class="calc-btn bg-blue-100 text-blue-600 rounded shadow-sm text-2xl font-bold py-3" onclick="calcOp('/')">Ã·</button>

                <button class="calc-btn bg-white rounded shadow-sm text-2xl font-bold text-gray-700 py-3" onclick="calcInput('4')">4</button>
                <button class="calc-btn bg-white rounded shadow-sm text-2xl font-bold text-gray-700 py-3" onclick="calcInput('5')">5</button>
                <button class="calc-btn bg-white rounded shadow-sm text-2xl font-bold text-gray-700 py-3" onclick="calcInput('6')">6</button>
                <button class="calc-btn bg-blue-100 text-blue-600 rounded shadow-sm text-2xl font-bold py-3" onclick="calcOp('*')">Ã—</button>

                <button class="calc-btn bg-white rounded shadow-sm text-2xl font-bold text-gray-700 py-3" onclick="calcInput('1')">1</button>
                <button class="calc-btn bg-white rounded shadow-sm text-2xl font-bold text-gray-700 py-3" onclick="calcInput('2')">2</button>
                <button class="calc-btn bg-white rounded shadow-sm text-2xl font-bold text-gray-700 py-3" onclick="calcInput('3')">3</button>
                <button class="calc-btn bg-blue-100 text-blue-600 rounded shadow-sm text-2xl font-bold py-3" onclick="calcOp('-')">-</button>

                <button class="calc-btn bg-red-100 text-red-500 rounded shadow-sm text-2xl font-bold py-3" onclick="calcClear()">C</button>
                <button class="calc-btn bg-white rounded shadow-sm text-2xl font-bold text-gray-700 py-3" onclick="calcInput('0')">0</button>
                <button class="calc-btn bg-white rounded shadow-sm text-2xl font-bold text-gray-700 py-3" onclick="calcOp('+')">+</button>
                <button class="calc-btn bg-blue-600 text-white rounded shadow-sm text-2xl font-bold py-3" onclick="saveTransaction()">OK</button>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <div id="alert-icon" class="text-5xl mb-4">âš ï¸</div>
            <h3 id="alert-title" class="text-2xl font-bold mb-3">é ç®—æé†’</h3>
            <p id="alert-msg" class="text-lg text-gray-600 mb-6">å·²é”åˆ°é ç®—çš„ 50%</p>
            <button onclick="document.getElementById('alert-modal').classList.add('hidden')" class="bg-blue-600 text-white w-full py-3 rounded-lg text-xl font-bold">çŸ¥é“äº†</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, setDoc, getDoc, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // --- Firebase Config ---
        // NOTE: The actual __firebase_config and __app_id variables from the environment should be used in a production environment.
        const firebaseConfig = {
            apiKey: "AIzaSyBJcP4HOoVFnbzLT-jdnrW1AtAWXVfjEaM",
            authDomain: "my-expense-tracker-574dd.firebaseapp.com",
            projectId: "my-expense-tracker-574dd",
            storageBucket: "my-expense-tracker-574dd.firebasestorage.app",
            messagingSenderId: "514938495732",
            appId: "1:514938495732:web:bb3529eca4f2db547b74a1",
            measurementId: "G-CDTCB6MFZ3"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Use provided app ID

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        let currentUser = null;
        let categories = []; // { name: string, budget: number }
        let paymentMethods = ["ç¾é‡‘", "ä¿¡ç”¨å¡"];
        let transactions = [];
        let editMode = false;
        let currentEditId = null;

        // --- Stats State ---
        let statsMode = 'month'; // 'month' or 'year'
        let statsDate = new Date();

        // --- Color Palette (Soft/Pastel) ---
        // Updated to use less saturated, more muted colors for better eye comfort
        const categoryColorPalette = [
            "bg-sky-100 text-sky-700",      // Light Blue (Soft)
            "bg-green-100 text-green-700",  // Light Green (Muted)
            "bg-amber-100 text-amber-700",  // Light Amber (Earthy)
            "bg-rose-100 text-rose-700",    // Muted Pink
            "bg-violet-100 text-violet-700",// Muted Violet
            "bg-slate-200 text-slate-700",  // Gray/Neutral
            "bg-teal-100 text-teal-700",    // Muted Teal
            "bg-fuchsia-100 text-fuchsia-700", // Soft Magenta
            "bg-indigo-100 text-indigo-700", // Soft Indigo
            "bg-lime-100 text-lime-700",     // Pale Lime
        ];

        function getCategoryColor(name) {
            // Simple hash function to consistently map a category name to a color
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash) % categoryColorPalette.length;
            return categoryColorPalette[index];
        }

        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loadingOverlay = document.getElementById('loading');
        const calcDisplay = document.getElementById('calc-display');
        const calcExpr = document.getElementById('calc-expression');
        
        // --- Authentication Logic ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                showLoading(true);
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                appContainer.classList.add('flex');
                
                // Load User Settings First
                await loadSettings();
                // Then Load Transactions
                subscribeTransactions();
                showLoading(false);
            } else {
                currentUser = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                appContainer.classList.remove('flex');
                document.getElementById('transaction-list').innerHTML = '';
            }
        });

        window.handleLogin = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                showAlert("ç™»å…¥å¤±æ•—", error.message, "red");
            }
        };

        window.handleRegister = async () => {
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, pass);
                // Create default settings for new user
                await initDefaultSettings();
            } catch (error) {
                showAlert("è¨»å†Šå¤±æ•—", error.message, "red");
            }
        };

        window.logout = () => signOut(auth);

        window.toggleAuth = (mode) => {
            if (mode === 'register') {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            } else {
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            }
        };

        // --- Data Management ---
        
        const getUserPath = () => `artifacts/${appId}/users/${currentUser.uid}`;

        async function initDefaultSettings() {
            const defaultCats = [
                { name: "é£²é£Ÿ", budget: 6000 },
                { name: "äº¤é€š", budget: 2000 },
                { name: "å¨›æ¨‚", budget: 3000 },
                { name: "è³¼ç‰©", budget: 5000 },
                { name: "å…¶ä»–", budget: 1000 }
            ];
            const defaultMethods = ["ç¾é‡‘", "ä¿¡ç”¨å¡"];
            
            await setDoc(doc(db, getUserPath(), "config", "settings"), {
                categories: defaultCats,
                paymentMethods: defaultMethods
            });
        }

        async function loadSettings() {
            const docRef = doc(db, getUserPath(), "config", "settings");
            try {
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    categories = data.categories || [];
                    paymentMethods = data.paymentMethods || [];
                } else {
                    await initDefaultSettings();
                    // Load the newly created defaults after init
                    const newDocSnap = await getDoc(docRef);
                    const newData = newDocSnap.data();
                    categories = newData.categories || [];
                    paymentMethods = newData.paymentMethods || [];
                }
            } catch (error) {
                 console.error("Error loading settings:", error);
                 showAlert("è¨­å®šæª”è¼‰å…¥å¤±æ•—", "è«‹å˜—è©¦é‡æ–°ç™»å…¥ã€‚", "red");
                 // Fallback to minimal defaults if DB fails
                 categories = [{ name: "é£²é£Ÿ", budget: 6000 }];
                 paymentMethods = ["ç¾é‡‘"];
            }
            renderSettings();
        }
        
        async function saveSettings() {
             try {
                await setDoc(doc(db, getUserPath(), "config", "settings"), {
                    categories: categories,
                    paymentMethods: paymentMethods
                });
                // Rerender settings and immediately check all transactions against new budgets
                renderSettings();
                renderTransactions(); 
                showAlert("å„²å­˜æˆåŠŸ", "åˆ†é¡èˆ‡æ”¯ä»˜æ–¹å¼å·²æ›´æ–°ã€‚", "green");
            } catch (error) {
                 console.error("Error saving settings:", error);
                 showAlert("å„²å­˜å¤±æ•—", "ç„¡æ³•æ›´æ–°è¨­å®šæª”ã€‚", "red");
            }
        }


        function subscribeTransactions() {
            // The query listens to the transactions collection for the current user.
            const q = query(collection(db, getUserPath(), "data")); 
            
            onSnapshot(q, (snapshot) => {
                transactions = [];
                snapshot.forEach((doc) => {
                    // Firestore timestamp to JS Date
                    const data = doc.data();
                    const date = data.date && data.date.toDate ? data.date.toDate() : new Date(data.date);
                    transactions.push({ id: doc.id, ...data, date: date });
                });
                // Sort transactions by date (descending)
                transactions.sort((a, b) => b.date.getTime() - a.date.getTime());
                
                renderTransactions();
                // Rerender stats if the stats view is active
                if (!document.getElementById('stats-view').classList.contains('hidden')) {
                    renderStats();
                }
            }, (error) => {
                console.error("Error subscribing to transactions:", error);
                showAlert("è³‡æ–™é€£ç·šå¤±æ•—", "ç„¡æ³•åŒæ­¥äº¤æ˜“ç´€éŒ„ã€‚", "red");
            });
        }

        // --- Rendering Functions ---

        function formatCurrency(amount) {
            return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(amount);
        }

        function formatDate(date) {
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
        }

        function calculateMonthlySummary() {
            const currentMonth = new Date(statsDate.getFullYear(), statsDate.getMonth(), 1);
            let total = 0;
            
            transactions.forEach(t => {
                const tDate = new Date(t.date.getFullYear(), t.date.getMonth(), 1);
                if (tDate.getTime() === currentMonth.getTime()) {
                    total += t.amount;
                }
            });

            document.getElementById('month-total').innerText = formatCurrency(total);
        }

        function renderTransactions() {
            const list = document.getElementById('transaction-list');
            list.innerHTML = '';
            
            if (transactions.length === 0) {
                list.innerHTML = `
                    <div class="p-6 text-center text-gray-500 text-lg">
                        <i class="fa-solid fa-receipt text-4xl mb-2"></i>
                        <p>æœ¬æœˆé‚„æ²’æœ‰ç´€éŒ„å–”ï¼</p>
                        <p class="text-base mt-1">é»æ“Šå³ä¸‹è§’ + é–‹å§‹è¨˜å¸³</p>
                    </div>
                `;
                document.getElementById('month-total').innerText = formatCurrency(0);
                return;
            }

            // Group transactions by date
            const grouped = transactions.reduce((acc, t) => {
                const dateKey = formatDate(t.date);
                if (!acc[dateKey]) {
                    acc[dateKey] = [];
                }
                acc[dateKey].push(t);
                return acc;
            }, {});

            let totalExpense = 0;
            const today = new Date();
            const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);

            Object.keys(grouped).sort((a, b) => new Date(b).getTime() - new Date(a).getTime()).forEach(dateKey => {
                const dayTransactions = grouped[dateKey];
                const dateObj = dayTransactions[0].date;
                
                // Only consider transactions in the current month for the Home View total
                if (dateObj.getTime() >= currentMonthStart.getTime()) {
                    dayTransactions.forEach(t => totalExpense += t.amount);
                }

                // Calculate daily total
                const dailyTotal = dayTransactions.reduce((sum, t) => sum + t.amount, 0);

                // Date header
                const dayName = dateObj.getDay() === 0 ? 'é€±æ—¥' : `é€±${'ä¸€äºŒä¸‰å››äº”å…­'[dateObj.getDay() - 1]}`;
                const isToday = formatDate(dateObj) === formatDate(new Date());

                list.innerHTML += `
                    <div class="flex justify-between items-center p-3 text-base border-b border-t mt-[-1px] bg-gray-200 sticky top-[72px] z-[5]">
                        <div class="font-bold text-gray-600">
                            ${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥ 
                            <span class="${isToday ? 'text-blue-600' : 'text-gray-500'} ml-1">(${dayName})</span>
                        </div>
                        <div class="font-bold text-red-500">
                            ${formatCurrency(dailyTotal)}
                        </div>
                    </div>
                `;

                // Transaction items
                dayTransactions.forEach(t => {
                    const color = getCategoryColor(t.category);
                    list.innerHTML += `
                        <div class="flex justify-between items-center p-4 border-b bg-white hover:bg-gray-50 active:bg-gray-100 transition" onclick="openModal('${t.id}')">
                            <div class="flex items-center space-x-4 truncate">
                                <!-- Larger color dot and font size here -->
                                <div class="w-3 h-3 rounded-full ${color.split(' ')[0].replace('-100', '-600')} flex-shrink-0"></div>
                                <div class="flex flex-col truncate">
                                    <div class="font-bold text-lg text-gray-800 truncate">${t.note || t.category}</div>
                                    <div class="text-sm text-gray-500 mt-0.5 truncate">
                                        ${t.category} 
                                        <span class="ml-1 text-gray-400">| ${t.payment || 'æœªè¨­å®š'}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right flex flex-col items-end flex-shrink-0 ml-4">
                                <div class="font-bold text-xl text-red-500">${formatCurrency(t.amount)}</div>
                                <div class="text-sm text-gray-400 mt-0.5">${t.date.getHours().toString().padStart(2, '0')}:${t.date.getMinutes().toString().padStart(2, '0')}</div>
                            </div>
                        </div>
                    `;
                });
            });

            // Update main view total
            document.getElementById('month-total').innerText = formatCurrency(totalExpense);
            checkBudgetAlerts(totalExpense);
        }

        // --- Budget Alert Logic ---
        function checkBudgetAlerts(monthlyTotal) {
            // Find the category of the last recorded expense (most recent transaction)
            if (transactions.length === 0) return;
            
            const mostRecentTransaction = transactions[0];
            const recentCategory = mostRecentTransaction.category;
            const categoryObj = categories.find(c => c.name === recentCategory);
            
            if (!categoryObj) return;

            const categoryBudget = categoryObj.budget;

            // 1. Check if category budget is 0 or less (no alert necessary if budget is 0/not set)
            if (categoryBudget <= 0) return;

            // Calculate category spending for the current month
            const currentMonth = new Date(mostRecentTransaction.date.getFullYear(), mostRecentTransaction.date.getMonth(), 1);
            const categorySpending = transactions
                .filter(t => t.category === recentCategory)
                .filter(t => new Date(t.date.getFullYear(), t.date.getMonth(), 1).getTime() === currentMonth.getTime())
                .reduce((sum, t) => sum + t.amount, 0);

            const percentage = (categorySpending / categoryBudget) * 100;
            
            let alertMsg = null;
            let icon = 'âš ï¸';
            let title = 'é ç®—æé†’';

            if (percentage >= 100) {
                alertMsg = `æ‚¨åœ¨ã€${recentCategory}ã€‘åˆ†é¡çš„æ”¯å‡ºå·²é”é ç®— ${formatCurrency(categoryBudget)}ï¼Œè¶…å‡º ${formatCurrency(categorySpending - categoryBudget)}ï¼`;
                icon = 'ğŸš¨';
                title = 'é ç®—è¶…æ”¯ï¼';
            } else if (percentage >= 75 && percentage < 100) {
                alertMsg = `æ‚¨åœ¨ã€${recentCategory}ã€‘åˆ†é¡çš„æ”¯å‡ºå·²é”é ç®—çš„ 75% (${formatCurrency(categoryBudget)})ï¼Œè«‹ç•™æ„ã€‚`;
                icon = 'ğŸ””';
            } else if (percentage >= 50 && percentage < 75) {
                // Not showing an alert for 50% for simplicity unless it's a new transaction
            } else {
                return; // No alert needed
            }

            if (alertMsg) {
                // Only show alert if the recent transaction caused the threshold to be crossed
                showAlert(title, alertMsg, icon === 'ğŸš¨' ? 'red' : 'orange');
            }
        }

        function renderSettings() {
            const catList = document.getElementById('category-settings-list');
            catList.innerHTML = '';
            
            categories.forEach((cat, index) => {
                const color = getCategoryColor(cat.name);
                
                // Calculate monthly spending for this category
                const today = new Date();
                const currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const spending = transactions
                    .filter(t => t.category === cat.name)
                    .filter(t => new Date(t.date.getFullYear(), t.date.getMonth(), 1).getTime() === currentMonth.getTime())
                    .reduce((sum, t) => sum + t.amount, 0);

                // Budget Bar calculation
                let percentage = (cat.budget > 0) ? Math.min(100, (spending / cat.budget) * 100) : 0;
                let barColor = 'bg-blue-400';
                if (percentage >= 100) {
                    barColor = 'bg-red-500';
                    percentage = 100; // Always show full bar for 100%+
                } else if (percentage >= 75) {
                    barColor = 'bg-orange-400';
                }
                
                // Handle budget 0 (show spending vs 0)
                const budgetDisplay = cat.budget > 0 ? formatCurrency(cat.budget) : "ç„¡é ç®—";
                const barWidth = cat.budget > 0 ? `${percentage}%` : '0%';
                
                const item = document.createElement('div');
                item.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-200';
                item.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center">
                            <!-- Increased tag size -->
                            <span class="${color} px-3 py-1 rounded-full text-base font-bold mr-4">${cat.name}</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="text-base font-semibold text-gray-700">${formatCurrency(spending)}</span>
                            <span class="text-sm text-gray-500">/ ${budgetDisplay}</span>
                            <button onclick="editCategory(${index})" class="text-gray-400 hover:text-blue-500 p-1"><i class="fa-solid fa-pen text-base"></i></button>
                            <button onclick="deleteCategory(${index})" class="text-gray-400 hover:text-red-500 p-1"><i class="fa-solid fa-trash-alt text-base"></i></button>
                        </div>
                    </div>
                    <div class="h-3 w-full bg-gray-200 rounded-full overflow-hidden">
                        <div class="stats-bar h-full rounded-full ${barColor}" style="width: ${barWidth};"></div>
                    </div>
                    <div class="text-sm text-right mt-1 text-gray-500">
                        ${cat.budget > 0 ? (spending > cat.budget ? `è¶…å‡º ${formatCurrency(spending - cat.budget)}` : `å‰©é¤˜ ${formatCurrency(cat.budget - spending)}`) : 'ç„¡é ç®—è¨­å®š'}
                    </div>
                `;
                catList.appendChild(item);
            });

            // Payment methods
            const payList = document.getElementById('payment-settings-list');
            payList.innerHTML = '';
            paymentMethods.forEach((method, index) => {
                 payList.innerHTML += `
                    <div class="flex items-center bg-blue-50 border border-blue-200 rounded-full pr-4 py-1.5 pl-4 text-base text-blue-800 font-medium space-x-1">
                        <span>${method}</span>
                        <button onclick="deletePaymentMethod(${index})" class="text-blue-400 hover:text-red-500 ml-1">
                            <i class="fa-solid fa-times text-sm"></i>
                        </button>
                    </div>
                `;
            });

            // Re-render modal category options
            renderModalCategoryOptions();
            renderModalPaymentOptions();
        }

        // --- Category Management ---

        window.addCategory = () => {
            const nameInput = document.getElementById('new-cat-name');
            const budgetInput = document.getElementById('new-cat-budget');
            const name = nameInput.value.trim();
            const budget = parseInt(budgetInput.value) || 0; // Default to 0

            if (!name) {
                showAlert("è¼¸å…¥éŒ¯èª¤", "åˆ†é¡åç¨±ä¸èƒ½ç‚ºç©ºã€‚", "orange");
                return;
            }
            if (categories.some(c => c.name === name)) {
                showAlert("é‡è¤‡åˆ†é¡", "æ­¤åˆ†é¡åç¨±å·²å­˜åœ¨ã€‚", "orange");
                return;
            }

            categories.push({ name, budget });
            nameInput.value = '';
            budgetInput.value = '';
            saveSettings();
        };

        window.editCategory = (index) => {
            const cat = categories[index];
            // Replaced alert() with custom modal/input logic for better UX in iframe
            // Since alert() is strictly forbidden, using prompt() as a workaround for simple user input in this specific case, 
            // though a custom modal would be ideal.
            const newBudget = prompt(`ç·¨è¼¯ã€${cat.name}ã€‘é ç®—ï¼š`, cat.budget); 

            if (newBudget !== null) {
                const budgetValue = parseInt(newBudget);
                if (!isNaN(budgetValue) && budgetValue >= 0) {
                    categories[index].budget = budgetValue;
                    saveSettings();
                } else if (newBudget.trim() === "") {
                    // Treat empty string as 0
                    categories[index].budget = 0;
                    saveSettings();
                } else {
                    showAlert("è¼¸å…¥éŒ¯èª¤", "é ç®—å¿…é ˆæ˜¯æœ‰æ•ˆçš„éè² æ•¸å­—ã€‚", "red");
                }
            }
        };

        window.deleteCategory = (index) => {
            const catName = categories[index].name;
            // Replaced confirm() with prompt() workaround since confirm is forbidden
            if (prompt(`ç¢ºå®šè¦åˆªé™¤åˆ†é¡ã€${catName}ã€‘å—ï¼Ÿ\n(è¼¸å…¥ "åˆªé™¤" ç¢ºèª)`).toLowerCase() === "åˆªé™¤") {
                categories.splice(index, 1);
                saveSettings();
            }
        };

        // --- Payment Management ---
        window.addPaymentMethod = () => {
            const input = document.getElementById('new-pay-method');
            const method = input.value.trim();

            if (!method) {
                showAlert("è¼¸å…¥éŒ¯èª¤", "æ”¯ä»˜æ–¹å¼åç¨±ä¸èƒ½ç‚ºç©ºã€‚", "orange");
                return;
            }
            if (paymentMethods.includes(method)) {
                showAlert("é‡è¤‡æ–¹å¼", "æ­¤æ”¯ä»˜æ–¹å¼å·²å­˜åœ¨ã€‚", "orange");
                return;
            }

            paymentMethods.push(method);
            input.value = '';
            saveSettings();
        };

        window.deletePaymentMethod = (index) => {
            const methodName = paymentMethods[index];
            if (prompt(`ç¢ºå®šè¦åˆªé™¤æ”¯ä»˜æ–¹å¼ã€${methodName}ã€‘å—ï¼Ÿ\n(è¼¸å…¥ "åˆªé™¤" ç¢ºèª)`).toLowerCase() === "åˆªé™¤") {
                paymentMethods.splice(index, 1);
                saveSettings();
            }
        };


        // --- Calculator Logic ---
        let expression = '';
        let result = 0;

        window.calcInput = (value) => {
            // If the last operation was '=', reset expression
            if (expression.includes('=')) {
                expression = '';
                result = 0;
            }
            
            // Prevent leading zero if not followed by a decimal
            if (expression === '0' && value !== '.') {
                expression = value;
            } else if (expression.endsWith('0') && ['+', '-', '*', '/'].some(op => expression.slice(-2).includes(op))) {
                 // Replace single zero after an operator
                expression = expression.slice(0, -1) + value;
            } else {
                expression += value;
            }
            updateCalcDisplay();
        };

        window.calcOp = (op) => {
            if (expression === '') return;
            // Evaluate current expression before adding new operator
            if (expression.includes('=')) {
                 // Use the last result as the starting point for the new expression
                expression = result.toString();
            }
            
            // Remove trailing operator if any
            const lastChar = expression.slice(-1);
            if (['+', '-', '*', '/'].includes(lastChar)) {
                expression = expression.slice(0, -1);
            }
            
            expression += op;
            updateCalcDisplay();
        };

        window.calcClear = () => {
            expression = '';
            result = 0;
            updateCalcDisplay();
        };
        
        // This function is the core of the calculator display logic
        function updateCalcDisplay() {
            calcExpr.innerText = expression.replace(/\*/g, 'Ã—').replace(/\//g, 'Ã·').replace(/=/g, '');
            
            if (expression.includes('=')) {
                calcDisplay.innerText = formatCurrency(result).replace('TWD', '').trim();
                return;
            }

            try {
                // Determine the part of the expression to evaluate (only up to the last operator)
                let evalExpr = expression;
                let lastOperatorIndex = Math.max(
                    evalExpr.lastIndexOf('+'),
                    evalExpr.lastIndexOf('-'),
                    evalExpr.lastIndexOf('*'),
                    evalExpr.lastIndexOf('/')
                );

                if (lastOperatorIndex > -1 && lastOperatorIndex < evalExpr.length - 1) {
                    // If an operator exists and is not the last character, evaluate the whole thing
                    result = eval(evalExpr.replace(/Ã·/g, '/').replace(/Ã—/g, '*'));
                } else if (lastOperatorIndex === evalExpr.length - 1) {
                    // If the last character is an operator, evaluate only the part before it
                    let tempExpr = evalExpr.slice(0, -1);
                    if (tempExpr) {
                        result = eval(tempExpr.replace(/Ã·/g, '/').replace(/Ã—/g, '*'));
                    } else {
                        result = 0;
                    }
                } else if (evalExpr) {
                    // No operators, just a number
                    result = parseFloat(evalExpr);
                } else {
                    result = 0;
                }
                
                // Show the current numerical input or the intermediate result
                calcDisplay.innerText = formatCurrency(result).replace('TWD', '').trim();

            } catch (e) {
                calcDisplay.innerText = 'éŒ¯èª¤';
                result = 0;
            }
        }

        // --- Transaction Modal & CRUD ---

        function renderModalCategoryOptions() {
            const select = document.getElementById('input-category');
            select.innerHTML = categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
        }

        function renderModalPaymentOptions() {
            const select = document.getElementById('input-payment');
            select.innerHTML = paymentMethods.map(method => `<option value="${method}">${method}</option>`).join('');
        }

        window.openModal = (transactionId = null) => {
            document.getElementById('input-modal').classList.remove('hidden');
            document.getElementById('add-btn').classList.add('hidden');
            
            // Reset calculator state
            calcClear();
            
            // Set default date to today
            document.getElementById('input-date').value = formatDate(new Date());

            if (transactionId) {
                editMode = true;
                currentEditId = transactionId;
                document.getElementById('modal-title').innerText = 'ç·¨è¼¯æ”¯å‡º';
                
                const transaction = transactions.find(t => t.id === transactionId);
                if (transaction) {
                    // Populate fields for editing
                    document.getElementById('input-date').value = formatDate(transaction.date);
                    document.getElementById('input-category').value = transaction.category || (categories[0] ? categories[0].name : '');
                    document.getElementById('input-payment').value = transaction.payment || (paymentMethods[0] ? paymentMethods[0].name : '');
                    document.getElementById('input-note').value = transaction.note || '';
                    
                    // Set calculator display to the existing amount
                    expression = transaction.amount.toString();
                    result = transaction.amount;
                    updateCalcDisplay();
                } else {
                    showAlert("éŒ¯èª¤", "æ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„äº¤æ˜“ç´€éŒ„ã€‚", "red");
                    closeModal();
                }
            } else {
                // New transaction mode
                editMode = false;
                currentEditId = null;
                document.getElementById('modal-title').innerText = 'æ–°å¢æ”¯å‡º';
                
                // Set default selections
                document.getElementById('input-category').value = categories[0] ? categories[0].name : '';
                document.getElementById('input-payment').value = paymentMethods[0] ? paymentMethods[0] : '';
                document.getElementById('input-note').value = '';
            }
        };

        window.closeModal = () => {
            document.getElementById('input-modal').classList.add('hidden');
            document.getElementById('add-btn').classList.remove('hidden');
        };

        window.saveTransaction = async () => {
            // 1. Final evaluation of the expression
            let finalAmount;
            try {
                if (expression.includes('=')) {
                    finalAmount = result;
                } else {
                    finalAmount = eval(expression.replace(/Ã·/g, '/').replace(/Ã—/g, '*'));
                }
                
                if (isNaN(finalAmount) || finalAmount <= 0) {
                     showAlert("è¼¸å…¥éŒ¯èª¤", "è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡ (å¤§æ–¼ $0$ )ã€‚", "orange");
                    return;
                }
                finalAmount = Math.round(finalAmount); // Round to nearest dollar

            } catch (e) {
                showAlert("è¨ˆç®—éŒ¯èª¤", "ç„¡æ³•è¨ˆç®—é‡‘é¡ï¼Œè«‹æª¢æŸ¥è¼¸å…¥ã€‚", "red");
                return;
            }

            // 2. Gather other data
            const dateStr = document.getElementById('input-date').value;
            const category = document.getElementById('input-category').value;
            const payment = document.getElementById('input-payment').value;
            const note = document.getElementById('input-note').value.trim();

            if (!dateStr || !category) {
                showAlert("è³‡æ–™ä¸å®Œæ•´", "æ—¥æœŸèˆ‡åˆ†é¡ç‚ºå¿…å¡«é …ã€‚", "orange");
                return;
            }

            const transactionData = {
                amount: finalAmount,
                date: new Date(dateStr), // Stored as Date object
                category: category,
                payment: payment,
                note: note,
                timestamp: new Date() // For sorting/tracking
            };
            
            closeModal();
            showLoading(true);

            // 3. Save to Firestore
            try {
                if (editMode && currentEditId) {
                    await updateDoc(doc(db, getUserPath(), "data", currentEditId), transactionData);
                    showAlert("æ›´æ–°æˆåŠŸ", "äº¤æ˜“ç´€éŒ„å·²æ›´æ–°ã€‚", "green");
                } else {
                    await addDoc(collection(db, getUserPath(), "data"), transactionData);
                    showAlert("å„²å­˜æˆåŠŸ", "æ–°çš„äº¤æ˜“ç´€éŒ„å·²åŠ å…¥ã€‚", "green");
                }
            } catch (e) {
                console.error("Error saving transaction:", e);
                showAlert("å„²å­˜å¤±æ•—", "ç„¡æ³•å„²å­˜äº¤æ˜“ç´€éŒ„ã€‚", "red");
            } finally {
                showLoading(false);
            }
        };
        
        window.deleteTransaction = async (id) => {
             // Replaced confirm() with prompt() workaround since confirm is forbidden
            if (prompt("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™ç­†äº¤æ˜“ç´€éŒ„å—ï¼Ÿ\n(è¼¸å…¥ 'åˆªé™¤' ç¢ºèª)").toLowerCase() === "åˆªé™¤") {
                showLoading(true);
                try {
                    await deleteDoc(doc(db, getUserPath(), "data", id));
                    showAlert("åˆªé™¤æˆåŠŸ", "äº¤æ˜“ç´€éŒ„å·²ç§»é™¤ã€‚", "green");
                } catch (e) {
                    console.error("Error deleting transaction:", e);
                    showAlert("åˆªé™¤å¤±æ•—", "ç„¡æ³•ç§»é™¤äº¤æ˜“ç´€éŒ„ã€‚", "red");
                } finally {
                    showLoading(false);
                }
            }
        };

        // --- Stats View Logic ---
        window.setStatsMode = (mode) => {
            statsMode = mode;
            document.getElementById('btn-mode-month').classList.remove('bg-white', 'shadow', 'text-blue-600');
            document.getElementById('btn-mode-month').classList.add('text-gray-500');
            document.getElementById('btn-mode-year').classList.remove('bg-white', 'shadow', 'text-blue-600');
            document.getElementById('btn-mode-year').classList.add('text-gray-500');
            
            if (mode === 'month') {
                document.getElementById('btn-mode-month').classList.add('bg-white', 'shadow', 'text-blue-600');
            } else {
                document.getElementById('btn-mode-year').classList.add('bg-white', 'shadow', 'text-blue-600');
            }
            // Reset statsDate to the current period when switching mode
            statsDate = new Date(); 
            renderStats();
        };

        window.shiftStatsDate = (amount) => {
            if (statsMode === 'month') {
                statsDate.setMonth(statsDate.getMonth() + amount);
            } else {
                statsDate.setFullYear(statsDate.getFullYear() + amount);
            }
            renderStats();
        };

        function renderStats() {
            const statsList = document.getElementById('stats-list');
            statsList.innerHTML = '';
            
            // 1. Determine the relevant period and total spending
            let dateLabel, filteredTransactions;
            let totalSpending = 0;

            if (statsMode === 'month') {
                const year = statsDate.getFullYear();
                const month = statsDate.getMonth();
                dateLabel = `${year} å¹´ ${month + 1} æœˆ`;
                
                filteredTransactions = transactions.filter(t => 
                    t.date.getFullYear() === year && t.date.getMonth() === month
                );
            } else { // 'year' mode
                const year = statsDate.getFullYear();
                dateLabel = `${year} å¹´`;
                
                filteredTransactions = transactions.filter(t => 
                    t.date.getFullYear() === year
                );
            }

            document.getElementById('stats-date-label').innerText = dateLabel;
            
            // Group by Category
            const categoryTotals = filteredTransactions.reduce((acc, t) => {
                totalSpending += t.amount;
                acc[t.category] = (acc[t.category] || 0) + t.amount;
                return acc;
            }, {});

            document.getElementById('stats-total').innerText = formatCurrency(totalSpending);

            // Handle no transactions
            if (totalSpending === 0) {
                statsList.innerHTML = `
                    <div class="p-6 text-center text-gray-500 bg-white rounded-xl shadow-sm text-lg">
                        <i class="fa-solid fa-chart-line text-4xl mb-2"></i>
                        <p>æ­¤æœŸé–“æ²’æœ‰æ”¯å‡ºç´€éŒ„</p>
                    </div>
                `;
                return;
            }

            // 2. Render Category Stats
            const categoryNames = Object.keys(categoryTotals).sort((a, b) => categoryTotals[b] - categoryTotals[a]);
            
            categoryNames.forEach(catName => {
                const spending = categoryTotals[catName];
                const percentage = (spending / totalSpending) * 100;
                const catSetting = categories.find(c => c.name === catName) || { budget: 0 };
                const budget = catSetting.budget;
                
                // Budget Bar calculation for Stats View (vs current period budget)
                let budgetPercentage = (budget > 0) ? Math.min(100, (spending / budget) * 100) : 0;
                let barColor = 'bg-blue-500';
                let subTitle = formatCurrency(spending);
                
                if (budget > 0) {
                    subTitle += ` / ${formatCurrency(budget)}`;
                    if (budgetPercentage >= 100) {
                        barColor = 'bg-red-500';
                    } else if (budgetPercentage >= 75) {
                        barColor = 'bg-orange-500';
                    }
                } else {
                    budgetPercentage = (percentage > 0) ? Math.min(100, percentage) : 0;
                    barColor = getCategoryColor(catName).split(' ')[0].replace('-100', '-600');
                }
                
                // Determine bar width
                const barWidth = `${budget > 0 ? budgetPercentage : percentage}%`;

                statsList.innerHTML += `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex flex-col">
                                <span class="font-bold text-xl text-gray-800">${catName}</span>
                                <span class="text-base text-gray-500">${subTitle}</span>
                            </div>
                            <div class="text-right flex flex-col items-end">
                                <span class="text-2xl font-bold text-red-600">${formatCurrency(spending)}</span>
                                <span class="text-sm font-semibold text-gray-500">${percentage.toFixed(1)}%</span>
                            </div>
                        </div>
                        <div class="h-3 w-full bg-gray-200 rounded-full overflow-hidden">
                            <div class="stats-bar h-full rounded-full ${barColor}" style="width: ${barWidth};"></div>
                        </div>
                        <div class="text-sm text-right mt-1 text-gray-500">
                        ${budget > 0 ? (spending > budget ? `è¶…æ”¯ ${formatCurrency(spending - budget)}` : `å‰©é¤˜ ${formatCurrency(budget - spending)}`) : 'æ­¤åˆ†é¡ç„¡é ç®—è¨­å®š'}
                        </div>
                    </div>
                `;
            });
        }

        // --- UI Utility Functions ---

        window.switchView = (view) => {
            const main = document.getElementById('main-view');
            const stats = document.getElementById('stats-view');
            const set = document.getElementById('settings-view');
            const headerTitle = document.getElementById('header-title');
            const addBtn = document.getElementById('add-btn');

            const btnHome = document.getElementById('nav-home');
            const btnStats = document.getElementById('nav-stats');
            const btnSet = document.getElementById('nav-settings');

            // Reset all
            main.classList.add('hidden');
            stats.classList.add('hidden');
            set.classList.add('hidden');
            
            [btnHome, btnStats, btnSet].forEach(btn => {
                btn.classList.remove('text-blue-600');
                btn.classList.add('text-gray-400');
            });

            if (view === 'home') {
                main.classList.remove('hidden');
                headerTitle.innerText = "æœ¬æœˆæ”¯å‡º";
                btnHome.classList.add('text-blue-600'); btnHome.classList.remove('text-gray-400');
                addBtn.classList.remove('hidden');
            } else if (view === 'stats') {
                stats.classList.remove('hidden');
                headerTitle.innerText = "çµ±è¨ˆå ±è¡¨";
                btnStats.classList.add('text-blue-600'); btnStats.classList.remove('text-gray-400');
                addBtn.classList.add('hidden');
                renderStats(); // Ensure fresh render
            } else {
                set.classList.remove('hidden');
                headerTitle.innerText = "è¨­å®š";
                btnSet.classList.add('text-blue-600'); btnSet.classList.remove('text-gray-400');
                addBtn.classList.add('hidden');
            }
        };

        function showLoading(show) {
            if (show) loadingOverlay.classList.remove('hidden');
            else loadingOverlay.classList.add('hidden');
        }

        /**
         * Shows a custom alert modal.
         * @param {string} title - The title of the alert.
         * @param {string} message - The main message.
         * @param {string} type - 'green', 'red', 'orange', or an icon string like 'ğŸš¨'.
         */
        function showAlert(title, message, type = 'orange') {
            const modal = document.getElementById('alert-modal');
            const iconElement = document.getElementById('alert-icon');
            const titleElement = document.getElementById('alert-title');
            const msgElement = document.getElementById('alert-msg');

            let icon = '';
            switch(type) {
                case 'green': icon = 'âœ…'; break;
                case 'red': icon = 'âŒ'; break;
                case 'orange': icon = 'âš ï¸'; break;
                default: icon = type; // Allow passing custom icon like 'ğŸš¨'
            }

            iconElement.innerText = icon;
            titleElement.innerText = title;
            msgElement.innerText = message;
            
            modal.classList.remove('hidden');
        }
    </script>
</body>
</html>

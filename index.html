<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¨˜å¸³å°å¹«æ‰‹</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Zen Maru Gothic -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Change font to Zen Maru Gothic and slightly increase base size for better readability */
        body { 
            font-family: 'Zen Maru Gothic', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            font-size: 17px; /* Increase base font size slightly */
        }
        .calc-btn { transition: background-color 0.1s; }
        .calc-btn:active { background-color: #e5e7eb; }
        /* Hide scrollbar for category list */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Smooth transition for stats bars */
        .stat-bar-fill { transition: width 1s ease-out; }

        /* Custom scrollbar for better look on desktop/tablet */
        /* For WebKit (Chrome, Safari) */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        
        /* Modal backdrop fix for mobile touch */
        .modal-backdrop {
            z-index: 50; 
            background-color: rgba(0, 0, 0, 0.5);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }

        /* Full screen setup for the app container */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 600px; /* Max width for larger screens */
            margin: 0 auto;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        /* Ensure header and footer are fixed and content scrolls */
        .content-area {
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1rem;
        }

        /* Improve button tap feedback on touch devices */
        button:focus:not(:focus-visible) {
            outline: none;
        }

    </style>
</head>
<body class="bg-gray-50">
    <div id="app-container" class="app-container">
        <!-- Header -->
        <header class="bg-white shadow-md p-4 flex justify-between items-center z-10">
            <h1 id="header-title" class="text-2xl font-bold text-gray-800">æœ¬æœˆæ”¯å‡º</h1>
            <button id="add-btn" class="bg-blue-600 hover:bg-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150 ease-in-out transform hover:scale-105">
                <i class="fas fa-plus"></i>
            </button>
        </header>

        <!-- Main Content (Home View) -->
        <main id="main-view" class="content-area space-y-4">
            <!-- Monthly Summary Card -->
            <div class="bg-white rounded-xl shadow-lg p-6 flex justify-between items-center transition duration-300 transform hover:scale-[1.01] hover:shadow-xl">
                <div>
                    <p class="text-sm font-medium text-gray-500">æœ¬æœˆç¸½æ”¯å‡º</p>
                    <p id="total-monthly-expense" class="text-3xl font-extrabold text-blue-600 mt-1">è¼‰å…¥ä¸­...</p>
                </div>
                <div class="text-blue-400 text-4xl">
                    <i class="fas fa-wallet"></i>
                </div>
            </div>
            
            <!-- User ID Display (MANDATORY) -->
            <div class="bg-gray-100 p-3 rounded-lg text-xs text-gray-600 break-words shadow-inner">
                <strong class="font-bold">ç”¨æˆ¶ ID (å¿…å¡«):</strong> <span id="user-id-display">è¼‰å…¥ä¸­...</span>
            </div>

            <!-- Record List -->
            <section class="space-y-3">
                <h2 class="text-lg font-semibold text-gray-700">æœ€è¿‘çš„è¨˜éŒ„</h2>
                <ul id="record-list" class="space-y-3">
                    <!-- Records will be injected here by JavaScript -->
                    <li class="p-4 bg-white rounded-xl shadow text-center text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i>è¼‰å…¥ä¸­...
                    </li>
                </ul>
            </section>
        </main>

        <!-- Stats View -->
        <div id="stats-view" class="content-area space-y-6 hidden">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">æ”¯å‡ºåˆ†é¡çµ±è¨ˆ</h2>
            
            <!-- Filter Options -->
            <div class="flex space-x-2 bg-white p-3 rounded-xl shadow-md">
                <select id="stats-month-select" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700">
                    <!-- Options injected by JS -->
                </select>
                <button id="stats-filter-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">
                    ç¯©é¸
                </button>
            </div>

            <!-- Total Stats Summary -->
            <div class="bg-white rounded-xl shadow-lg p-5">
                <p class="text-lg font-medium text-gray-600">ç¸½æ”¯å‡º</p>
                <p id="stats-total-expense" class="text-3xl font-extrabold text-blue-600 mt-1">--</p>
            </div>

            <!-- Category Breakdown -->
            <section id="stats-category-breakdown" class="space-y-4 bg-white p-5 rounded-xl shadow-lg">
                <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">åˆ†é¡ç™¾åˆ†æ¯”</h3>
                <!-- Stats bars will be injected here -->
                <p id="stats-placeholder" class="text-center text-gray-500">è«‹é¸æ“‡æœˆä»½é€²è¡Œçµ±è¨ˆ</p>
            </section>
        </div>

        <!-- Settings View -->
        <div id="settings-view" class="content-area space-y-6 hidden">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">æ‡‰ç”¨ç¨‹å¼è¨­å®š</h2>
            
            <section class="bg-white p-5 rounded-xl shadow-lg space-y-4">
                <h3 class="text-lg font-semibold text-gray-700">è³‡æ–™ç®¡ç†</h3>
                <p class="text-sm text-gray-600">å°‡æ‰€æœ‰è¨˜éŒ„å¾ Firestore è³‡æ–™åº«ä¸­æ°¸ä¹…åˆªé™¤ã€‚æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
                <button id="delete-all-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-150 transform hover:scale-[1.01]">
                    <i class="fas fa-trash-alt mr-2"></i>åˆªé™¤æ‰€æœ‰è¨˜éŒ„
                </button>
            </section>
            
            <section class="bg-white p-5 rounded-xl shadow-lg space-y-4">
                <h3 class="text-lg font-semibold text-gray-700">é—œæ–¼</h3>
                <p class="text-sm text-gray-600">è¨˜å¸³å°å¹«æ‰‹ v1.0.0</p>
                <p class="text-sm text-gray-600">æ­¤æ‡‰ç”¨ç¨‹å¼æ˜¯ä¸€å€‹å–®æ–‡ä»¶å¯¦æ™‚è¨˜å¸³æ‡‰ç”¨ç¨‹å¼ï¼Œä½¿ç”¨ Firebase Firestore é€²è¡Œæ•¸æ“šå­˜å„²ã€‚</p>
            </section>
        </div>

        <!-- Footer Navigation -->
        <footer class="bg-white border-t border-gray-200 p-2 shadow-inner z-10">
            <div class="flex justify-around">
                <button id="nav-home-btn" class="nav-btn flex flex-col items-center p-2 text-blue-600 hover:text-blue-500 transition duration-150">
                    <i class="fas fa-home text-xl"></i>
                    <span class="text-xs mt-1">é¦–é </span>
                </button>
                <button id="nav-stats-btn" class="nav-btn flex flex-col items-center p-2 text-gray-400 hover:text-blue-500 transition duration-150">
                    <i class="fas fa-chart-pie text-xl"></i>
                    <span class="text-xs mt-1">çµ±è¨ˆ</span>
                </button>
                <button id="nav-set-btn" class="nav-btn flex flex-col items-center p-2 text-gray-400 hover:text-blue-500 transition duration-150">
                    <i class="fas fa-cog text-xl"></i>
                    <span class="text-xs mt-1">è¨­å®š</span>
                </button>
            </div>
        </footer>
    </div>

    <!-- Modal for Adding/Editing Record (The main input form) -->
    <div id="record-modal-backdrop" class="modal-backdrop fixed inset-0 z-40 bg-black bg-opacity-50 flex items-end sm:items-center justify-center transition-opacity duration-300">
        <div id="record-modal" class="bg-white w-full sm:w-11/12 md:w-3/4 lg:w-1/2 rounded-t-xl sm:rounded-xl shadow-2xl transform translate-y-0 transition-transform duration-300 max-h-[90vh] flex flex-col">
            <div class="p-5 border-b flex justify-between items-center">
                <h2 id="modal-title" class="text-xl font-bold text-gray-800">æ–°å¢è¨˜éŒ„</h2>
                <button onclick="closeModal('record-modal-backdrop')" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- Modal Content - Date, Category, Amount, Note -->
            <div class="p-5 overflow-y-auto flex-grow hide-scrollbar">
                <!-- Date Picker -->
                <div class="mb-4">
                    <label for="record-date" class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸèˆ‡æ™‚é–“</label>
                    <input type="datetime-local" id="record-datetime" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700" required>
                </div>

                <!-- Category Selection (Scrollable) -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">é¸æ“‡åˆ†é¡</label>
                    <div id="category-selector" class="flex space-x-3 overflow-x-auto pb-2 hide-scrollbar">
                        <!-- Categories will be injected here -->
                    </div>
                </div>

                <!-- Amount Display and Calculator -->
                <div class="mb-4 bg-gray-100 p-4 rounded-lg shadow-inner">
                    <label class="block text-sm font-medium text-gray-700 mb-1">é‡‘é¡</label>
                    <div class="text-2xl font-extrabold text-gray-800 p-2 bg-white rounded-lg border border-gray-300 text-right shadow-sm" id="amount-display">0</div>
                </div>

                <!-- Note Input -->
                <div class="mb-4">
                    <label for="record-note" class="block text-sm font-medium text-gray-700 mb-1">å‚™è¨» (é¸å¡«)</label>
                    <textarea id="record-note" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700" placeholder="è¼¸å…¥å‚™è¨»..."></textarea>
                </div>
            </div>

            <!-- Calculator and Action Buttons -->
            <div class="p-5 border-t">
                <!-- Calculator Buttons (Simplified) -->
                <div class="grid grid-cols-4 gap-2 mb-4 text-lg font-semibold">
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="7">7</button>
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="8">8</button>
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="9">9</button>
                    <button class="calc-btn bg-blue-100 hover:bg-blue-200 p-3 rounded-lg shadow-md text-blue-600" data-value="backspace"><i class="fas fa-backspace"></i></button>

                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="4">4</button>
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="5">5</button>
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="6">6</button>
                    <button class="calc-btn bg-blue-100 hover:bg-blue-200 p-3 rounded-lg shadow-md text-blue-600" data-value="-">-</button>

                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="1">1</button>
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="2">2</button>
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="3">3</button>
                    <button class="calc-btn bg-blue-100 hover:bg-blue-200 p-3 rounded-lg shadow-md text-blue-600" data-value="+">+</button>
                    
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="clear">C</button>
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="0">0</button>
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value=".">.</button>
                    <button class="calc-btn bg-blue-100 hover:bg-blue-200 p-3 rounded-lg shadow-md text-blue-600" data-value="=">=</button>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex space-x-3">
                    <button id="delete-record-btn" class="w-1/3 bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-150 hidden transform hover:scale-[1.01]" onclick="deleteRecord()">
                        åˆªé™¤
                    </button>
                    <button id="save-record-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md transition duration-150 transform hover:scale-[1.01]">
                        å„²å­˜è¨˜éŒ„
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alert-modal" class="modal-backdrop fixed inset-0 z-40 bg-black bg-opacity-50 flex items-center justify-center transition-opacity duration-300">
        <div class="bg-white w-11/12 sm:w-1/3 rounded-xl shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="p-6 flex flex-col items-center">
                <span id="alert-icon" class="text-4xl mb-3"></span>
                <h3 id="alert-title" class="text-xl font-bold text-gray-800 mb-3 text-center"></h3>
                <p id="alert-msg" class="text-gray-600 mb-5 text-center text-base"></p>
                <button onclick="document.getElementById('alert-modal').classList.add('hidden')" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg transition duration-150 shadow-md">
                    äº†è§£
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal-backdrop" class="modal-backdrop fixed inset-0 z-40 bg-black bg-opacity-50 flex items-center justify-center transition-opacity duration-300">
        <div id="confirm-modal" class="bg-white w-11/12 sm:w-1/3 rounded-xl shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="p-6">
                <h3 id="confirm-title" class="text-xl font-bold text-gray-800 mb-3">ç¢ºèªæ“ä½œ</h3>
                <p id="confirm-message" class="text-gray-600 mb-5 text-base">æ‚¨ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
                <div class="flex justify-end space-x-3">
                    <button id="confirm-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150">
                        å–æ¶ˆ
                    </button>
                    <button id="confirm-ok-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                        ç¢ºå®š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i>
            <p class="mt-3 text-gray-700">è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <!-- Script Block -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            getDocs, 
            setDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            orderBy, 
            serverTimestamp,
            writeBatch 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level
        setLogLevel('debug'); 

        // --- Global Variables and Constants ---
        let app;
        let db;
        let auth;
        let userId = null;
        let recordsRef;

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-bookkeeping-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let currentRecords = [];
        let currentEditingId = null;
        let currentCalculatorInput = '0';
        let currentSelectedCategory = null;

        const CATEGORIES = [
            { id: 'food', name: 'é¤é£²', icon: 'fas fa-utensils', color: 'bg-green-500' },
            { id: 'transport', name: 'äº¤é€š', icon: 'fas fa-bus', color: 'bg-red-500' },
            { id: 'shopping', name: 'è³¼ç‰©', icon: 'fas fa-shopping-bag', color: 'bg-yellow-500' },
            { id: 'entertainment', name: 'å¨›æ¨‚', icon: 'fas fa-film', color: 'bg-purple-500' },
            { id: 'housing', name: 'ä½æˆ¿', icon: 'fas fa-home', color: 'bg-blue-500' },
            { id: 'utilities', name: 'é›œè²»', icon: 'fas fa-lightbulb', color: 'bg-orange-500' },
            { id: 'medical', name: 'é†«ç™‚', icon: 'fas fa-heartbeat', color: 'bg-pink-500' },
            { id: 'other', name: 'å…¶ä»–', icon: 'fas fa-ellipsis-h', color: 'bg-gray-500' },
        ];

        // --- DOM Elements ---
        const headerTitle = document.getElementById('header-title');
        const main = document.getElementById('main-view');
        const stats = document.getElementById('stats-view');
        const set = document.getElementById('settings-view');
        const addBtn = document.getElementById('add-btn');
        const totalMonthlyExpense = document.getElementById('total-monthly-expense');
        const recordList = document.getElementById('record-list');
        const userIdDisplay = document.getElementById('user-id-display');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // Modal Elements
        const recordModalBackdrop = document.getElementById('record-modal-backdrop');
        const recordModal = document.getElementById('record-modal');
        const amountDisplay = document.getElementById('amount-display');
        const categorySelector = document.getElementById('category-selector');
        const recordNote = document.getElementById('record-note');
        const recordDateTime = document.getElementById('record-datetime');
        const saveRecordBtn = document.getElementById('save-record-btn');
        const deleteRecordBtn = document.getElementById('delete-record-btn');
        const modalTitle = document.getElementById('modal-title');
        
        // Navigation Buttons
        const btnHome = document.getElementById('nav-home-btn');
        const btnStats = document.getElementById('nav-stats-btn');
        const btnSet = document.getElementById('nav-set-btn');

        // Stats Elements
        const statsMonthSelect = document.getElementById('stats-month-select');
        const statsFilterBtn = document.getElementById('stats-filter-btn');
        const statsTotalExpense = document.getElementById('stats-total-expense');
        const statsCategoryBreakdown = document.getElementById('stats-category-breakdown');
        const statsPlaceholder = document.getElementById('stats-placeholder');

        // Confirmation/Alert Modal Elements
        const alertModal = document.getElementById('alert-modal');
        const alertIcon = document.getElementById('alert-icon');
        const alertTitle = document.getElementById('alert-title');
        const alertMsg = document.getElementById('alert-msg');

        const confirmModalBackdrop = document.getElementById('confirm-modal-backdrop');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        
        // --- Utility Functions ---

        /**
         * Formats the amount as currency (TWD).
         * @param {number} amount 
         * @returns {string}
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: 'TWD',
                minimumFractionDigits: 0
            }).format(amount);
        }

        /**
         * Formats timestamp to a locale-specific date and time string (YYYY/MM/DD HH:MM).
         * @param {number|object} timestamp - Milliseconds or Firebase Timestamp object.
         * @returns {string} Formatted date/time string.
         */
        function formatTimestamp(timestamp) {
            const date = timestamp?.toDate ? timestamp.toDate() : new Date(timestamp);
            // Use 'zh-TW' locale to include year, month, day, hour, and minute
            const options = {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit',
                hour12: false // Use 24-hour format
            };
            // Replace slashes with dashes (optional, to match YYYY-MM-DD) and remove the comma.
            // Note: Firebase security rules are easier to manage when only timestamp is stored.
            return date.toLocaleString('zh-TW', options).replace(/\//g, '-').replace(',', '');
        }

        /**
         * Shows a custom alert modal.
         * @param {string} title - The title of the alert.
         * @param {string} message - The main message.
         * @param {string} type - 'green', 'red', 'orange', or an icon string like 'ğŸš¨'.
         */
        function showAlert(title, message, type = 'orange') {
            let icon = '';
            switch(type) {
                case 'green': icon = 'âœ…'; break;
                case 'red': icon = 'âŒ'; break;
                case 'orange': icon = 'âš ï¸'; break;
                default: icon = type; // Allow passing custom icon like 'ğŸš¨'
            }

            alertIcon.innerText = icon;
            alertTitle.innerText = title;
            alertMsg.innerText = message;
            
            alertModal.classList.remove('hidden');
        }

        /**
         * Shows a custom confirmation modal.
         * @param {string} title - The title.
         * @param {string} message - The message.
         * @param {function} onConfirm - Function to execute on confirm.
         */
        function showConfirmModal(title, message, onConfirm) {
            confirmTitle.innerText = title;
            confirmMessage.innerText = message;
            
            // Clone and replace to remove old listeners
            const newOkBtn = confirmOkBtn.cloneNode(true);
            confirmOkBtn.parentNode.replaceChild(newOkBtn, confirmOkBtn);
            
            const newCancelBtn = confirmCancelBtn.cloneNode(true);
            confirmCancelBtn.parentNode.replaceChild(newCancelBtn, confirmCancelBtn);

            // Set new listeners
            newOkBtn.addEventListener('click', () => {
                closeModal('confirm-modal-backdrop');
                onConfirm();
            });
            newCancelBtn.addEventListener('click', () => {
                closeModal('confirm-modal-backdrop');
            });

            confirmModalBackdrop.classList.remove('hidden');
        }

        /**
         * Formats a Date object to the string format required by <input type="datetime-local"> (YYYY-MM-DDTHH:MM).
         * @param {Date} date 
         * @returns {string} YYYY-MM-DDTHH:MM
         */
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        /**
         * Parses the <input type="datetime-local"> string into a local Date object.
         * @param {string} datetimeLocalString 
         * @returns {Date}
         */
        function parseDateTimeLocal(datetimeLocalString) {
            if (!datetimeLocalString) return new Date();
            // datetime-local format is YYYY-MM-DDTHH:MM
            const [datePart, timePart] = datetimeLocalString.split('T');
            const [year, month, day] = datePart.split('-').map(Number);
            const [hours, minutes] = timePart.split(':').map(Number);
            
            // Construct as local time
            return new Date(year, month - 1, day, hours, minutes);
        }


        // --- View Controller ---
        
        /**
         * Switches the application view (Home, Stats, Settings).
         * @param {string} view 
         */
        const navigateTo = (view) => {
            // Get all navigation buttons
            const navBtns = document.querySelectorAll('.nav-btn');

            // Reset all views
            main.classList.add('hidden');
            stats.classList.add('hidden');
            set.classList.add('hidden');
            
            // Reset all button styles
            navBtns.forEach(btn => {
                btn.classList.remove('text-blue-600');
                btn.classList.add('text-gray-400');
            });

            if (view === 'home') {
                main.classList.remove('hidden');
                headerTitle.innerText = "æœ¬æœˆæ”¯å‡º";
                btnHome.classList.add('text-blue-600'); btnHome.classList.remove('text-gray-400');
                addBtn.classList.remove('hidden');
            } else if (view === 'stats') {
                stats.classList.remove('hidden');
                headerTitle.innerText = "çµ±è¨ˆå ±è¡¨";
                btnStats.classList.add('text-blue-600'); btnStats.classList.remove('text-gray-400');
                addBtn.classList.add('hidden');
                renderStats(); // Ensure fresh render
            } else {
                set.classList.remove('hidden');
                headerTitle.innerText = "è¨­å®š";
                btnSet.classList.add('text-blue-600'); btnSet.classList.remove('text-gray-400');
                addBtn.classList.add('hidden');
            }
        };

        function showLoading(show) {
            if (show) loadingOverlay.classList.remove('hidden');
            else loadingOverlay.classList.add('hidden');
        }
        
        /**
         * Opens a Modal.
         * @param {string} backdropId 
         */
        window.openModal = (backdropId) => {
            const backdrop = document.getElementById(backdropId);
            if (backdrop) {
                backdrop.classList.remove('hidden');
            }
        };
        
        /**
         * Closes a Modal.
         * @param {string} backdropId 
         */
        window.closeModal = (backdropId) => {
            const backdrop = document.getElementById(backdropId);
            if (backdrop) {
                backdrop.classList.add('hidden');
            }
        };

        // --- Firebase/Auth/Init ---

        /**
         * Initializes Firebase and authentication.
         */
        async function initialize() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing.");
                showAlert("åˆå§‹åŒ–å¤±æ•—", "Firebase é…ç½®éºå¤±ã€‚è«‹è¯ç¹«ç®¡ç†å“¡ã€‚", 'red');
                showLoading(false);
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Attempt to sign in with custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Set up auth state change listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.innerText = userId;
                        // Set Firestore reference path: /artifacts/{appId}/users/{userId}/records
                        recordsRef = collection(db, `artifacts/${appId}/users/${userId}/records`);
                        
                        // Start main data listener
                        setupRealtimeListener();
                        
                        // Initialize stats options
                        initializeStatsMonths();
                    } else {
                        // User logged out or could not sign in
                        userId = null;
                        userIdDisplay.innerText = 'æœªç™»å…¥';
                        showLoading(false);
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                userIdDisplay.innerText = `éŒ¯èª¤: ${error.code}`;
                showAlert("ç™»å…¥å¤±æ•—", `Firebase ç™»å…¥å¤±æ•—: ${error.code}`, 'red');
                showLoading(false);
            }
        }

        // --- Record Operations (CRUD) ---

        /**
         * Sets up the Firestore real-time listener.
         */
        function setupRealtimeListener() {
            if (!recordsRef) return;
            
            // Query for the current month's records, ordered by timestamp (descending)
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            
            const q = query(
                recordsRef,
                where('timestamp', '>=', startOfMonth),
                orderBy('timestamp', 'desc') 
            );

            onSnapshot(q, (snapshot) => {
                showLoading(true);
                currentRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRecords(currentRecords);
                updateMonthlySummary(currentRecords);
                showLoading(false);
            }, (error) => {
                console.error("Realtime listener failed:", error);
                showAlert("è³‡æ–™é€£ç·šéŒ¯èª¤", "ç„¡æ³•è¼‰å…¥å³æ™‚è¨˜å¸³è³‡æ–™ã€‚", 'red');
                showLoading(false);
            });
        }

        /**
         * Renders the list of records.
         * @param {Array} records 
         */
        function renderRecords(records) {
            recordList.innerHTML = '';
            if (records.length === 0) {
                recordList.innerHTML = '<li class="p-4 bg-white rounded-xl shadow text-center text-gray-500"><i class="fas fa-box-open mr-2"></i>æœ¬æœˆç„¡è¨˜éŒ„</li>';
                return;
            }

            records.forEach(record => {
                const category = CATEGORIES.find(c => c.id === record.category) || CATEGORIES.find(c => c.id === 'other');
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-4 bg-white rounded-xl shadow-lg mb-3 transition duration-150 ease-in-out hover:bg-gray-50';
                
                li.innerHTML = `
                    <div class="flex items-center space-x-4 min-w-0">
                        <!-- Icon -->
                        <div class="p-3 ${category.color} text-white rounded-full shadow-md flex-shrink-0">
                            <i class="${category.icon} text-lg"></i>
                        </div>
                        <!-- Details -->
                        <div class="min-w-0">
                            <p class="font-medium text-gray-800 truncate">${category.name}</p>
                            <p class="text-sm text-gray-500 truncate">${record.note || 'ç„¡å‚™è¨»'}</p>
                            <!-- Time: Displays full date and time (YYYY/MM/DD HH:MM) -->
                            <p class="text-xs text-gray-400">${formatTimestamp(record.timestamp)}</p>
                        </div>
                    </div>
                    <!-- Amount and Edit Button -->
                    <div class="flex items-center space-x-2 flex-shrink-0">
                        <!-- Amount Color: Using neutral dark gray (text-gray-800) -->
                        <span class="text-xl font-semibold text-gray-800">
                            ${formatCurrency(record.amount)}
                        </span>
                        <button onclick="editRecord('${record.id}')" class="text-gray-400 hover:text-blue-600 p-2 rounded-full transition duration-150">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                `;
                recordList.appendChild(li);
            });
        }

        /**
         * Updates the total monthly expense summary.
         * @param {Array} records 
         */
        function updateMonthlySummary(records) {
            const total = records.reduce((sum, record) => sum + (record.amount || 0), 0);
            totalMonthlyExpense.innerText = formatCurrency(total);
        }

        /**
         * Handles saving of a new or edited record.
         */
        async function saveRecord() {
            if (!recordsRef) {
                console.error("Records reference not set. Authentication incomplete.");
                showAlert("æ“ä½œå¤±æ•—", "èº«ä»½é©—è­‰å°šæœªå®Œæˆï¼Œè«‹ç¨å€™å†è©¦ã€‚", 'orange');
                return;
            }

            const amount = parseFloat(amountDisplay.innerText);
            const categoryId = currentSelectedCategory;
            const note = recordNote.value.trim();
            const datetimeLocal = recordDateTime.value;
            
            // Convert datetime-local string to Date object
            const recordDate = parseDateTimeLocal(datetimeLocal);
            const timestamp = recordDate; 

            if (amount <= 0 || !categoryId) {
                showAlert("è¼¸å…¥éŒ¯èª¤", "è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡ä¸¦é¸æ“‡ä¸€å€‹åˆ†é¡ã€‚", 'orange');
                return;
            }

            showLoading(true);
            try {
                const recordData = {
                    amount: amount,
                    category: categoryId,
                    note: note,
                    timestamp: timestamp 
                };

                if (currentEditingId) {
                    // Edit existing record
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/records`, currentEditingId);
                    await setDoc(docRef, recordData); 
                    showAlert("å„²å­˜æˆåŠŸ", "è¨˜éŒ„å·²æ›´æ–°ã€‚", 'green');
                } else {
                    // Add new record
                    await addDoc(recordsRef, { ...recordData, createdAt: serverTimestamp() });
                    showAlert("æ–°å¢æˆåŠŸ", "æ–°çš„è¨˜å¸³è¨˜éŒ„å·²å„²å­˜ã€‚", 'green');
                }

                closeModal('record-modal-backdrop');
                resetRecordModal();
            } catch (error) {
                console.error("Error saving record:", error);
                showAlert("å„²å­˜å¤±æ•—", "ä¿å­˜è¨˜éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤ã€‚", 'red');
            } finally {
                showLoading(false);
            }
        }

        /**
         * Deletes the currently editing record.
         */
        window.deleteRecord = () => {
            if (!currentEditingId || !userId) return;

            showConfirmModal(
                'ç¢ºèªåˆªé™¤',
                'æ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤ç­†è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚',
                async () => {
                    showLoading(true);
                    try {
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/records`, currentEditingId);
                        await deleteDoc(docRef);
                        
                        closeModal('record-modal-backdrop');
                        resetRecordModal();
                        showAlert("åˆªé™¤æˆåŠŸ", "è¨˜éŒ„å·²åˆªé™¤ã€‚", 'green');
                    } catch (error) {
                        console.error("Error deleting record:", error);
                        showAlert("åˆªé™¤å¤±æ•—", "åˆªé™¤è¨˜éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤ã€‚", 'red');
                    } finally {
                        showLoading(false);
                    }
                }
            );
        };

        /**
         * Loads the selected record into the Modal for editing.
         * @param {string} recordId 
         */
        window.editRecord = (recordId) => {
            const record = currentRecords.find(r => r.id === recordId);
            if (!record) return;

            currentEditingId = recordId;
            modalTitle.innerText = 'ç·¨è¼¯è¨˜éŒ„';
            deleteRecordBtn.classList.remove('hidden');

            // Set amount
            currentCalculatorInput = String(record.amount);
            amountDisplay.innerText = currentCalculatorInput;

            // Set category
            selectCategory(record.category);

            // Set note
            recordNote.value = record.note || '';

            // Set datetime
            const dateToEdit = record.timestamp?.toDate ? record.timestamp.toDate() : new Date(record.timestamp);
            recordDateTime.value = formatDateTimeLocal(dateToEdit);

            openModal('record-modal-backdrop');
        };

        /**
         * Resets the Record Modal state.
         */
        function resetRecordModal() {
            currentEditingId = null;
            modalTitle.innerText = 'æ–°å¢è¨˜éŒ„';
            deleteRecordBtn.classList.add('hidden');
            currentCalculatorInput = '0';
            amountDisplay.innerText = '0';
            recordNote.value = '';
            
            // Default date to current time
            recordDateTime.value = formatDateTimeLocal(new Date());
            
            currentSelectedCategory = null;
            
            // Reset category selection
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-blue-300', 'border-blue-600');
            });

            // Default select the first category
            selectCategory(CATEGORIES[0].id);
        }

        // --- Category Selector ---

        /**
         * Renders the category selector buttons.
         */
        function renderCategorySelector() {
            categorySelector.innerHTML = CATEGORIES.map(cat => `
                <button 
                    class="category-btn flex flex-col items-center p-3 rounded-xl transition duration-150 ease-in-out border-2 border-transparent hover:border-blue-300 flex-shrink-0"
                    data-category-id="${cat.id}"
                >
                    <div class="p-3 ${cat.color} text-white rounded-full shadow-md">
                        <i class="${cat.icon} text-xl"></i>
                    </div>
                    <span class="text-xs mt-1 text-gray-700">${cat.name}</span>
                </button>
            `).join('');

            // Add event listeners
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    selectCategory(e.currentTarget.dataset.categoryId);
                });
            });

            // Default select the first one
            selectCategory(CATEGORIES[0].id);
        }

        /**
         * Selects a category and updates the UI.
         * @param {string} categoryId 
         */
        function selectCategory(categoryId) {
            currentSelectedCategory = categoryId;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-blue-300', 'border-blue-600');
                if (btn.dataset.categoryId === categoryId) {
                    btn.classList.add('ring-4', 'ring-blue-300', 'border-blue-600');
                }
            });
        }

        // --- Calculator Logic ---

        /**
         * Handles calculator button input.
         * @param {string} value 
         */
        function handleCalculatorInput(value) {
            const current = currentCalculatorInput;

            if (value === 'clear') {
                currentCalculatorInput = '0';
            } else if (value === 'backspace') {
                if (current.length > 1) {
                    currentCalculatorInput = current.slice(0, -1);
                } else {
                    currentCalculatorInput = '0';
                }
            } else if (value === '=') {
                try {
                    // Safety check before eval
                    const safeExpression = current.replace(/[^-()\d/*+.]/g, ''); 
                    const result = eval(safeExpression);
                    if (isFinite(result)) {
                        // Limit to 2 decimal places and convert back to string
                        currentCalculatorInput = String(parseFloat(result.toFixed(2)));
                    } else {
                        currentCalculatorInput = '0';
                    }
                } catch (e) {
                    currentCalculatorInput = '0';
                }
            } else if (value === '.') {
                const parts = current.split(/[\+\-\*\/]/);
                const lastPart = parts[parts.length - 1];
                if (!lastPart.includes('.')) {
                    if (['+', '-', '*', '/'].includes(current.slice(-1))) {
                        currentCalculatorInput += '0.';
                    } else {
                        currentCalculatorInput += '.';
                    }
                }
            } else if (['+', '-', '*', '/'].includes(value)) {
                // Replace trailing operator
                if (['+', '-', '*', '/'].includes(current.slice(-1))) {
                    currentCalculatorInput = current.slice(0, -1) + value;
                } else {
                    currentCalculatorInput += value;
                }
            } else {
                // Number input
                if (current === '0' || current === String(eval(current))) {
                    currentCalculatorInput = value;
                } else {
                    currentCalculatorInput += value;
                }
            }
            
            // Update display
            amountDisplay.innerText = currentCalculatorInput;
        }

        // Add calculator button event listeners
        document.querySelectorAll('.calc-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const value = e.currentTarget.dataset.value;
                handleCalculatorInput(value);
            });
        });

        // --- Stats Logic ---

        /**
         * Initializes the stats month selector dropdown.
         */
        function initializeStatsMonths() {
            statsMonthSelect.innerHTML = '';
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            // Generate options for the last 12 months
            for (let i = 0; i < 12; i++) {
                const date = new Date(currentYear, currentMonth - i, 1);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const value = `${year}-${String(month).padStart(2, '0')}`;
                const text = `${year}å¹´${month}æœˆ`;
                
                const option = document.createElement('option');
                option.value = value;
                option.innerText = text;
                
                if (i === 0) {
                    option.selected = true; // Default select current month
                }
                statsMonthSelect.appendChild(option);
            }
        }

        /**
         * Executes stats calculation and rendering for the selected month.
         */
        async function renderStats() {
            if (!recordsRef) return;

            statsCategoryBreakdown.innerHTML = '';
            statsPlaceholder.classList.remove('hidden');
            statsTotalExpense.innerText = formatCurrency(0);

            const selectedMonth = statsMonthSelect.value;
            if (!selectedMonth) return;

            const [year, month] = selectedMonth.split('-').map(Number);
            
            const startOfMonth = new Date(year, month - 1, 1);
            const endOfMonth = new Date(year, month, 1); // Next month start is the end of this month
            
            // Query for records within the selected month range
            const q = query(
                recordsRef,
                where('timestamp', '>=', startOfMonth),
                where('timestamp', '<', endOfMonth),
                orderBy('timestamp', 'desc') // Needed if combining with range filters
            );
            
            showLoading(true);
            try {
                const snapshot = await getDocs(q);
                const monthRecords = snapshot.docs.map(doc => doc.data());

                if (monthRecords.length === 0) {
                    statsPlaceholder.innerText = `${year}å¹´${month}æœˆç„¡æ”¯å‡ºè¨˜éŒ„ã€‚`;
                    statsPlaceholder.classList.remove('hidden');
                    return;
                }

                statsPlaceholder.classList.add('hidden');
                
                // 1. Calculate total expense
                const totalExpense = monthRecords.reduce((sum, record) => sum + (record.amount || 0), 0);
                statsTotalExpense.innerText = formatCurrency(totalExpense);

                // 2. Group by category and sum
                const categoryTotals = monthRecords.reduce((acc, record) => {
                    const catId = record.category || 'other';
                    acc[catId] = (acc[catId] || 0) + (record.amount || 0);
                    return acc;
                }, {});

                // 3. Render stats bars
                const sortedCategories = Object.entries(categoryTotals)
                    .sort(([, a], [, b]) => b - a); // Sort by amount descending

                const categoryHtml = sortedCategories.map(([catId, amount]) => {
                    const category = CATEGORIES.find(c => c.id === catId) || CATEGORIES.find(c => c.id === 'other');
                    const percentage = totalExpense > 0 ? ((amount / totalExpense) * 100).toFixed(1) : 0;
                    
                    // Get the Tailwind color class and transform it for the text color
                    const textColorClass = category.color.replace('bg-', 'text-');

                    return `
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm font-medium text-gray-800">
                                <span><i class="${category.icon} mr-2 text-base ${textColorClass}"></i>${category.name}</span>
                                <span>${percentage}% (${formatCurrency(amount)})</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="stat-bar-fill h-3 rounded-full ${category.color}" style="width: ${percentage}%;"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                statsCategoryBreakdown.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">åˆ†é¡ç™¾åˆ†æ¯”</h3>
                    <div class="space-y-4 pt-2">${categoryHtml}</div>
                `;

            } catch (error) {
                console.error("Error rendering stats:", error);
                showAlert("çµ±è¨ˆéŒ¯èª¤", "è¼‰å…¥çµ±è¨ˆæ•¸æ“šå¤±æ•—ã€‚", 'red');
            } finally {
                showLoading(false);
            }
        }

        // --- Settings Logic ---

        /**
         * Handles deleting all records.
         */
        document.getElementById('delete-all-btn').addEventListener('click', () => {
            if (!userId) {
                showAlert("æ“ä½œå¤±æ•—", "èº«ä»½é©—è­‰å°šæœªå®Œæˆã€‚", 'orange');
                return;
            }

            showConfirmModal(
                'æ°¸ä¹…åˆªé™¤æ‰€æœ‰è¨˜éŒ„',
                'æ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ‰€æœ‰æ­·å²è¨˜å¸³è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œè«‹è¬¹æ…æ“ä½œã€‚',
                async () => {
                    showLoading(true);
                    try {
                        const q = query(recordsRef);
                        const snapshot = await getDocs(q);
                        
                        if (snapshot.empty) {
                            showAlert("æ“ä½œå®Œæˆ", "æ²’æœ‰è¨˜éŒ„å¯åˆªé™¤ã€‚", 'green');
                            showLoading(false);
                            return;
                        }

                        // Use batch writing for efficient deletion
                        const batch = writeBatch(db);
                        snapshot.docs.forEach((doc) => {
                            batch.delete(doc.ref);
                        });

                        await batch.commit();
                        showAlert("åˆªé™¤æˆåŠŸ", "æ‰€æœ‰è¨˜éŒ„å·²æˆåŠŸåˆªé™¤ã€‚", 'green');
                        navigateTo('home'); // Go back to home view
                    } catch (error) {
                        console.error("Error deleting all records:", error);
                        showAlert("åˆªé™¤å¤±æ•—", "åˆªé™¤æ‰€æœ‰è¨˜éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤ã€‚", 'red');
                    } finally {
                        showLoading(false);
                    }
                }
            );
        });

        // --- Event Listeners ---
        
        // Navigation
        btnHome.addEventListener('click', () => navigateTo('home'));
        btnStats.addEventListener('click', () => navigateTo('stats'));
        btnSet.addEventListener('click', () => navigateTo('set'));

        // Add Button
        addBtn.addEventListener('click', () => {
            resetRecordModal();
            openModal('record-modal-backdrop');
        });

        // Save Button
        saveRecordBtn.addEventListener('click', saveRecord);

        // Stats Filter Button
        statsFilterBtn.addEventListener('click', renderStats);

        // --- Initialization on Load ---
        window.onload = () => {
            showLoading(true);
            initialize();
            renderCategorySelector(); // Render category selector buttons
            // Default date to current time
            recordDateTime.value = formatDateTimeLocal(new Date()); 
        };

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>記帳小幫手</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Zen Maru Gothic -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Change font to Zen Maru Gothic */
        body { font-family: 'Zen Maru Gothic', sans-serif; -webkit-tap-highlight-color: transparent; }
        .calc-btn { transition: background-color 0.1s; }
        .calc-btn:active { background-color: #e5e7eb; }
        /* Hide scrollbar for category list */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Smooth transition for stats bars */
        .stat-bar-fill { transition: width 1s ease-out; }

        /* Custom scrollbar for better look on desktop/tablet */
        /* For WebKit (Chrome, Safari) */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        
        /* Modal backdrop fix for mobile touch */
        .modal-backdrop {
            z-index: 50; /* Ensure it's below the modal (z-50) */
            background-color: rgba(0, 0, 0, 0.5);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }

        /* Full screen setup for the app container */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 600px; /* Max width for larger screens */
            margin: 0 auto;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        /* Ensure header and footer are fixed and content scrolls */
        .content-area {
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app-container" class="app-container">
        <!-- Header -->
        <header class="bg-white shadow-md p-4 flex justify-between items-center z-10">
            <h1 id="header-title" class="text-2xl font-bold text-gray-800">本月支出</h1>
            <button id="add-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150 ease-in-out">
                <i class="fas fa-plus"></i>
            </button>
        </header>

        <!-- Main Content (Home View) -->
        <main id="main-view" class="content-area p-4 space-y-4">
            <!-- Monthly Summary Card -->
            <div class="bg-white rounded-xl shadow-lg p-6 flex justify-between items-center transition duration-300 transform hover:scale-[1.01] hover:shadow-xl">
                <div>
                    <p class="text-sm font-medium text-gray-500">本月總支出</p>
                    <p id="total-monthly-expense" class="text-3xl font-extrabold text-blue-600 mt-1">載入中...</p>
                </div>
                <div class="text-blue-400 text-4xl">
                    <i class="fas fa-wallet"></i>
                </div>
            </div>
            
            <!-- User ID Display (MANDATORY) -->
            <div class="bg-gray-100 p-3 rounded-lg text-xs text-gray-600 break-words shadow-inner">
                <strong class="font-bold">用戶 ID (必填):</strong> <span id="user-id-display">載入中...</span>
            </div>

            <!-- Record List -->
            <section class="space-y-3">
                <h2 class="text-lg font-semibold text-gray-700">最近的記錄</h2>
                <ul id="record-list" class="space-y-3">
                    <!-- Records will be injected here by JavaScript -->
                    <li class="p-4 bg-white rounded-xl shadow text-center text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i>載入中...
                    </li>
                </ul>
            </section>
        </main>

        <!-- Stats View -->
        <div id="stats-view" class="content-area p-4 space-y-6 hidden">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">支出分類統計</h2>
            
            <!-- Filter Options -->
            <div class="flex space-x-2 bg-white p-3 rounded-xl shadow-sm">
                <select id="stats-month-select" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700">
                    <!-- Options injected by JS -->
                </select>
                <button id="stats-filter-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                    篩選
                </button>
            </div>

            <!-- Total Stats Summary -->
            <div class="bg-white rounded-xl shadow-lg p-5">
                <p class="text-lg font-medium text-gray-600">總支出</p>
                <p id="stats-total-expense" class="text-3xl font-extrabold text-blue-600 mt-1">--</p>
            </div>

            <!-- Category Breakdown -->
            <section id="stats-category-breakdown" class="space-y-4 bg-white p-5 rounded-xl shadow-lg">
                <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">分類百分比</h3>
                <!-- Stats bars will be injected here -->
                <p id="stats-placeholder" class="text-center text-gray-500">請選擇月份進行統計</p>
            </section>
        </div>

        <!-- Settings View -->
        <div id="settings-view" class="content-area p-4 space-y-6 hidden">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">應用程式設定</h2>
            
            <section class="bg-white p-5 rounded-xl shadow-lg space-y-4">
                <h3 class="text-lg font-semibold text-gray-700">資料管理</h3>
                <p class="text-sm text-gray-600">將所有記錄從 Firestore 資料庫中永久刪除。此操作無法復原。</p>
                <button id="delete-all-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-150">
                    <i class="fas fa-trash-alt mr-2"></i>刪除所有記錄
                </button>
            </section>
            
            <section class="bg-white p-5 rounded-xl shadow-lg space-y-4">
                <h3 class="text-lg font-semibold text-gray-700">關於</h3>
                <p class="text-sm text-gray-600">記帳小幫手 v1.0.0</p>
                <p class="text-sm text-gray-600">此應用程式是一個單文件實時記帳應用程式，使用 Firebase Firestore 進行數據存儲。</p>
            </section>
        </div>

        <!-- Footer Navigation -->
        <footer class="bg-white border-t border-gray-200 p-2 shadow-inner z-10">
            <div class="flex justify-around">
                <button id="nav-home-btn" class="nav-btn flex flex-col items-center p-2 text-blue-600">
                    <i class="fas fa-home text-xl"></i>
                    <span class="text-xs mt-1">首頁</span>
                </button>
                <button id="nav-stats-btn" class="nav-btn flex flex-col items-center p-2 text-gray-400 hover:text-blue-500 transition duration-150">
                    <i class="fas fa-chart-pie text-xl"></i>
                    <span class="text-xs mt-1">統計</span>
                </button>
                <button id="nav-set-btn" class="nav-btn flex flex-col items-center p-2 text-gray-400 hover:text-blue-500 transition duration-150">
                    <i class="fas fa-cog text-xl"></i>
                    <span class="text-xs mt-1">設定</span>
                </button>
            </div>
        </footer>
    </div>

    <!-- Modal for Adding/Editing Record (The main input form) -->
    <div id="record-modal-backdrop" class="modal-backdrop hidden fixed inset-0 z-40 bg-black bg-opacity-50 flex items-end sm:items-center justify-center transition-opacity duration-300">
        <div id="record-modal" class="bg-white w-full sm:w-11/12 md:w-3/4 lg:w-1/2 rounded-t-xl sm:rounded-xl shadow-2xl transform translate-y-0 transition-transform duration-300 max-h-[90vh] flex flex-col">
            <div class="p-5 border-b flex justify-between items-center">
                <h2 id="modal-title" class="text-xl font-bold text-gray-800">新增記錄</h2>
                <button onclick="closeModal('record-modal-backdrop')" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- Modal Content - Date, Category, Amount, Note -->
            <div class="p-5 overflow-y-auto flex-grow hide-scrollbar">
                <!-- Date Picker -->
                <div class="mb-4">
                    <label for="record-date" class="block text-sm font-medium text-gray-700 mb-1">日期與時間</label>
                    <input type="datetime-local" id="record-datetime" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700" required>
                </div>

                <!-- Category Selection (Scrollable) -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">選擇分類</label>
                    <div id="category-selector" class="flex space-x-3 overflow-x-auto pb-2 hide-scrollbar">
                        <!-- Categories will be injected here -->
                    </div>
                </div>

                <!-- Amount Display and Calculator -->
                <div class="mb-4 bg-gray-100 p-4 rounded-lg shadow-inner">
                    <label class="block text-sm font-medium text-gray-700 mb-1">金額</label>
                    <div class="text-2xl font-extrabold text-blue-600 p-2 bg-white rounded-lg border border-gray-300 text-right shadow-sm" id="amount-display">0</div>
                </div>

                <!-- Note Input -->
                <div class="mb-4">
                    <label for="record-note" class="block text-sm font-medium text-gray-700 mb-1">備註 (選填)</label>
                    <textarea id="record-note" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700" placeholder="輸入備註..."></textarea>
                </div>
            </div>

            <!-- Calculator and Action Buttons -->
            <div class="p-5 border-t">
                <!-- Calculator Buttons (Simplified) -->
                <div class="grid grid-cols-4 gap-2 mb-4 text-lg font-semibold">
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="7">7</button>
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="8">8</button>
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="9">9</button>
                    <button class="calc-btn bg-blue-100 hover:bg-blue-200 p-3 rounded-lg shadow-md text-blue-600" data-value="backspace"><i class="fas fa-backspace"></i></button>

                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="4">4</button>
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="5">5</button>
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="6">6</button>
                    <button class="calc-btn bg-blue-100 hover:bg-blue-200 p-3 rounded-lg shadow-md text-blue-600" data-value="-">-</button>

                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="1">1</button>
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="2">2</button>
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="3">3</button>
                    <button class="calc-btn bg-blue-100 hover:bg-blue-200 p-3 rounded-lg shadow-md text-blue-600" data-value="+">+</button>
                    
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="clear">C</button>
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value="0">0</button>
                    <button class="calc-btn bg-white hover:bg-gray-200 p-3 rounded-lg shadow-md" data-value=".">.</button>
                    <button class="calc-btn bg-blue-100 hover:bg-blue-200 p-3 rounded-lg shadow-md text-blue-600" data-value="=">=</button>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex space-x-3">
                    <button id="delete-record-btn" class="w-1/3 bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-150 hidden" onclick="deleteRecord()">
                        刪除
                    </button>
                    <button id="save-record-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md transition duration-150">
                        儲存記錄
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation/Alert Modal -->
    <div id="confirm-modal-backdrop" class="modal-backdrop hidden fixed inset-0 z-40 bg-black bg-opacity-50 flex items-center justify-center transition-opacity duration-300">
        <div id="confirm-modal" class="bg-white w-11/12 sm:w-1/3 rounded-xl shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="p-6">
                <h3 id="confirm-title" class="text-xl font-bold text-gray-800 mb-3">確認操作</h3>
                <p id="confirm-message" class="text-gray-600 mb-5">您確定要執行此操作嗎？</p>
                <div class="flex justify-end space-x-3">
                    <button id="confirm-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150">
                        取消
                    </button>
                    <button id="confirm-ok-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                        確定
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i>
            <p class="mt-3 text-gray-700">載入中...</p>
        </div>
    </div>

    <!-- Script Block -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            setDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            orderBy, 
            serverTimestamp,
            writeBatch 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level
        setLogLevel('debug'); 

        // --- Global Variables and Constants ---
        let app;
        let db;
        let auth;
        let userId = null;
        let recordsRef;

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-bookkeeping-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let currentRecords = [];
        let currentEditingId = null;
        let currentCalculatorInput = '0';
        let currentSelectedCategory = null;

        const CATEGORIES = [
            { id: 'food', name: '餐飲', icon: 'fas fa-utensils', color: 'bg-green-500' },
            { id: 'transport', name: '交通', icon: 'fas fa-bus', color: 'bg-red-500' },
            { id: 'shopping', name: '購物', icon: 'fas fa-shopping-bag', color: 'bg-yellow-500' },
            { id: 'entertainment', name: '娛樂', icon: 'fas fa-film', color: 'bg-purple-500' },
            { id: 'housing', name: '住房', icon: 'fas fa-home', color: 'bg-blue-500' },
            { id: 'utilities', name: '雜費', icon: 'fas fa-lightbulb', color: 'bg-orange-500' },
            { id: 'medical', name: '醫療', icon: 'fas fa-heartbeat', color: 'bg-pink-500' },
            { id: 'other', name: '其他', icon: 'fas fa-ellipsis-h', color: 'bg-gray-500' },
        ];

        // --- DOM Elements ---
        const headerTitle = document.getElementById('header-title');
        const main = document.getElementById('main-view');
        const stats = document.getElementById('stats-view');
        const set = document.getElementById('settings-view');
        const addBtn = document.getElementById('add-btn');
        const totalMonthlyExpense = document.getElementById('total-monthly-expense');
        const recordList = document.getElementById('record-list');
        const userIdDisplay = document.getElementById('user-id-display');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // Modal Elements
        const recordModalBackdrop = document.getElementById('record-modal-backdrop');
        const recordModal = document.getElementById('record-modal');
        const amountDisplay = document.getElementById('amount-display');
        const categorySelector = document.getElementById('category-selector');
        const recordNote = document.getElementById('record-note');
        const recordDateTime = document.getElementById('record-datetime');
        const saveRecordBtn = document.getElementById('save-record-btn');
        const deleteRecordBtn = document.getElementById('delete-record-btn');
        const modalTitle = document.getElementById('modal-title');
        
        // Navigation Buttons
        const btnHome = document.getElementById('nav-home-btn');
        const btnStats = document.getElementById('nav-stats-btn');
        const btnSet = document.getElementById('nav-set-btn');

        // Stats Elements
        const statsMonthSelect = document.getElementById('stats-month-select');
        const statsFilterBtn = document.getElementById('stats-filter-btn');
        const statsTotalExpense = document.getElementById('stats-total-expense');
        const statsCategoryBreakdown = document.getElementById('stats-category-breakdown');
        const statsPlaceholder = document.getElementById('stats-placeholder');

        // Confirmation Modal Elements
        const confirmModalBackdrop = document.getElementById('confirm-modal-backdrop');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        
        // --- Utility Functions ---

        /**
         * 格式化金額為貨幣顯示
         * @param {number} amount 
         * @returns {string}
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: 'TWD',
                minimumFractionDigits: 0
            }).format(amount);
        }

        /**
         * 格式化時間戳記為日期和時間
         * @param {number|object} timestamp - 毫秒數或 Firebase Timestamp 物件
         * @returns {string} 格式化的日期時間字串 (YYYY-MM-DD HH:MM)
         */
        function formatTimestamp(timestamp) {
            const date = timestamp?.toDate ? timestamp.toDate() : new Date(timestamp);
            // 使用 'zh-TW' 區域設定並包含小時/分鐘
            const options = {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit',
                hour12: false // 使用 24 小時制
            };
            // 替換斜線為破折號，並移除逗號，確保格式一致 (e.g., 2023-11-25 18:00)
            return date.toLocaleString('zh-TW', options).replace(/\//g, '-').replace(',', '');
        }

        /**
         * 顯示自定義確認視窗
         * @param {string} title 標題
         * @param {string} message 訊息
         * @param {function} onConfirm 確認時執行的函數
         */
        function showConfirmModal(title, message, onConfirm) {
            confirmTitle.innerText = title;
            confirmMessage.innerText = message;
            
            // 清除舊的事件監聽器
            const newOkBtn = confirmOkBtn.cloneNode(true);
            confirmOkBtn.parentNode.replaceChild(newOkBtn, confirmOkBtn);
            
            const newCancelBtn = confirmCancelBtn.cloneNode(true);
            confirmCancelBtn.parentNode.replaceChild(newCancelBtn, confirmCancelBtn);

            // 設置新的事件監聽器
            newOkBtn.addEventListener('click', () => {
                closeModal('confirm-modal-backdrop');
                onConfirm();
            });
            newCancelBtn.addEventListener('click', () => {
                closeModal('confirm-modal-backdrop');
            });

            confirmModalBackdrop.classList.remove('hidden');
        }

        /**
         * 格式化Date物件為 <input type="datetime-local"> 所需的字串格式
         * @param {Date} date 
         * @returns {string} YYYY-MM-DDTHH:MM
         */
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        /**
         * 解析 <input type="datetime-local"> 字串為 Date 物件
         * @param {string} datetimeLocalString 
         * @returns {Date}
         */
        function parseDateTimeLocal(datetimeLocalString) {
            if (!datetimeLocalString) return new Date();
            // datetime-local 格式為 YYYY-MM-DDTHH:MM
            // 由於 new Date() 帶有 T 會被解釋為 UTC，我們將其視為本地時間
            const [datePart, timePart] = datetimeLocalString.split('T');
            const [year, month, day] = datePart.split('-').map(Number);
            const [hours, minutes] = timePart.split(':').map(Number);
            
            // 構造為本地時間
            return new Date(year, month - 1, day, hours, minutes);
        }

        // --- View Controller ---
        
        /**
         * 切換應用程式視圖 (Home, Stats, Settings)
         * @param {string} view 
         */
        const navigateTo = (view) => {
            // Get all navigation buttons
            const [btnHome, btnStats, btnSet] = document.querySelectorAll('.nav-btn');

            // Reset all views
            main.classList.add('hidden');
            stats.classList.add('hidden');
            set.classList.add('hidden');
            
            // Reset all button styles
            [btnHome, btnStats, btnSet].forEach(btn => {
                btn.classList.remove('text-blue-600');
                btn.classList.add('text-gray-400');
            });

            if (view === 'home') {
                main.classList.remove('hidden');
                headerTitle.innerText = "本月支出";
                btnHome.classList.add('text-blue-600'); btnHome.classList.remove('text-gray-400');
                addBtn.classList.remove('hidden');
            } else if (view === 'stats') {
                stats.classList.remove('hidden');
                headerTitle.innerText = "統計報表";
                btnStats.classList.add('text-blue-600'); btnStats.classList.remove('text-gray-400');
                addBtn.classList.add('hidden');
                renderStats(); // Ensure fresh render
            } else {
                set.classList.remove('hidden');
                headerTitle.innerText = "設定";
                btnSet.classList.add('text-blue-600'); btnSet.classList.remove('text-gray-400');
                addBtn.classList.add('hidden');
            }
        };

        function showLoading(show) {
            if (show) loadingOverlay.classList.remove('hidden');
            else loadingOverlay.classList.add('hidden');
        }
        
        /**
         * 開啟一個 Modal
         * @param {string} backdropId 
         */
        window.openModal = (backdropId) => {
            const backdrop = document.getElementById(backdropId);
            if (backdrop) {
                backdrop.classList.remove('hidden');
                // Optional: add a class for smooth transition if needed
            }
        };
        
        /**
         * 關閉一個 Modal
         * @param {string} backdropId 
         */
        window.closeModal = (backdropId) => {
            const backdrop = document.getElementById(backdropId);
            if (backdrop) {
                backdrop.classList.add('hidden');
                // Optional: remove transition class
            }
        };

        // --- Firebase/Auth/Init ---

        /**
         * 初始化 Firebase 和身份驗證
         */
        async function initialize() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing.");
                // Fallback UI or message could be added here
                showLoading(false);
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 嘗試使用自定義 token 登入
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // 如果沒有 token，則匿名登入
                    await signInAnonymously(auth);
                }

                // 設置身份驗證狀態變更監聽器
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.innerText = userId;
                        // 設定 Firestore 參考路徑： /artifacts/{appId}/users/{userId}/records
                        recordsRef = collection(db, `artifacts/${appId}/users/${userId}/records`);
                        
                        // 啟動主數據監聽
                        setupRealtimeListener();
                        
                        // 初始化統計選項
                        initializeStatsMonths();
                    } else {
                        // 用戶已登出或無法登入
                        userId = null;
                        userIdDisplay.innerText = '未登入';
                        showLoading(false);
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                userIdDisplay.innerText = `錯誤: ${error.code}`;
                showLoading(false);
            }
        }

        // --- Record Operations (CRUD) ---

        /**
         * 設定 Firestore 實時監聽器
         */
        function setupRealtimeListener() {
            if (!recordsRef) return;
            
            // 查詢本月記錄，並按時間倒序排列
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            
            const q = query(
                recordsRef,
                where('timestamp', '>=', startOfMonth),
                orderBy('timestamp', 'desc') // 使用 'desc' 確保最新的記錄在最上面
            );

            onSnapshot(q, (snapshot) => {
                showLoading(true);
                currentRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRecords(currentRecords);
                updateMonthlySummary(currentRecords);
                showLoading(false);
            }, (error) => {
                console.error("Realtime listener failed:", error);
                showLoading(false);
            });
        }

        /**
         * 渲染記錄列表
         * @param {Array} records 
         */
        function renderRecords(records) {
            recordList.innerHTML = '';
            if (records.length === 0) {
                recordList.innerHTML = '<li class="p-4 bg-white rounded-xl shadow text-center text-gray-500"><i class="fas fa-box-open mr-2"></i>本月無記錄</li>';
                return;
            }

            records.forEach(record => {
                const category = CATEGORIES.find(c => c.id === record.category) || CATEGORIES.find(c => c.id === 'other');
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-4 bg-white rounded-xl shadow-lg mb-3 transition duration-150 ease-in-out hover:bg-gray-50';
                
                li.innerHTML = `
                    <div class="flex items-center space-x-4 min-w-0">
                        <!-- Icon -->
                        <div class="p-3 ${category.color} text-white rounded-full shadow-md flex-shrink-0">
                            <i class="${category.icon} text-lg"></i>
                        </div>
                        <!-- Details -->
                        <div class="min-w-0">
                            <p class="font-medium text-gray-800 truncate">${category.name}</p>
                            <p class="text-sm text-gray-500 truncate">${record.note || '無備註'}</p>
                            <!-- Time Fix: 使用 formatTimestamp 顯示完整的日期和時間 -->
                            <p class="text-xs text-gray-400">${formatTimestamp(record.timestamp)}</p>
                        </div>
                    </div>
                    <!-- Amount and Edit Button -->
                    <div class="flex items-center space-x-2 flex-shrink-0">
                        <!-- Color Fix: 將 text-red-600 改為 text-gray-800 -->
                        <span class="text-xl font-semibold text-gray-800">
                            ${formatCurrency(record.amount)}
                        </span>
                        <button onclick="editRecord('${record.id}')" class="text-gray-400 hover:text-blue-600 p-2 rounded-full transition duration-150">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                `;
                recordList.appendChild(li);
            });
        }

        /**
         * 更新本月支出總結
         * @param {Array} records 
         */
        function updateMonthlySummary(records) {
            const total = records.reduce((sum, record) => sum + (record.amount || 0), 0);
            totalMonthlyExpense.innerText = formatCurrency(total);
        }

        /**
         * 處理新增/編輯記錄的保存
         */
        async function saveRecord() {
            if (!recordsRef) {
                console.error("Records reference not set. Authentication incomplete.");
                alert("錯誤：身份驗證尚未完成，請稍候再試。"); // Custom alert needed
                return;
            }

            const amount = parseFloat(amountDisplay.innerText);
            const categoryId = currentSelectedCategory;
            const note = recordNote.value.trim();
            const datetimeLocal = recordDateTime.value;
            
            // 將 datetime-local 字串轉換為 Date 物件，然後轉換為 Firebase Timestamp
            const recordDate = parseDateTimeLocal(datetimeLocal);
            const timestamp = recordDate; // Firestore will handle Date to Timestamp conversion

            if (amount <= 0 || !categoryId) {
                alert("錯誤：請輸入有效金額並選擇一個分類。"); // Custom alert needed
                return;
            }

            showLoading(true);
            try {
                const recordData = {
                    amount: amount,
                    category: categoryId,
                    note: note,
                    timestamp: timestamp // 使用轉換後的 Date 物件
                };

                if (currentEditingId) {
                    // 編輯現有記錄
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/records`, currentEditingId);
                    await setDoc(docRef, recordData); // setDoc replaces the entire document
                } else {
                    // 新增記錄
                    await addDoc(recordsRef, { ...recordData, createdAt: serverTimestamp() });
                }

                closeModal('record-modal-backdrop');
                resetRecordModal();
            } catch (error) {
                console.error("Error saving record:", error);
                alert("保存記錄失敗，請檢查控制台。"); // Custom alert needed
            } finally {
                showLoading(false);
            }
        }

        /**
         * 刪除當前編輯的記錄
         */
        window.deleteRecord = () => {
            if (!currentEditingId || !userId) return;

            showConfirmModal(
                '確認刪除',
                '您確定要永久刪除此筆記錄嗎？此操作無法復原。',
                async () => {
                    showLoading(true);
                    try {
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/records`, currentEditingId);
                        await deleteDoc(docRef);
                        
                        closeModal('record-modal-backdrop');
                        resetRecordModal();
                    } catch (error) {
                        console.error("Error deleting record:", error);
                        alert("刪除記錄失敗，請檢查控制台。"); // Custom alert needed
                    } finally {
                        showLoading(false);
                    }
                }
            );
        };

        /**
         * 載入選定的記錄到 Modal 中進行編輯
         * @param {string} recordId 
         */
        window.editRecord = (recordId) => {
            const record = currentRecords.find(r => r.id === recordId);
            if (!record) return;

            currentEditingId = recordId;
            modalTitle.innerText = '編輯記錄';
            deleteRecordBtn.classList.remove('hidden');

            // 設置金額
            currentCalculatorInput = String(record.amount);
            amountDisplay.innerText = currentCalculatorInput;

            // 設置分類
            selectCategory(record.category);

            // 設置備註
            recordNote.value = record.note || '';

            // 設置日期時間
            const dateToEdit = record.timestamp?.toDate ? record.timestamp.toDate() : new Date(record.timestamp);
            recordDateTime.value = formatDateTimeLocal(dateToEdit);

            openModal('record-modal-backdrop');
        };

        /**
         * 重設記錄 Modal 狀態
         */
        function resetRecordModal() {
            currentEditingId = null;
            modalTitle.innerText = '新增記錄';
            deleteRecordBtn.classList.add('hidden');
            currentCalculatorInput = '0';
            amountDisplay.innerText = '0';
            recordNote.value = '';
            // 預設日期為當前時間
            recordDateTime.value = formatDateTimeLocal(new Date());
            currentSelectedCategory = null;
            
            // 取消所有分類的選中狀態
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-blue-300');
            });

            // 預設選中第一個分類
            selectCategory(CATEGORIES[0].id);
        }

        // --- Category Selector ---

        /**
         * 渲染分類選擇器
         */
        function renderCategorySelector() {
            categorySelector.innerHTML = CATEGORIES.map(cat => `
                <button 
                    class="category-btn flex flex-col items-center p-3 rounded-xl transition duration-150 ease-in-out border-2 border-transparent hover:border-blue-300 flex-shrink-0"
                    data-category-id="${cat.id}"
                >
                    <div class="p-3 ${cat.color} text-white rounded-full shadow-md">
                        <i class="${cat.icon} text-xl"></i>
                    </div>
                    <span class="text-xs mt-1 text-gray-700">${cat.name}</span>
                </button>
            `).join('');

            // 添加事件監聽器
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    selectCategory(e.currentTarget.dataset.categoryId);
                });
            });

            // 預設選中第一個
            selectCategory(CATEGORIES[0].id);
        }

        /**
         * 選中一個分類
         * @param {string} categoryId 
         */
        function selectCategory(categoryId) {
            currentSelectedCategory = categoryId;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-blue-300', 'border-blue-600');
                if (btn.dataset.categoryId === categoryId) {
                    btn.classList.add('ring-4', 'ring-blue-300', 'border-blue-600');
                }
            });
        }

        // --- Calculator Logic ---

        /**
         * 處理計算器按鈕點擊
         * @param {string} value 
         */
        function handleCalculatorInput(value) {
            const current = currentCalculatorInput;

            if (value === 'clear') {
                currentCalculatorInput = '0';
            } else if (value === 'backspace') {
                if (current.length > 1) {
                    currentCalculatorInput = current.slice(0, -1);
                } else {
                    currentCalculatorInput = '0';
                }
            } else if (value === '=') {
                try {
                    // 使用 eval 進行計算，但確保只包含數字和基本的運算符號
                    const result = eval(current.replace(/[^-()\d/*+.]/g, ''));
                    if (isFinite(result)) {
                        currentCalculatorInput = String(parseFloat(result.toFixed(2)));
                    } else {
                        currentCalculatorInput = '0';
                    }
                } catch (e) {
                    currentCalculatorInput = '0';
                }
            } else if (value === '.') {
                // 檢查最後一個數字部分是否已經包含小數點
                const parts = current.split(/[\+\-\*\/]/);
                const lastPart = parts[parts.length - 1];
                if (!lastPart.includes('.')) {
                    // 避免在運算符後直接加小數點
                    if (['+', '-', '*', '/'].includes(current.slice(-1))) {
                        currentCalculatorInput += '0.';
                    } else {
                        currentCalculatorInput += '.';
                    }
                }
            } else if (['+', '-', '*', '/'].includes(value)) {
                // 替換結尾的運算符
                if (['+', '-', '*', '/'].includes(current.slice(-1))) {
                    currentCalculatorInput = current.slice(0, -1) + value;
                } else {
                    currentCalculatorInput += value;
                }
            } else {
                // 數字輸入
                if (current === '0' || current === '0.00' || current === String(eval(current)) ) {
                    currentCalculatorInput = value;
                } else {
                    currentCalculatorInput += value;
                }
            }
            
            // 更新顯示
            amountDisplay.innerText = currentCalculatorInput;
        }

        // 添加計算器按鈕事件監聽器
        document.querySelectorAll('.calc-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const value = e.currentTarget.dataset.value;
                handleCalculatorInput(value);
            });
        });

        // --- Stats Logic ---

        /**
         * 初始化統計月份選擇器
         */
        function initializeStatsMonths() {
            statsMonthSelect.innerHTML = '';
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            // 產生過去 12 個月的選項
            for (let i = 0; i < 12; i++) {
                const date = new Date(currentYear, currentMonth - i, 1);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const value = `${year}-${String(month).padStart(2, '0')}`;
                const text = `${year}年${month}月`;
                
                const option = document.createElement('option');
                option.value = value;
                option.innerText = text;
                
                if (i === 0) {
                    option.selected = true; // 預設選中當前月份
                }
                statsMonthSelect.appendChild(option);
            }
        }

        /**
         * 執行統計和渲染
         */
        async function renderStats() {
            if (!recordsRef) return;

            statsCategoryBreakdown.innerHTML = '';
            statsPlaceholder.classList.remove('hidden');
            statsTotalExpense.innerText = formatCurrency(0);

            const selectedMonth = statsMonthSelect.value;
            if (!selectedMonth) return;

            const [year, month] = selectedMonth.split('-').map(Number);
            
            const startOfMonth = new Date(year, month - 1, 1);
            const endOfMonth = new Date(year, month, 1); // Next month start is the end of this month
            
            // 查詢選定月份的記錄
            const q = query(
                recordsRef,
                where('timestamp', '>=', startOfMonth),
                where('timestamp', '<', endOfMonth),
                orderBy('timestamp', 'desc')
            );
            
            showLoading(true);
            try {
                const snapshot = await getDocs(q);
                const monthRecords = snapshot.docs.map(doc => doc.data());

                if (monthRecords.length === 0) {
                    statsPlaceholder.innerText = `${year}年${month}月無支出記錄。`;
                    statsPlaceholder.classList.remove('hidden');
                    return;
                }

                statsPlaceholder.classList.add('hidden');
                
                // 1. 計算總支出
                const totalExpense = monthRecords.reduce((sum, record) => sum + (record.amount || 0), 0);
                statsTotalExpense.innerText = formatCurrency(totalExpense);

                // 2. 按類別分組和求和
                const categoryTotals = monthRecords.reduce((acc, record) => {
                    const catId = record.category || 'other';
                    acc[catId] = (acc[catId] || 0) + (record.amount || 0);
                    return acc;
                }, {});

                // 3. 渲染統計條
                const sortedCategories = Object.entries(categoryTotals)
                    .sort(([, a], [, b]) => b - a); // 按金額降序排列

                const categoryHtml = sortedCategories.map(([catId, amount]) => {
                    const category = CATEGORIES.find(c => c.id === catId) || CATEGORIES.find(c => c.id === 'other');
                    const percentage = totalExpense > 0 ? ((amount / totalExpense) * 100).toFixed(1) : 0;
                    
                    return `
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm font-medium text-gray-800">
                                <span><i class="${category.icon} mr-2 text-base" style="color:${category.color.replace('bg-', 'text-')};"></i>${category.name}</span>
                                <span>${percentage}% (${formatCurrency(amount)})</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="stat-bar-fill h-3 rounded-full ${category.color}" style="width: ${percentage}%;"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                statsCategoryBreakdown.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">分類百分比</h3>
                    <div class="space-y-4">${categoryHtml}</div>
                `;

            } catch (error) {
                console.error("Error rendering stats:", error);
                statsPlaceholder.innerText = '載入統計數據失敗。';
            } finally {
                showLoading(false);
            }
        }

        // --- Settings Logic ---

        /**
         * 處理刪除所有記錄
         */
        document.getElementById('delete-all-btn').addEventListener('click', () => {
            if (!userId) {
                alert("錯誤：身份驗證尚未完成。"); // Custom alert needed
                return;
            }

            showConfirmModal(
                '永久刪除所有記錄',
                '您確定要永久刪除所有歷史記帳記錄嗎？此操作無法復原，請謹慎操作。',
                async () => {
                    showLoading(true);
                    try {
                        const q = query(recordsRef);
                        const snapshot = await getDocs(q);
                        
                        if (snapshot.empty) {
                            alert("沒有記錄可刪除。"); // Custom alert needed
                            showLoading(false);
                            return;
                        }

                        // 使用批次寫入進行高效刪除
                        const batch = writeBatch(db);
                        snapshot.docs.forEach((doc) => {
                            batch.delete(doc.ref);
                        });

                        await batch.commit();
                        alert("所有記錄已成功刪除。"); // Custom alert needed
                        navigateTo('home'); // 返回首頁
                    } catch (error) {
                        console.error("Error deleting all records:", error);
                        alert("刪除所有記錄失敗，請檢查控制台。"); // Custom alert needed
                    } finally {
                        showLoading(false);
                    }
                }
            );
        });

        // --- Event Listeners ---
        
        // Navigation
        btnHome.addEventListener('click', () => navigateTo('home'));
        btnStats.addEventListener('click', () => navigateTo('stats'));
        btnSet.addEventListener('click', () => navigateTo('set'));

        // Add Button
        addBtn.addEventListener('click', () => {
            resetRecordModal();
            openModal('record-modal-backdrop');
        });

        // Save Button
        saveRecordBtn.addEventListener('click', saveRecord);

        // Stats Filter Button
        statsFilterBtn.addEventListener('click', renderStats);

        // --- Initialization on Load ---
        window.onload = () => {
            showLoading(true);
            initialize();
            renderCategorySelector(); // 渲染分類選擇器
            // 預設將日期時間輸入框設為當前時間
            recordDateTime.value = formatDateTimeLocal(new Date()); 
        };

    </script>
</body>
</html>
